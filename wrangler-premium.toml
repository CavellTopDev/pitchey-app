name = "pitchey-api-prod"
main = "src/worker-integrated.ts"
compatibility_date = "2024-01-01"
account_id = "002bd5c0e90ae753a387c60546cf6869"

# Routes - commented out due to subdomain restrictions
# routes = [
#   { pattern = "pitchey-api-prod.ndlovucavelle.workers.dev/*", zone_name = "" }
# ]

# Enable workers.dev route
workers_dev = true

# Durable Objects for WebSockets
[[durable_objects.bindings]]
name = "NOTIFICATION_HUB"
class_name = "NotificationHub"
script_name = "pitchey-api-prod"

[[durable_objects.bindings]]
name = "WEBSOCKET_ROOMS"
class_name = "WebSocketRoom"
script_name = "pitchey-api-prod"

# Migration for Durable Objects
[[migrations]]
tag = "v3"
new_classes = ["NotificationHub", "WebSocketRoom"]

# KV Namespaces
[[kv_namespaces]]
binding = "CACHE"
id = "5e9e940dc8af4f159f1bd027f3687dd3"

[[kv_namespaces]]
binding = "SESSION_STORE"
id = "776ca67365654698bbf0ac5cd7eca749"

# R2 Storage
[[r2_buckets]]
binding = "PITCH_STORAGE"
bucket_name = "pitchey-storage"

[[r2_buckets]]
binding = "NDA_STORAGE"
bucket_name = "pitchey-ndas"

# Queues - Producer only (consumer will be added when handler is implemented)
[[queues.producers]]
binding = "NOTIFICATION_QUEUE"
queue = "pitchey-notifications"

# Consumer configuration (commented out until handler is implemented)
# [[queues.consumers]]
# queue = "pitchey-notifications"
# max_batch_size = 100
# max_batch_timeout = 30

# Cron Triggers
[triggers]
crons = [
  "*/5 * * * *",    # Check NDA expirations every 5 minutes
  "0 * * * *"       # Send hourly digest emails
]

# Environment Variables
[vars]
FRONTEND_URL = "https://pitchey-5o8-66n.pages.dev"
BACKEND_URL = "https://pitchey-api-prod.ndlovucavelle.workers.dev"
DENO_ENV = "production"
NODE_ENV = "production"
ENABLE_DURABLE_OBJECTS = "true"
ENABLE_WEBSOCKETS = "true"
ENABLE_QUEUES = "true"
MAX_WEBSOCKET_CONNECTIONS = "10000"
CACHE_TTL = "300"

# Compatibility flags
compatibility_flags = ["nodejs_compat", "experimental"]

# Build configuration
[build]
command = "npm run build"