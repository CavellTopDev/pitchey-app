name = "pitchey-api-prod"
main = "src/worker-integrated.ts"
compatibility_date = "2024-01-01"
account_id = "02967e39e44b6266e7873829e94849f5"

# Custom domain routing
routes = [
  { pattern = "pitchey-api-prod.ndlovucavelle.workers.dev/*", custom_domain = true }
]

# ===== PREMIUM FEATURES (WORKERS PAID PLAN) =====

# 1. Durable Objects for WebSocket Management
[[durable_objects.bindings]]
name = "NOTIFICATION_HUB"
class_name = "NotificationHub"

[[durable_objects.bindings]]
name = "WEBSOCKET_ROOMS"
class_name = "WebSocketRoom"

[[migrations]]
tag = "v2"
new_classes = ["NotificationHub", "WebSocketRoom"]

# 2. KV Namespaces for Caching (Unlimited operations)
[[kv_namespaces]]
binding = "CACHE"
id = "cache_namespace_id"

[[kv_namespaces]]
binding = "SESSION_STORE"
id = "session_namespace_id"

[[kv_namespaces]]
binding = "RATE_LIMITER"
id = "rate_limiter_id"

# 3. R2 Storage for Files
[[r2_buckets]]
binding = "PITCH_STORAGE"
bucket_name = "pitchey-pitches"

[[r2_buckets]]
binding = "NDA_STORAGE"
bucket_name = "pitchey-ndas"

# 4. Queues for Background Processing
[[queues.producers]]
binding = "EMAIL_QUEUE"
queue = "email-notifications"

[[queues.producers]]
binding = "AUDIT_QUEUE"
queue = "audit-logs"

[[queues.consumers]]
queue = "email-notifications"
max_batch_size = 100
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "email-dlq"

[[queues.consumers]]
queue = "audit-logs"
max_batch_size = 50
max_batch_timeout = 10

# 5. Analytics Engine for Metrics
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "pitchey_metrics"

# 6. Cron Triggers for Scheduled Tasks
[triggers]
crons = [
  "*/5 * * * *",    # Every 5 min: Check NDA expirations
  "0 * * * *",      # Hourly: Send digest emails
  "0 0 * * *",      # Daily: Export audit logs
  "0 2 * * 0",      # Weekly: Database cleanup
  "*/15 * * * *"    # Every 15 min: Update trending algorithm
]

# Environment Variables
[vars]
FRONTEND_URL = "https://pitchey-5o8-66n.pages.dev"
BACKEND_URL = "https://pitchey-api-prod.ndlovucavelle.workers.dev"
ENVIRONMENT = "production"
ENABLE_DURABLE_OBJECTS = "true"
ENABLE_WEBSOCKETS = "true"
ENABLE_QUEUES = "true"
ENABLE_ANALYTICS = "true"
MAX_WEBSOCKET_CONNECTIONS = "100000"
CACHE_TTL = "300"

# Compatibility flags for advanced features
compatibility_flags = ["nodejs_compat", "experimental"]

[build]
command = "npm run build"
[build.upload]
format = "service-worker"
