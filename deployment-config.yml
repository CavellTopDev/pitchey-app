# Advanced Deployment Configuration for Pitchey Platform
# This file defines comprehensive deployment automation settings

version: "1.0"
metadata:
  name: pitchey-deployment-config
  description: "Advanced CI/CD configuration for zero-downtime deployments"
  lastUpdated: "2024-12-13"

# Global deployment settings
global:
  # Deployment strategy options: blue-green, rolling, canary, immediate
  defaultStrategy: "blue-green"
  
  # Health check configuration
  healthCheck:
    enabled: true
    timeout: 300  # seconds
    retries: 5
    interval: 30  # seconds
    endpoints:
      - path: "/api/health"
        expectedStatus: 200
        timeout: 10
      - path: "/api/auth/validate-token"
        expectedStatus: [401, 405]  # Expected for unauthenticated requests
        timeout: 5
  
  # Rollback configuration
  rollback:
    enabled: true
    automaticOnFailure: true
    preserveVersions: 5
    timeout: 600  # seconds
  
  # Monitoring and alerting
  monitoring:
    enabled: true
    errorRateThreshold: 5  # percentage
    latencyThreshold: 2000  # milliseconds
    uptimeThreshold: 99.9  # percentage
    
  # Security settings
  security:
    requireApprovals: true
    allowedDeployers: ["github-actions", "devops-team"]
    secretValidation: true
    vulnerabilityScanning: true

# Environment-specific configurations
environments:
  production:
    deployment:
      strategy: "blue-green"
      approvalRequired: true
      autoPromote: false
      trafficShift:
        initialPercentage: 10
        incrementPercentage: 25
        intervalMinutes: 15
        
    infrastructure:
      regions: ["us-east", "us-west", "eu-west"]
      cloudflare:
        worker:
          name: "pitchey-production"
          script: "src/worker-production-db.ts"
          routes:
            - pattern: "pitchey-api-prod.ndlovucavelle.workers.dev/*"
            - pattern: "api.pitchey.com/*"
          resources:
            memory: "256MB"
            cpuTime: "100ms"
        pages:
          project: "pitchey"
          branch: "main"
          customDomains: ["pitchey.com", "www.pitchey.com"]
          
    monitoring:
      alerting:
        channels: ["slack", "email", "pagerduty"]
        escalation:
          level1: ["devops-team"]
          level2: ["engineering-lead"]
          level3: ["cto"]
      
      healthCheck:
        frequency: "30s"
        timeout: "10s"
        failureThreshold: 3
        
    security:
      contentSecurityPolicy: true
      rateLimiting: true
      ddosProtection: true
      secretsRotation: "monthly"

  staging:
    deployment:
      strategy: "rolling"
      approvalRequired: false
      autoPromote: true
      
    infrastructure:
      regions: ["us-east"]
      cloudflare:
        worker:
          name: "pitchey-staging"
          script: "src/worker-production-db.ts"
          routes:
            - pattern: "pitchey-staging.ndlovucavelle.workers.dev/*"
          resources:
            memory: "128MB"
            cpuTime: "50ms"
        pages:
          project: "pitchey-staging"
          branch: "staging"
          
    monitoring:
      alerting:
        channels: ["slack"]
        escalation:
          level1: ["devops-team"]
      
      healthCheck:
        frequency: "60s"
        timeout: "15s"
        failureThreshold: 5
        
    security:
      contentSecurityPolicy: false
      rateLimiting: false
      ddosProtection: false
      secretsRotation: "quarterly"

  development:
    deployment:
      strategy: "immediate"
      approvalRequired: false
      autoPromote: true
      
    infrastructure:
      regions: ["us-east"]
      cloudflare:
        worker:
          name: "pitchey-dev"
          script: "src/worker-production-db.ts"
          routes:
            - pattern: "pitchey-dev.ndlovucavelle.workers.dev/*"
          resources:
            memory: "64MB"
            cpuTime: "25ms"
        pages:
          project: "pitchey-dev"
          branch: "develop"
          
    monitoring:
      alerting:
        channels: ["slack"]
        escalation:
          level1: ["development-team"]
      
      healthCheck:
        frequency: "120s"
        timeout: "30s"
        failureThreshold: 10
        
    security:
      contentSecurityPolicy: false
      rateLimiting: false
      ddosProtection: false
      secretsRotation: "yearly"

# Deployment strategies detailed configuration
strategies:
  blue-green:
    description: "Zero-downtime deployment with full environment swap"
    phases:
      - name: "validate"
        actions: ["lint", "test", "security-scan"]
        timeoutMinutes: 30
        
      - name: "deploy-inactive"
        actions: ["deploy-to-inactive-slot"]
        timeoutMinutes: 15
        
      - name: "smoke-test"
        actions: ["health-check", "integration-test"]
        timeoutMinutes: 10
        
      - name: "traffic-shift"
        actions: ["gradual-traffic-shift"]
        timeoutMinutes: 30
        
      - name: "validate-shift"
        actions: ["monitor-metrics", "validate-performance"]
        timeoutMinutes: 15
        
      - name: "full-cutover"
        actions: ["complete-traffic-shift", "cleanup-old-version"]
        timeoutMinutes: 10
        
    rollback:
      triggerConditions:
        - "error_rate > 5%"
        - "latency > 2000ms"
        - "availability < 99%"
      strategy: "immediate-revert"
      notificationChannels: ["slack", "pagerduty"]

  rolling:
    description: "Gradual replacement of instances"
    phases:
      - name: "validate"
        actions: ["lint", "test"]
        timeoutMinutes: 20
        
      - name: "deploy"
        actions: ["rolling-deploy"]
        timeoutMinutes: 20
        batchSize: 1
        
      - name: "health-check"
        actions: ["health-check"]
        timeoutMinutes: 5
        
    rollback:
      triggerConditions:
        - "error_rate > 10%"
        - "latency > 3000ms"
      strategy: "rolling-back"
      
  canary:
    description: "Deploy to small subset before full rollout"
    phases:
      - name: "validate"
        actions: ["lint", "test", "security-scan"]
        timeoutMinutes: 30
        
      - name: "canary-deploy"
        actions: ["deploy-canary"]
        timeoutMinutes: 15
        trafficPercentage: 5
        
      - name: "canary-monitor"
        actions: ["monitor-canary-metrics"]
        timeoutMinutes: 30
        
      - name: "full-deploy"
        actions: ["deploy-to-remaining"]
        timeoutMinutes: 20
        
    rollback:
      triggerConditions:
        - "error_rate > 3%"
        - "latency > 1500ms"
      strategy: "immediate-revert"

# Pipeline configurations
pipelines:
  ci:
    triggers:
      - push: ["main", "develop", "staging"]
      - pull_request: ["main"]
      
    stages:
      - name: "code-quality"
        jobs: ["lint", "type-check", "security-scan"]
        
      - name: "test"
        jobs: ["unit-test", "integration-test"]
        dependsOn: ["code-quality"]
        
      - name: "build"
        jobs: ["build-frontend", "validate-worker"]
        dependsOn: ["test"]
        
      - name: "package"
        jobs: ["create-artifacts"]
        dependsOn: ["build"]

  cd:
    triggers:
      - workflow_completion: ["ci"]
      - manual_trigger: true
      
    stages:
      - name: "deploy-staging"
        jobs: ["deploy-to-staging"]
        condition: "branch == 'develop'"
        
      - name: "deploy-production"
        jobs: ["deploy-to-production"]
        condition: "branch == 'main' && ci_passed == true"
        requiresApproval: true

# GitOps configuration
gitops:
  enabled: true
  syncPolicy:
    automated: true
    prune: true
    selfHeal: true
    
  driftDetection:
    enabled: true
    frequency: "30m"
    
  repositories:
    config: 
      url: "https://github.com/your-org/pitchey"
      path: "deployments/"
      branch: "main"
      
  applications:
    - name: "pitchey-production"
      environment: "production"
      manifest: "deployments/production/desired-state.yml"
      
    - name: "pitchey-staging" 
      environment: "staging"
      manifest: "deployments/staging/desired-state.yml"

# Multi-region configuration
multiRegion:
  enabled: true
  strategy: "active-active"
  
  regions:
    us-east:
      priority: 1
      dataCenter: "IAD"
      latencyTarget: 50  # ms
      
    us-west:
      priority: 2
      dataCenter: "SJC"
      latencyTarget: 75  # ms
      
    eu-west:
      priority: 3
      dataCenter: "LHR"
      latencyTarget: 100  # ms
      
  loadBalancing:
    algorithm: "geographic"
    healthCheckPath: "/api/health"
    failoverMode: "automatic"
    
  dataReplication:
    strategy: "eventually-consistent"
    syncInterval: "5m"

# Release management
releaseManagement:
  semanticVersioning:
    enabled: true
    conventionalCommits: true
    
  releaseTypes:
    major:
      triggerPatterns: ["BREAKING CHANGE", "!:"]
      requiresApproval: true
      
    minor:
      triggerPatterns: ["feat:"]
      requiresApproval: false
      
    patch:
      triggerPatterns: ["fix:", "docs:", "chore:"]
      requiresApproval: false
      
  automation:
    changelog: true
    releaseNotes: true
    tagCreation: true
    artifactUpload: true

# Rollback configuration
rollback:
  strategies:
    immediate:
      description: "Instant rollback to previous version"
      timeoutMinutes: 5
      
    gradual:
      description: "Gradual traffic shift back to previous version" 
      timeoutMinutes: 15
      
    partial:
      description: "Rollback specific components only"
      timeoutMinutes: 10
      
  triggers:
    automatic:
      - "error_rate > 5% for 5 minutes"
      - "latency > 2000ms for 3 minutes"
      - "availability < 99% for 2 minutes"
      
    manual:
      approvers: ["devops-team", "engineering-lead"]
      
  preservation:
    versionsToKeep: 5
    backupRetention: "90 days"
    
  validation:
    postRollbackTests: true
    healthCheckTimeout: "5 minutes"
    performanceValidation: true

# Notifications and alerting
notifications:
  channels:
    slack:
      webhook: "${SLACK_WEBHOOK_URL}"
      channels:
        - deployment-alerts
        - devops-team
        
    email:
      recipients:
        - devops@company.com
        - engineering-lead@company.com
        
    pagerduty:
      serviceKey: "${PAGERDUTY_SERVICE_KEY}"
      escalationPolicy: "P1-Engineering"
      
  events:
    deployment:
      started: ["slack"]
      completed: ["slack", "email"]
      failed: ["slack", "email", "pagerduty"]
      
    rollback:
      triggered: ["slack", "pagerduty"]
      completed: ["slack", "email"]
      
    monitoring:
      alertTriggered: ["slack"]
      alertResolved: ["slack"]

# Security and compliance
security:
  secretsManagement:
    provider: "github-secrets"
    rotationSchedule: "quarterly"
    validation: true
    
  scanning:
    vulnerabilities: true
    dependencies: true
    containers: false  # Not applicable for Cloudflare Workers
    
  compliance:
    auditLogging: true
    approvalWorkflows: true
    accessControl: "rbac"
    
  policies:
    requireSignedCommits: false
    requireBranchProtection: true
    requireStatusChecks: true