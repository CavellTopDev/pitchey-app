<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Fix Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Notification Fix Verification</h1>
        
        <div id="testResults" class="space-y-4">
            <!-- Test results will be inserted here -->
        </div>
        
        <div class="mt-8">
            <button id="runTests" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                Run Tests
            </button>
            <button id="clearResults" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 ml-4">
                Clear Results
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'https://pitchey-api-prod.ndlovucavelle.workers.dev';
        const FRONTEND_WORKER_URL = 'https://4fc3fe64.pitchey.pages.dev';
        
        function addTestResult(title, status, message, data = null) {
            const results = document.getElementById('testResults');
            const statusColor = status === 'pass' ? 'green' : status === 'fail' ? 'red' : 'yellow';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `border-l-4 border-${statusColor}-500 bg-white p-4 rounded shadow`;
            resultDiv.innerHTML = `
                <h3 class="font-bold text-lg mb-2">${title}</h3>
                <p class="text-gray-700 mb-2">${message}</p>
                ${data ? `<pre class="bg-gray-100 p-2 rounded text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            results.appendChild(resultDiv);
        }

        async function testWorkerNotificationEndpoint() {
            addTestResult('Worker Notification Endpoint', 'info', 'Testing worker /api/notifications/unread endpoint...');
            
            try {
                const response = await fetch(`${API_URL}/api/notifications/unread`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.success && Array.isArray(data.data)) {
                        addTestResult(
                            'Worker Notification Endpoint', 
                            'pass', 
                            'Worker endpoint returns correct structure with data array',
                            data
                        );
                        return true;
                    } else {
                        addTestResult(
                            'Worker Notification Endpoint', 
                            'fail', 
                            'Worker endpoint returns wrong structure - missing data array',
                            data
                        );
                        return false;
                    }
                } else {
                    addTestResult(
                        'Worker Notification Endpoint', 
                        'fail', 
                        `Worker endpoint returned ${response.status}: ${response.statusText}`,
                        data
                    );
                    return false;
                }
            } catch (error) {
                addTestResult(
                    'Worker Notification Endpoint', 
                    'fail', 
                    `Worker endpoint error: ${error.message}`,
                    { error: error.toString() }
                );
                return false;
            }
        }

        async function testFrontendWorkerNotificationEndpoint() {
            addTestResult('Frontend Worker Notification Endpoint', 'info', 'Testing frontend worker /api/notifications/unread endpoint...');
            
            try {
                const response = await fetch(`${FRONTEND_WORKER_URL}/api/notifications/unread`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.success && Array.isArray(data.data)) {
                        addTestResult(
                            'Frontend Worker Notification Endpoint', 
                            'pass', 
                            'Frontend worker endpoint returns correct structure with data array',
                            data
                        );
                        return true;
                    } else {
                        addTestResult(
                            'Frontend Worker Notification Endpoint', 
                            'fail', 
                            'Frontend worker endpoint returns wrong structure - missing data array',
                            data
                        );
                        return false;
                    }
                } else {
                    addTestResult(
                        'Frontend Worker Notification Endpoint', 
                        'fail', 
                        `Frontend worker endpoint returned ${response.status}: ${response.statusText}`,
                        data
                    );
                    return false;
                }
            } catch (error) {
                addTestResult(
                    'Frontend Worker Notification Endpoint', 
                    'fail', 
                    `Frontend worker endpoint error: ${error.message}`,
                    { error: error.toString() }
                );
                return false;
            }
        }

        async function testArrayFilterDefensiveCheck() {
            addTestResult('Array Filter Defensive Check', 'info', 'Testing defensive array handling...');
            
            // Simulate the same logic used in NotificationBell component
            function testFilterLogic(notifications, wsNotifications) {
                try {
                    // This is the exact logic from NotificationBell with defensive checks
                    const unreadCount = (Array.isArray(notifications) ? notifications.filter(n => !n.isRead) : []).length + 
                                       (Array.isArray(wsNotifications) ? wsNotifications.filter(n => !n.read) : []).length;
                    return unreadCount;
                } catch (error) {
                    throw error;
                }
            }
            
            // Test with various inputs including problematic ones
            const testCases = [
                { notifications: [], wsNotifications: [], expected: 0, description: 'Empty arrays' },
                { notifications: null, wsNotifications: undefined, expected: 0, description: 'Null and undefined values' },
                { notifications: [{ isRead: false }], wsNotifications: [{ read: false }], expected: 2, description: 'Valid unread notifications' },
                { notifications: [{ isRead: true }], wsNotifications: [{ read: true }], expected: 0, description: 'All read notifications' },
                { notifications: "not an array", wsNotifications: 42, expected: 0, description: 'Non-array values' }
            ];
            
            let allTestsPassed = true;
            for (const testCase of testCases) {
                try {
                    const result = testFilterLogic(testCase.notifications, testCase.wsNotifications);
                    if (result === testCase.expected) {
                        addTestResult(
                            `Array Filter Test: ${testCase.description}`, 
                            'pass', 
                            `Test passed - returned ${result} as expected`
                        );
                    } else {
                        addTestResult(
                            `Array Filter Test: ${testCase.description}`, 
                            'fail', 
                            `Test failed - expected ${testCase.expected} but got ${result}`
                        );
                        allTestsPassed = false;
                    }
                } catch (error) {
                    addTestResult(
                        `Array Filter Test: ${testCase.description}`, 
                        'fail', 
                        `Test failed with error: ${error.message}`
                    );
                    allTestsPassed = false;
                }
            }
            
            return allTestsPassed;
        }

        async function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            
            addTestResult('Test Suite Started', 'info', 'Running comprehensive notification fix verification...');
            
            const workerTest = await testWorkerNotificationEndpoint();
            const frontendWorkerTest = await testFrontendWorkerNotificationEndpoint();
            const defensiveCheckTest = await testArrayFilterDefensiveCheck();
            
            const allTestsPassed = workerTest && frontendWorkerTest && defensiveCheckTest;
            
            addTestResult(
                'Test Summary', 
                allTestsPassed ? 'pass' : 'fail',
                allTestsPassed 
                    ? '✅ All tests passed! NotificationBell TypeError should be fixed.' 
                    : '❌ Some tests failed. Check individual test results above.',
                {
                    workerEndpoint: workerTest ? 'PASS' : 'FAIL',
                    frontendWorkerEndpoint: frontendWorkerTest ? 'PASS' : 'FAIL', 
                    defensiveChecks: defensiveCheckTest ? 'PASS' : 'FAIL'
                }
            );
        }

        document.getElementById('runTests').addEventListener('click', runAllTests);
        document.getElementById('clearResults').addEventListener('click', () => {
            document.getElementById('testResults').innerHTML = '';
        });
        
        // Auto-run tests on page load
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>