{
  "cache_rules": [
    {
      "id": "static_assets_long_cache",
      "description": "Cache static assets (JS, CSS, fonts) for 1 year",
      "expression": "(http.request.uri.path.extension in {\"js\" \"css\" \"woff\" \"woff2\" \"ttf\" \"eot\" \"otf\"})",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 31536000
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 31536000
        },
        "serve_stale": {
          "disable_stale_while_updating": false
        },
        "respect_strong_etags": true
      }
    },
    {
      "id": "images_webp_avif_cache",
      "description": "Cache optimized images (WebP, AVIF) for 30 days",
      "expression": "(http.request.uri.path.extension in {\"webp\" \"avif\" \"jpg\" \"jpeg\" \"png\" \"gif\" \"svg\" \"ico\"})",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 2592000
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 604800
        },
        "polish": "lossless",
        "webp": true,
        "mirage": true
      }
    },
    {
      "id": "api_dynamic_cache",
      "description": "Cache API responses with smart TTL",
      "expression": "(http.request.uri.path contains \"/api/\" and http.request.method eq \"GET\")",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": true,
        "edge_ttl": {
          "mode": "bypass_by_response",
          "status_code_ttl": [
            {
              "status_code": 200,
              "value": 300
            },
            {
              "status_code": 404,
              "value": 60
            },
            {
              "status_code_range": {
                "from": 500,
                "to": 599
              },
              "value": 0
            }
          ]
        },
        "browser_ttl": {
          "mode": "respect_origin"
        },
        "origin_cache_control": true,
        "cache_key": {
          "custom_key": {
            "query_string": {
              "include": ["page", "limit", "sort", "filter", "q"]
            },
            "header": {
              "include": ["x-api-version"]
            },
            "cookie": {
              "include": []
            }
          }
        }
      }
    },
    {
      "id": "html_pages_cache",
      "description": "Cache HTML pages with short TTL",
      "expression": "(http.request.uri.path.extension eq \"html\" or http.request.uri.path eq \"/\")",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 3600
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 0
        },
        "cache_deception_armor": true,
        "respect_strong_etags": true
      }
    },
    {
      "id": "public_pitches_cache",
      "description": "Cache public pitch pages",
      "expression": "(http.request.uri.path contains \"/pitch/\" and not http.cookie contains \"session\")",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 600
        },
        "browser_ttl": {
          "mode": "override_origin",
          "default": 60
        },
        "cache_key": {
          "cache_by_device_type": true
        }
      }
    },
    {
      "id": "search_results_cache",
      "description": "Cache search results briefly",
      "expression": "(http.request.uri.path contains \"/api/search\")",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": true,
        "edge_ttl": {
          "mode": "override_origin",
          "default": 120
        },
        "browser_ttl": {
          "mode": "bypass"
        },
        "cache_key": {
          "custom_key": {
            "query_string": {
              "include": "*"
            }
          }
        }
      }
    },
    {
      "id": "bypass_authenticated_requests",
      "description": "Bypass cache for authenticated users",
      "expression": "(http.cookie contains \"session\" or http.request.headers[\"authorization\"][0] ne \"\")",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": false
      }
    },
    {
      "id": "bypass_post_requests",
      "description": "Never cache POST, PUT, DELETE requests",
      "expression": "(http.request.method in {\"POST\" \"PUT\" \"DELETE\" \"PATCH\"})",
      "action": "set_cache_settings",
      "action_parameters": {
        "cache": false
      }
    }
  ],
  "page_rules": [
    {
      "targets": [
        {
          "target": "url",
          "constraint": {
            "operator": "matches",
            "value": "pitchey-5o8-66n.pages.dev/assets/*"
          }
        }
      ],
      "actions": [
        {
          "id": "browser_cache_ttl",
          "value": 31536000
        },
        {
          "id": "cache_level",
          "value": "cache_everything"
        },
        {
          "id": "edge_cache_ttl",
          "value": 31536000
        }
      ],
      "priority": 1,
      "status": "active"
    },
    {
      "targets": [
        {
          "target": "url",
          "constraint": {
            "operator": "matches",
            "value": "pitchey-api-prod.ndlovucavelle.workers.dev/api/*"
          }
        }
      ],
      "actions": [
        {
          "id": "cache_level",
          "value": "standard"
        },
        {
          "id": "edge_cache_ttl",
          "value": 300
        },
        {
          "id": "origin_cache_control",
          "value": "on"
        }
      ],
      "priority": 2,
      "status": "active"
    }
  ],
  "worker_routes": [
    {
      "pattern": "pitchey-api-prod.ndlovucavelle.workers.dev/*",
      "script": "pitchey-api-worker"
    }
  ],
  "transform_rules": [
    {
      "id": "add_cache_headers",
      "description": "Add cache control headers",
      "kind": "response_headers",
      "phase": "http_response_headers_transform",
      "expression": "(http.request.uri.path.extension in {\"js\" \"css\"})",
      "action": "set",
      "action_parameters": {
        "headers": {
          "Cache-Control": "public, max-age=31536000, immutable",
          "X-Content-Type-Options": "nosniff"
        }
      }
    },
    {
      "id": "security_headers",
      "description": "Add security headers",
      "kind": "response_headers",
      "phase": "http_response_headers_transform",
      "expression": "true",
      "action": "set",
      "action_parameters": {
        "headers": {
          "X-Frame-Options": "SAMEORIGIN",
          "X-XSS-Protection": "1; mode=block",
          "X-Content-Type-Options": "nosniff",
          "Referrer-Policy": "strict-origin-when-cross-origin",
          "Permissions-Policy": "camera=(), microphone=(), geolocation=()"
        }
      }
    }
  ],
  "compression_rules": [
    {
      "id": "enable_brotli",
      "description": "Enable Brotli compression",
      "expression": "(http.response.content_type.media_type in {\"text/html\" \"text/css\" \"text/javascript\" \"application/javascript\" \"application/json\"})",
      "action": "compress",
      "action_parameters": {
        "algorithms": ["brotli", "gzip"]
      }
    }
  ],
  "rate_limiting_rules": [
    {
      "id": "api_rate_limit",
      "description": "Rate limit API requests",
      "expression": "(http.request.uri.path contains \"/api/\")",
      "threshold": 100,
      "period": 60,
      "action": {
        "mode": "challenge",
        "timeout": 86400
      }
    }
  ],
  "optimization_settings": {
    "auto_minify": {
      "css": true,
      "js": true,
      "html": true
    },
    "polish": "lossless",
    "webp": true,
    "mirage": true,
    "lazy_loading": true,
    "early_hints": true,
    "rocket_loader": false,
    "h2_prioritization": true,
    "http2_push": true,
    "prefetch_preload": true
  },
  "analytics": {
    "web_analytics": true,
    "rum": true,
    "logpush": {
      "enabled": true,
      "dataset": "http_requests",
      "destination": "r2://logs/cloudflare/",
      "fields": [
        "ClientIP",
        "ClientRequestHost",
        "ClientRequestMethod",
        "ClientRequestURI",
        "EdgeEndTimestamp",
        "EdgeResponseBytes",
        "EdgeResponseStatus",
        "EdgeStartTimestamp",
        "RayID",
        "CacheCacheStatus",
        "CacheResponseBytes",
        "CacheTieredFill"
      ]
    }
  }
}