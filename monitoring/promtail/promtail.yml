# Promtail Configuration for Log Shipping
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: pitchey-production

scrape_configs:
  # Application logs
  - job_name: pitchey-app-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: pitchey-app
          environment: production
          service: worker
          __path__: /app/logs/*.log
    
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            service: service
            request_id: request_id
            user_id: user_id
            endpoint: endpoint
            method: method
            status_code: status_code
            duration_ms: duration_ms
            error: error
            cache_status: cache_status
      
      # Set timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # Add labels
      - labels:
          level:
          service:
          endpoint:
          status_code:
          cache_status:
      
      # Drop debug logs in production
      - drop:
          expression: '.*level.*debug.*'
      
      # Format output
      - output:
          source: message

  # System logs
  - job_name: system-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          environment: production
          __path__: /var/log/syslog
    
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+\s+\S+\s+\S+)\s+(?P<host>\S+)\s+(?P<service>\S+)\[(?P<pid>\d+)\]:\s+(?P<message>.*)$'
      
      - timestamp:
          source: timestamp
          format: 'Jan 02 15:04:05'
      
      - labels:
          host:
          service:
          pid:

  # Monitoring logs
  - job_name: monitoring-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: monitoring
          environment: production
          service: health-check
          __path__: /app/logs/monitoring/*.log
    
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+\s+\S+)\s+\[(?P<level>\w+)\]\s+(?P<message>.*)$'
      
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05'
      
      - labels:
          level:

  # Alert logs
  - job_name: alert-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: alerts
          environment: production
          service: alerting
          __path__: /app/logs/alerts.log
    
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+\s+\S+)\s+-\s+(?P<level>\w+):\s+(?P<message>.*)$'
      
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05'
      
      - labels:
          level:

  # Performance logs
  - job_name: performance-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: performance
          environment: production
          service: metrics
          __path__: /app/logs/performance/*.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            endpoint: endpoint
            method: method
            status: status
            duration: duration
            cache_hit: cache_hit
            error: error
      
      - timestamp:
          source: timestamp
          format: RFC3339
      
      - labels:
          endpoint:
          method:
          status:
          cache_hit:

  # Error logs (dedicated pipeline)
  - job_name: error-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: errors
          environment: production
          severity: error
          __path__: /app/logs/errors/*.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            error_type: error_type
            error_message: error_message
            stack_trace: stack_trace
            request_id: request_id
            user_id: user_id
            endpoint: endpoint
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - labels:
          level:
          error_type:
          endpoint:
          request_id:
      
      # Add severity for critical errors
      - template:
          source: severity
          template: |
            {{- if or (contains .error_type "database") (contains .error_type "timeout") -}}
            critical
            {{- else if contains .error_type "auth" -}}
            warning
            {{- else -}}
            error
            {{- end -}}
      
      - labels:
          severity:

# Relabel configs for enhanced labeling
relabeling_configs:
  - source_labels: [__meta_filepath]
    regex: '.*/(.+)\.log'
    target_label: log_file
  
  - source_labels: [__meta_filepath]
    regex: '.*/logs/([^/]+)/.*'
    target_label: log_category
  
  - replacement: pitchey-production
    target_label: instance
