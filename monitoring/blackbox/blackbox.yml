# BlackBox Exporter Configuration
modules:
  # Standard HTTP 2xx check
  http_2xx:
    prober: http
    timeout: 10s
    http:
      method: GET
      valid_status_codes:
        - 200
        - 201
        - 202
      valid_http_versions:
        - "HTTP/1.1"
        - "HTTP/2.0"
      follow_redirects: true
      preferred_ip_protocol: "ip4"
      ip_protocol_fallback: false
      headers:
        User-Agent: "BlackBox-Exporter/Pitchey-Monitoring"
        Accept: "application/json,text/html"
      fail_if_ssl: false
      fail_if_not_ssl: false
      tls_config:
        insecure_skip_verify: false
      body_size_limit: 1MB

  # HTTP POST check with JSON payload
  http_post_json:
    prober: http
    timeout: 15s
    http:
      method: POST
      headers:
        Content-Type: "application/json"
        User-Agent: "BlackBox-Exporter/Health-Check"
      body: '{"health_check": true, "source": "monitoring"}'
      valid_status_codes:
        - 200
        - 201
        - 202
      fail_if_body_not_matches_regexp:
        - '.*"status".*"ok".*'

  # SSL certificate expiry check
  ssl_expire:
    prober: tcp
    timeout: 10s
    tcp:
      tls: true
      tls_config:
        insecure_skip_verify: false

  # DNS resolution check
  dns_lookup:
    prober: dns
    timeout: 5s
    dns:
      query_name: pitchey-5o8.pages.dev
      query_type: A
      valid_rcodes:
        - NOERROR
      validate_answer_rrs:
        fail_if_matches_regexp:
          - ".*127\.0\.0\.1.*"
        fail_if_all_match_regexp:
          - ".*127\.0\.0\.1.*"

  # ICMP ping check
  icmp:
    prober: icmp
    timeout: 5s
    icmp:
      preferred_ip_protocol: "ip4"
      source_ip_address: ""

  # API health check with authentication
  api_health_authenticated:
    prober: http
    timeout: 15s
    http:
      method: GET
      headers:
        Authorization: "Bearer ${HEALTH_CHECK_TOKEN}"
        User-Agent: "BlackBox-Exporter/API-Health"
        Accept: "application/json"
      valid_status_codes:
        - 200
      fail_if_body_not_matches_regexp:
        - '.*"status".*"healthy".*'
        - '.*"database".*"connected".*'
      fail_if_body_matches_regexp:
        - '.*"error".*'
        - '.*"failed".*'

  # Database connectivity check via API
  database_health:
    prober: http
    timeout: 20s
    http:
      method: GET
      headers:
        User-Agent: "BlackBox-Exporter/DB-Health"
      valid_status_codes:
        - 200
      fail_if_body_not_matches_regexp:
        - '.*"database".*"connected".*'
        - '.*"response_time_ms".*[0-9]+.*'
      fail_if_body_matches_regexp:
        - '.*"database".*"disconnected".*'
        - '.*"timeout".*'
        - '.*"error".*'

  # Cache performance check
  cache_performance:
    prober: http
    timeout: 10s
    http:
      method: GET
      headers:
        User-Agent: "BlackBox-Exporter/Cache-Check"
        Cache-Control: "no-cache"
      valid_status_codes:
        - 200
      valid_http_versions:
        - "HTTP/1.1"
        - "HTTP/2.0"

  # WebSocket connectivity check
  websocket_check:
    prober: http
    timeout: 10s
    http:
      method: GET
      headers:
        Connection: "Upgrade"
        Upgrade: "websocket"
        Sec-WebSocket-Key: "x3JJHMbDL1EzLkh9GBhXDw=="
        Sec-WebSocket-Version: "13"
      valid_status_codes:
        - 101  # Switching Protocols
        - 200  # OK (for HTTP fallback)

  # Full application flow check
  application_flow:
    prober: http
    timeout: 30s
    http:
      method: GET
      follow_redirects: true
      headers:
        User-Agent: "BlackBox-Exporter/Full-Flow-Check"
        Accept: "text/html,application/json"
      valid_status_codes:
        - 200
      fail_if_body_not_matches_regexp:
        - '.*pitchey.*'
      body_size_limit: 10MB

  # Security headers check
  security_headers:
    prober: http
    timeout: 10s
    http:
      method: HEAD
      headers:
        User-Agent: "BlackBox-Exporter/Security-Check"
      valid_status_codes:
        - 200
        - 204
      fail_if_header_not_matches_regexp:
        - header: "X-Content-Type-Options"
          regexp: ".*nosniff.*"
        - header: "X-Frame-Options"
          regexp: ".*DENY.*|.*SAMEORIGIN.*"
      fail_if_header_matches_regexp:
        - header: "Server"
          regexp: ".*Apache.*|.*nginx.*"  # Hide server details

  # Response time performance check
  performance_check:
    prober: http
    timeout: 5s
    http:
      method: GET
      headers:
        User-Agent: "BlackBox-Exporter/Performance-Check"
      valid_status_codes:
        - 200
      fail_if_ssl: false
      fail_if_not_ssl: false
