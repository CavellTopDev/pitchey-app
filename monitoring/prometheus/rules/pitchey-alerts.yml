# Pitchey Production Alert Rules
# Critical alerts for production monitoring

groups:
  - name: pitchey.critical
    interval: 15s
    rules:
      # Service Availability Alerts
      - alert: WorkerDown
        expr: probe_success{instance=~"https://pitchey-production.ndlovucavelle.workers.dev.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: worker
          team: platform
        annotations:
          summary: "Pitchey Worker is DOWN"
          description: "The Pitchey Worker at {{ $labels.instance }} has been down for more than 1 minute."
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#worker-down"
          action_required: "Immediate investigation required"

      - alert: FrontendDown
        expr: probe_success{instance="https://pitchey-5o8.pages.dev"} == 0
        for: 2m
        labels:
          severity: critical
          service: frontend
          team: platform
        annotations:
          summary: "Pitchey Frontend is DOWN"
          description: "The Pitchey Frontend has been unreachable for more than 2 minutes."
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#frontend-down"

      # Performance Alerts
      - alert: HighResponseTime
        expr: probe_duration_seconds{instance=~"https://pitchey-production.ndlovucavelle.workers.dev.*"} > 2
        for: 5m
        labels:
          severity: warning
          service: worker
          team: performance
        annotations:
          summary: "High response time detected"
          description: "Response time for {{ $labels.instance }} has been above 2s for 5 minutes. Current: {{ $value }}s"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#high-response-time"

      - alert: CriticalResponseTime
        expr: probe_duration_seconds{instance=~"https://pitchey-production.ndlovucavelle.workers.dev.*"} > 5
        for: 2m
        labels:
          severity: critical
          service: worker
          team: performance
        annotations:
          summary: "CRITICAL: Response time above 5s"
          description: "Response time for {{ $labels.instance }} has been above 5s for 2 minutes. Current: {{ $value }}s"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#critical-response-time"
          action_required: "Immediate performance investigation"

      # HTTP Error Alerts
      - alert: HttpErrorRate
        expr: (rate(probe_http_status_code{instance=~"https://pitchey-production.ndlovucavelle.workers.dev.*"}[5m]) * 100) > 5
        for: 3m
        labels:
          severity: warning
          service: worker
          team: reliability
        annotations:
          summary: "High HTTP error rate detected"
          description: "HTTP error rate is {{ $value }}% for {{ $labels.instance }}"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#http-errors"

      - alert: DatabaseConnectionError
        expr: up{job="database-health"} == 0
        for: 1m
        labels:
          severity: critical
          service: database
          team: platform
        annotations:
          summary: "Database connection failure"
          description: "Unable to connect to database for more than 1 minute"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#database-down"
          action_required: "Check Neon PostgreSQL status and Hyperdrive configuration"

  - name: pitchey.performance
    interval: 30s
    rules:
      # Cache Performance
      - alert: LowCacheHitRate
        expr: (cloudflare_cache_hit_rate{worker="pitchey-production"} < 70) and (cloudflare_requests_total{worker="pitchey-production"} > 100)
        for: 10m
        labels:
          severity: warning
          service: cache
          team: performance
        annotations:
          summary: "Low cache hit rate detected"
          description: "Cache hit rate is {{ $value }}% for worker {{ $labels.worker }}"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#low-cache-hit-rate"
          action_required: "Review cache configuration and TTL settings"

      - alert: HighMemoryUsage
        expr: cloudflare_worker_memory_usage{worker="pitchey-production"} > 80
        for: 5m
        labels:
          severity: warning
          service: worker
          team: performance
        annotations:
          summary: "High worker memory usage"
          description: "Worker memory usage is {{ $value }}% for {{ $labels.worker }}"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#high-memory-usage"

      - alert: CPUTimeoutRisk
        expr: cloudflare_worker_cpu_time{worker="pitchey-production"} > 25000
        for: 3m
        labels:
          severity: warning
          service: worker
          team: performance
        annotations:
          summary: "High CPU time usage - timeout risk"
          description: "Worker CPU time is {{ $value }}ms (limit: 30s) for {{ $labels.worker }}"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#cpu-timeout-risk"
          action_required: "Optimize database queries and reduce computational load"

  - name: pitchey.security
    interval: 60s
    rules:
      # Security Alerts
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: warning
          service: ssl
          team: security
        annotations:
          summary: "SSL certificate expires in 7 days"
          description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#ssl-expiry"

      - alert: SSLCertificateExpired
        expr: probe_ssl_earliest_cert_expiry - time() <= 0
        for: 1m
        labels:
          severity: critical
          service: ssl
          team: security
        annotations:
          summary: "SSL certificate EXPIRED"
          description: "SSL certificate for {{ $labels.instance }} has expired"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#ssl-expired"
          action_required: "Immediate certificate renewal required"

      - alert: UnusualTrafficPattern
        expr: rate(cloudflare_requests_total{worker="pitchey-production"}[5m]) > 100
        for: 10m
        labels:
          severity: info
          service: security
          team: security
        annotations:
          summary: "Unusual traffic pattern detected"
          description: "Request rate is {{ $value }} req/s for {{ $labels.worker }}"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#unusual-traffic"

  - name: pitchey.business
    interval: 300s
    rules:
      # Business Logic Alerts
      - alert: LowAPIUsage
        expr: rate(cloudflare_requests_total{worker="pitchey-production"}[1h]) < 0.1
        for: 2h
        labels:
          severity: info
          service: business
          team: product
        annotations:
          summary: "Low API usage detected"
          description: "API request rate has been unusually low for 2 hours: {{ $value }} req/s"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#low-usage"

      - alert: HighErrorRateEndpoint
        expr: (rate(probe_http_status_code{instance=~".*api/pitches.*"}[10m]) * 100) > 10
        for: 15m
        labels:
          severity: warning
          service: api
          team: backend
        annotations:
          summary: "High error rate on pitches endpoint"
          description: "Pitches API endpoint showing {{ $value }}% error rate"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#api-errors"
          action_required: "Check database connectivity and query performance"

  - name: pitchey.infrastructure
    interval: 120s
    rules:
      # Infrastructure Monitoring
      - alert: MonitoringDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          service: monitoring
          team: platform
        annotations:
          summary: "Prometheus monitoring is down"
          description: "Prometheus instance is unreachable"
          action_required: "Check monitoring infrastructure"

      - alert: AlertManagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        labels:
          severity: critical
          service: alerting
          team: platform
        annotations:
          summary: "AlertManager is down"
          description: "AlertManager instance is unreachable - alerts may not be delivered"
          action_required: "Restart AlertManager service"

      - alert: DiskSpaceHigh
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: warning
          service: system
          team: platform
        annotations:
          summary: "Low disk space"
          description: "Available disk space is {{ $value }}%"
          runbook_url: "https://github.com/supremeisbeing/pitchey/wiki/runbooks#disk-space"
