global:
  smtp_smarthost: 'smtp.sendgrid.net:587'
  smtp_from: 'alerts@pitchey.com'
  smtp_auth_username: 'apikey'
  smtp_auth_password: '${SENDGRID_API_KEY}'
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# Templates for alert messages
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Routing configuration
route:
  group_by: ['alertname', 'severity', 'team']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'default'
  
  routes:
    # Critical alerts - immediate escalation
    - match:
        severity: critical
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 5m
      routes:
        # Platform team critical alerts
        - match:
            team: platform
          receiver: 'platform-critical'
          routes:
            # Database emergencies
            - match:
                team: database
              receiver: 'database-emergency'
            # Payment processing emergencies
            - match:
                team: payments
              receiver: 'payments-emergency'
        
        # Security emergencies
        - match:
            team: security
          receiver: 'security-emergency'
        
        # Default critical path
        - receiver: 'critical-default'

    # Warning alerts - team-specific routing
    - match:
        severity: warning
      group_wait: 2m
      group_interval: 10m
      repeat_interval: 4h
      routes:
        # SRE team warnings
        - match:
            team: sre
          receiver: 'sre-team'
        
        # Platform team warnings
        - match:
            team: platform
          receiver: 'platform-team'
        
        # Infrastructure team warnings
        - match:
            team: infrastructure
          receiver: 'infrastructure-team'
        
        # Security team warnings
        - match:
            team: security
          receiver: 'security-team'
        
        # FinOps team warnings
        - match:
            team: finops
          receiver: 'finops-team'
        
        # Product team warnings
        - match:
            team: product
          receiver: 'product-team'
        
        # Cache team warnings
        - match:
            team: cache
          receiver: 'cache-team'

    # Business hours vs off-hours routing
    - match_re:
        time_range: "weekdays 9:00-17:00"
      routes:
        - match:
            severity: critical
          receiver: 'business-hours-critical'
        - receiver: 'business-hours-default'
    
    # Weekend and off-hours
    - routes:
        - match:
            severity: critical
          receiver: 'off-hours-critical'
        - receiver: 'off-hours-default'

# Inhibition rules to reduce noise
inhibit_rules:
  # If service is down, don't alert on high error rates
  - source_match:
      alertname: ServiceDown
    target_match:
      alertname: HighErrorRate
    equal: ['instance']

  # If there's a critical latency issue, don't alert on warning latency
  - source_match:
      severity: critical
      signal: latency
    target_match:
      severity: warning
      signal: latency
    equal: ['instance']

  # If deployment failed, don't alert on temporary service issues
  - source_match:
      alertname: DeploymentFailure
    target_match_re:
      alertname: (HighErrorRate|HighLatency|ServiceDown)
    equal: ['environment']

receivers:
  # Default receiver - low priority alerts
  - name: 'default'
    slack_configs:
      - channel: '#alerts-low-priority'
        title: 'Pitchey Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Severity:** {{ .Labels.severity }}
          **Team:** {{ .Labels.team }}
          **Impact:** {{ .Annotations.impact }}
          **Action Required:** {{ .Annotations.action_required }}
          **Runbook:** {{ .Labels.runbook_url }}
          {{ end }}
        send_resolved: true

  # Critical alert receivers with escalation
  - name: 'platform-critical'
    slack_configs:
      - channel: '#alerts-critical'
        title: 'üö® CRITICAL ALERT: {{ .GroupLabels.alertname }}'
        text: |
          @channel **CRITICAL PLATFORM ISSUE**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Impact:** {{ .Annotations.impact }}
          **Action Required:** {{ .Annotations.action_required }}
          **Runbook:** {{ .Labels.runbook_url }}
          {{ end }}
        send_resolved: true
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_PLATFORM_KEY}'
        description: '{{ .GroupLabels.alertname }} - {{ .Annotations.summary }}'
        details:
          severity: '{{ .CommonLabels.severity }}'
          team: '{{ .CommonLabels.team }}'
          impact: '{{ .CommonAnnotations.impact }}'
          action_required: '{{ .CommonAnnotations.action_required }}'
    
    email_configs:
      - to: 'platform-team@pitchey.com'
        subject: 'CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          Critical alert detected:
          
          {{ range .Alerts }}
          Summary: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Impact: {{ .Annotations.impact }}
          Action Required: {{ .Annotations.action_required }}
          Runbook: {{ .Labels.runbook_url }}
          {{ end }}

  - name: 'database-emergency'
    slack_configs:
      - channel: '#alerts-database'
        title: 'üî¥ DATABASE EMERGENCY: {{ .GroupLabels.alertname }}'
        text: |
          @here **DATABASE CRITICAL ISSUE**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Impact:** {{ .Annotations.impact }}
          **Action Required:** {{ .Annotations.action_required }}
          {{ end }}
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_DATABASE_KEY}'
        description: 'Database Emergency: {{ .GroupLabels.alertname }}'
    
    # SMS for database emergencies
    webhook_configs:
      - url: '${TWILIO_WEBHOOK_URL}'
        send_resolved: false
        http_config:
          basic_auth:
            username: '${TWILIO_ACCOUNT_SID}'
            password: '${TWILIO_AUTH_TOKEN}'

  - name: 'payments-emergency'
    slack_configs:
      - channel: '#alerts-payments'
        title: 'üí≥ PAYMENT EMERGENCY: {{ .GroupLabels.alertname }}'
        text: |
          @channel **PAYMENT PROCESSING CRITICAL ISSUE**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Impact:** {{ .Annotations.impact }}
          **Action Required:** {{ .Annotations.action_required }}
          {{ end }}
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_PAYMENTS_KEY}'
        description: 'Payment Emergency: {{ .GroupLabels.alertname }}'
    
    email_configs:
      - to: 'payments-team@pitchey.com,cfo@pitchey.com'
        subject: 'PAYMENT EMERGENCY: {{ .GroupLabels.alertname }}'

  - name: 'security-emergency'
    slack_configs:
      - channel: '#alerts-security'
        title: 'üõ°Ô∏è SECURITY EMERGENCY: {{ .GroupLabels.alertname }}'
        text: |
          @channel **SECURITY CRITICAL ISSUE**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Impact:** {{ .Annotations.impact }}
          **Action Required:** {{ .Annotations.action_required }}
          {{ end }}
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_SECURITY_KEY}'
        description: 'Security Emergency: {{ .GroupLabels.alertname }}'
    
    email_configs:
      - to: 'security-team@pitchey.com,ciso@pitchey.com'
        subject: 'SECURITY EMERGENCY: {{ .GroupLabels.alertname }}'

  # Team-specific warning receivers
  - name: 'sre-team'
    slack_configs:
      - channel: '#sre-alerts'
        title: 'SRE Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Team:** {{ .Labels.team }}
          **Runbook:** {{ .Labels.runbook_url }}
          {{ end }}
        send_resolved: true

  - name: 'platform-team'
    slack_configs:
      - channel: '#platform-alerts'
        title: 'Platform Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Impact:** {{ .Annotations.impact }}
          **Action Required:** {{ .Annotations.action_required }}
          {{ end }}
        send_resolved: true

  - name: 'infrastructure-team'
    slack_configs:
      - channel: '#infrastructure-alerts'
        title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
        send_resolved: true

  - name: 'security-team'
    slack_configs:
      - channel: '#security-alerts'
        title: 'Security Alert: {{ .GroupLabels.alertname }}'
        send_resolved: true
    
    email_configs:
      - to: 'security-team@pitchey.com'
        subject: 'Security Alert: {{ .GroupLabels.alertname }}'

  - name: 'finops-team'
    slack_configs:
      - channel: '#finops-alerts'
        title: 'FinOps Alert: {{ .GroupLabels.alertname }}'
        send_resolved: true
    
    email_configs:
      - to: 'finops@pitchey.com,finance@pitchey.com'
        subject: 'Cost Alert: {{ .GroupLabels.alertname }}'

  - name: 'product-team'
    slack_configs:
      - channel: '#product-alerts'
        title: 'Product Alert: {{ .GroupLabels.alertname }}'
        send_resolved: true

  - name: 'cache-team'
    slack_configs:
      - channel: '#cache-alerts'
        title: 'Cache Alert: {{ .GroupLabels.alertname }}'
        send_resolved: true

  # Time-based receivers
  - name: 'business-hours-critical'
    slack_configs:
      - channel: '#alerts-critical'
        title: 'üö® BUSINESS HOURS CRITICAL: {{ .GroupLabels.alertname }}'
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_BUSINESS_HOURS_KEY}'
    
    # Phone call for business hours critical
    webhook_configs:
      - url: '${PHONE_ALERT_WEBHOOK}'

  - name: 'off-hours-critical'
    slack_configs:
      - channel: '#alerts-critical'
        title: 'üåô OFF-HOURS CRITICAL: {{ .GroupLabels.alertname }}'
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_OFF_HOURS_KEY}'
    
    # Escalated phone calls for off-hours
    webhook_configs:
      - url: '${PHONE_ALERT_WEBHOOK_ESCALATED}'

  - name: 'business-hours-default'
    slack_configs:
      - channel: '#alerts-business-hours'
        send_resolved: true

  - name: 'off-hours-default'
    slack_configs:
      - channel: '#alerts-off-hours'
        send_resolved: true

  - name: 'critical-default'
    slack_configs:
      - channel: '#alerts-critical'
        title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_DEFAULT_KEY}'