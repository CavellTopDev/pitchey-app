# AlertManager Configuration for Pitchey Production
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@pitchey.app'
  smtp_auth_username: ''
  smtp_auth_password: ''
  smtp_require_tls: false

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default-receiver'
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      routes:
        # Service down alerts - highest priority
        - match:
            alertname: WorkerDown
          receiver: 'worker-down-alerts'
          group_wait: 0s
          repeat_interval: 2m
        - match:
            alertname: FrontendDown
          receiver: 'frontend-down-alerts'
          group_wait: 0s
          repeat_interval: 2m
        - match:
            alertname: DatabaseConnectionError
          receiver: 'database-alerts'
          group_wait: 0s
          repeat_interval: 3m

    # Performance warnings
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 5m
      repeat_interval: 30m

    # Security alerts
    - match:
        team: security
      receiver: 'security-alerts'
      group_wait: 1m
      repeat_interval: 1h

    # Business alerts
    - match:
        team: product
      receiver: 'business-alerts'
      group_wait: 10m
      repeat_interval: 4h

    # Info level alerts
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 30m
      repeat_interval: 24h

receivers:
  - name: 'default-receiver'
    email_configs:
      - to: 'devops@pitchey.app'
        subject: '[Pitchey] Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          Time: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ if .Annotations.action_required }}
          Action Required: {{ .Annotations.action_required }}
          {{ end }}
          {{ end }}

  # Critical alert handlers
  - name: 'critical-alerts'
    email_configs:
      - to: 'oncall@pitchey.app,devops@pitchey.app'
        subject: 'üö® [CRITICAL] Pitchey Alert: {{ .GroupLabels.alertname }}'
        body: |
          CRITICAL ALERT TRIGGERED
          =======================
          
          {{ range .Alerts }}
          üî• {{ .Annotations.summary }}
          
          Service: {{ .Labels.service }}
          Description: {{ .Annotations.description }}
          Started: {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
          
          {{ if .Annotations.action_required }}
          ‚ö° IMMEDIATE ACTION REQUIRED:
          {{ .Annotations.action_required }}
          {{ end }}
          
          {{ if .Annotations.runbook_url }}
          üìã Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          
          Dashboard: https://monitoring.pitchey.app/dashboard
          Logs: https://monitoring.pitchey.app/logs
          {{ end }}
    webhook_configs:
      - url: 'http://localhost:9094/webhook'
        send_resolved: true

  # Specific critical alert types
  - name: 'worker-down-alerts'
    email_configs:
      - to: 'oncall@pitchey.app,backend@pitchey.app'
        subject: 'üî¥ [CRITICAL] Pitchey Worker DOWN'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'üî¥ WORKER DOWN'
        text: |
          The main Pitchey Worker is unreachable!
          
          {{ range .Alerts }}
          Instance: {{ .Labels.instance }}
          Started: {{ .StartsAt.Format "15:04:05" }}
          {{ if .Annotations.action_required }}
          Action: {{ .Annotations.action_required }}
          {{ end }}
          {{ end }}
        send_resolved: true

  - name: 'frontend-down-alerts'
    email_configs:
      - to: 'oncall@pitchey.app,frontend@pitchey.app'
        subject: 'üî¥ [CRITICAL] Pitchey Frontend DOWN'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'üî¥ FRONTEND DOWN'
        text: 'Pitchey frontend is unreachable at https://pitchey.pages.dev'
        send_resolved: true

  - name: 'database-alerts'
    email_configs:
      - to: 'oncall@pitchey.app,backend@pitchey.app'
        subject: 'üî¥ [CRITICAL] Database Connection Issue'
    webhook_configs:
      - url: 'http://localhost:9094/database-webhook'
        send_resolved: true

  # Warning level alerts
  - name: 'warning-alerts'
    email_configs:
      - to: 'devops@pitchey.app'
        subject: '‚ö†Ô∏è [WARNING] Pitchey: {{ .GroupLabels.alertname }}'
        body: |
          WARNING: Performance or reliability issue detected
          
          {{ range .Alerts }}
          Service: {{ .Labels.service }}
          Issue: {{ .Annotations.summary }}
          Details: {{ .Annotations.description }}
          Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Annotations.runbook_url }}
          
          Troubleshooting guide: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-warnings'
        title: '‚ö†Ô∏è {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          Service: {{ .Labels.service }}
          {{ end }}

  # Security alerts
  - name: 'security-alerts'
    email_configs:
      - to: 'security@pitchey.app,devops@pitchey.app'
        subject: 'üõ°Ô∏è [SECURITY] Pitchey: {{ .GroupLabels.alertname }}'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-security'
        title: 'üõ°Ô∏è Security Alert'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}

  # Business/Product alerts
  - name: 'business-alerts'
    email_configs:
      - to: 'product@pitchey.app,analytics@pitchey.app'
        subject: 'üìä [BUSINESS] Pitchey Metrics: {{ .GroupLabels.alertname }}'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-business'
        title: 'üìä Business Metric Alert'

  # Info level alerts
  - name: 'info-alerts'
    email_configs:
      - to: 'monitoring@pitchey.app'
        subject: '‚ÑπÔ∏è [INFO] Pitchey: {{ .GroupLabels.alertname }}'

# Alert inhibition rules
inhibit_rules:
  # If worker is down, inhibit all other worker-related alerts
  - source_match:
      alertname: WorkerDown
    target_match:
      service: worker
    equal: ['instance']

  # If frontend is down, inhibit performance alerts
  - source_match:
      alertname: FrontendDown
    target_match:
      service: frontend
    equal: ['instance']

  # If database is down, inhibit API error alerts
  - source_match:
      alertname: DatabaseConnectionError
    target_match:
      service: api
    equal: []

# Templates for custom formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
