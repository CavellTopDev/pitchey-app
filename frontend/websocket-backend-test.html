<!DOCTYPE html>
<html>
<head>
    <title>üîå Backend WebSocket Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border-radius: 8px; }
        .success { background: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .error { background: #fef2f2; border: 1px solid #dc2626; color: #dc2626; }
        .info { background: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        .warning { background: #fef3c7; border: 1px solid #d97706; color: #92400e; }
        button { 
            background: #3b82f6; color: white; padding: 10px 20px; 
            border: none; border-radius: 5px; margin: 5px; cursor: pointer; 
        }
        button:hover { background: #2563eb; }
        .log { 
            background: #f8f9fa; border: 1px solid #e9ecef; 
            padding: 10px; border-radius: 4px; margin: 10px 0;
            max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîå Backend WebSocket Connection Test</h1>
    
    <div class="test-section info">
        <h3>üéØ Testing WebSocket Connection</h3>
        <p><strong>Backend URL:</strong> wss://pitchey-backend-fresh.deno.dev</p>
        <p><strong>Expected Endpoint:</strong> /ws (with authentication token)</p>
        <p><strong>Issue:</strong> Frontend WebSocket connections are failing with infinite retry loops</p>
    </div>

    <div class="test-section">
        <h3>üß™ Connection Tests</h3>
        <button onclick="testPublicConnection()">Test /ws (No Auth) - Should Fail Gracefully</button>
        <button onclick="testWithFakeAuth()">Test /ws (Fake Auth) - Should Fail Auth</button>
        <button onclick="testHealthEndpoint()">Test WebSocket Health API</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>üìã Connection Log</h3>
        <div id="log" class="log">Ready to test connections...\n</div>
    </div>

    <div class="test-section warning">
        <h3>‚ö†Ô∏è Expected Results</h3>
        <ul>
            <li><strong>No Auth Test:</strong> Should close immediately with 401/403 error (not loop)</li>
            <li><strong>Fake Auth Test:</strong> Should close with JWT verification error (not loop)</li>
            <li><strong>Health Test:</strong> Should return JSON with WebSocket server status</li>
        </ul>
        <p>If any test shows <strong>infinite connection attempts</strong>, the backend WebSocket isn't configured correctly.</p>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'error': '#dc2626',
                'success': '#16a34a', 
                'info': '#2563eb',
                'warning': '#d97706'
            };
            const color = colorMap[type] || '#6b7280';
            
            logDiv.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = 'Log cleared...\n';
        }

        // Test 1: Connect without authentication (should fail quickly)
        function testPublicConnection() {
            log('üîå Testing WebSocket connection without authentication...', 'info');
            
            const wsUrl = 'wss://pitchey-backend-fresh.deno.dev/ws';
            log(`Connecting to: ${wsUrl}`);
            
            const ws = new WebSocket(wsUrl);
            const startTime = Date.now();
            
            const timeout = setTimeout(() => {
                if (ws.readyState === WebSocket.CONNECTING) {
                    ws.close();
                    log('‚ùå Connection timeout after 10s - backend may not be responding', 'error');
                }
            }, 10000);
            
            ws.onopen = () => {
                clearTimeout(timeout);
                const duration = Date.now() - startTime;
                log(`‚úÖ WebSocket opened unexpectedly after ${duration}ms - should have required auth!`, 'warning');
            };
            
            ws.onclose = (event) => {
                clearTimeout(timeout);
                const duration = Date.now() - startTime;
                log(`üîí WebSocket closed after ${duration}ms - Code: ${event.code}, Reason: "${event.reason}"`, 
                    event.code === 1000 ? 'success' : event.code >= 4000 ? 'warning' : 'info');
                
                if (duration < 1000) {
                    log('‚úÖ Good: Connection closed quickly (no infinite loop)', 'success');
                } else {
                    log('‚ö†Ô∏è Slow close - may indicate connectivity issues', 'warning');
                }
            };
            
            ws.onerror = (error) => {
                clearTimeout(timeout);
                const duration = Date.now() - startTime;
                log(`‚ùå WebSocket error after ${duration}ms: ${error}`, 'error');
            };
        }

        // Test 2: Connect with fake JWT token
        function testWithFakeAuth() {
            log('üîê Testing WebSocket connection with fake authentication...', 'info');
            
            const fakeToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
            const wsUrl = `wss://pitchey-backend-fresh.deno.dev/ws?token=${fakeToken}`;
            log(`Connecting to: ${wsUrl.substring(0, 80)}...`);
            
            const ws = new WebSocket(wsUrl);
            const startTime = Date.now();
            
            const timeout = setTimeout(() => {
                if (ws.readyState === WebSocket.CONNECTING) {
                    ws.close();
                    log('‚ùå Connection timeout after 10s', 'error');
                }
            }, 10000);
            
            ws.onopen = () => {
                clearTimeout(timeout);
                const duration = Date.now() - startTime;
                log(`‚ö†Ô∏è WebSocket opened with fake token after ${duration}ms - auth may not be working!`, 'warning');
            };
            
            ws.onmessage = (event) => {
                log(`üì® Received message: ${event.data}`, 'info');
            };
            
            ws.onclose = (event) => {
                clearTimeout(timeout);
                const duration = Date.now() - startTime;
                log(`üîí WebSocket closed after ${duration}ms - Code: ${event.code}, Reason: "${event.reason}"`, 
                    event.code >= 4000 ? 'success' : 'info');
                
                if (event.reason.includes('token') || event.reason.includes('auth')) {
                    log('‚úÖ Good: Authentication error detected', 'success');
                } else {
                    log('‚ö†Ô∏è Unexpected close reason', 'warning');
                }
            };
            
            ws.onerror = (error) => {
                clearTimeout(timeout);
                const duration = Date.now() - startTime;
                log(`‚ùå WebSocket error after ${duration}ms: ${error}`, 'error');
            };
        }

        // Test 3: Test WebSocket health endpoint
        async function testHealthEndpoint() {
            log('ü©∫ Testing WebSocket health endpoint...', 'info');
            
            try {
                const response = await fetch('https://pitchey-backend-fresh.deno.dev/api/ws/health');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ WebSocket health endpoint responded: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    if (data.status === 'healthy') {
                        log('‚úÖ WebSocket service is healthy', 'success');
                    } else {
                        log('‚ö†Ô∏è WebSocket service may have issues', 'warning');
                    }
                } else {
                    log(`‚ùå Health endpoint returned ${response.status}: ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Health endpoint test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run basic test on load
        setTimeout(() => {
            log('üöÄ Running automatic connection test...', 'info');
            testPublicConnection();
        }, 1000);
    </script>
</body>
</html>