<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitchey Frontend Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-skip {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .test-running {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .summary {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
        }
        .form-group {
            margin: 10px 0;
        }
        input, select {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-category {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }
        h2 {
            color: #333;
            margin-top: 30px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üß™ Pitchey Frontend Integration Test Suite</h1>
    <p>This test suite validates client requirements against the frontend application.</p>

    <div class="test-container">
        <h2>Configuration</h2>
        <div class="form-group">
            <label>API URL:</label>
            <input type="text" id="apiUrl" value="http://localhost:8001" />
        </div>
        <div class="form-group">
            <label>Frontend URL:</label>
            <input type="text" id="frontendUrl" value="http://localhost:5173" />
        </div>
        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="runQuickTests()">‚ö° Quick API Tests</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h3>üìä Test Summary</h3>
        <div id="summaryContent"></div>
    </div>

    <div class="test-container">
        <h2>üîç Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-container">
        <h2>üìã Detailed Logs</h2>
        <div class="logs" id="testLogs"></div>
    </div>

    <script>
        // Test configuration
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            skipped: 0,
            tests: []
        };

        // Demo account credentials
        const DEMO_ACCOUNTS = {
            creator: {
                email: 'alex.creator@demo.com',
                password: 'Demo123',
                userId: 1001
            },
            investor: {
                email: 'sarah.investor@demo.com', 
                password: 'Demo123',
                userId: 1002
            },
            production: {
                email: 'stellar.production@demo.com',
                password: 'Demo123',
                userId: 1003
            }
        };

        // Utility functions
        function log(message) {
            const logs = document.getElementById('testLogs');
            logs.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function logTest(name, status, details = '') {
            testResults.total++;
            const statusClass = status === 'PASS' ? 'test-pass' : 
                               status === 'FAIL' ? 'test-fail' : 
                               status === 'SKIP' ? 'test-skip' : 'test-running';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${statusClass}`;
            resultDiv.innerHTML = `<strong>[${status}] ${name}</strong>${details ? `<br><small>${details}</small>` : ''}`;
            
            document.getElementById('testResults').appendChild(resultDiv);
            
            testResults.tests.push({ name, status, details });
            if (status === 'PASS') testResults.passed++;
            else if (status === 'FAIL') testResults.failed++;
            else if (status === 'SKIP') testResults.skipped++;
            
            updateSummary();
            log(`[${status}] ${name}${details ? ` - ${details}` : ''}`);
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const content = document.getElementById('summaryContent');
            
            if (testResults.total > 0) {
                summary.style.display = 'block';
                const passRate = testResults.total > 0 ? (testResults.passed / testResults.total * 100).toFixed(1) : 0;
                
                content.innerHTML = `
                    <p><strong>Total Tests:</strong> ${testResults.total}</p>
                    <p><strong>Passed:</strong> ${testResults.passed} (${passRate}%)</p>
                    <p><strong>Failed:</strong> ${testResults.failed}</p>
                    <p><strong>Skipped:</strong> ${testResults.skipped}</p>
                    <p><strong>Status:</strong> ${getOverallStatus(passRate)}</p>
                `;
            }
        }

        function getOverallStatus(passRate) {
            if (passRate >= 90) return '‚úÖ EXCELLENT - Ready for client demo';
            if (passRate >= 75) return '‚ö†Ô∏è GOOD - Minor issues to address';
            if (passRate >= 50) return 'üîß NEEDS WORK - Significant issues found';
            return '‚ùå CRITICAL - Major problems require immediate attention';
        }

        function clearResults() {
            testResults = { total: 0, passed: 0, failed: 0, skipped: 0, tests: [] };
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testLogs').textContent = '';
            document.getElementById('summary').style.display = 'none';
            log('Test results cleared');
        }

        // API helper functions
        async function makeRequest(method, url, data = null, token = null) {
            try {
                const config = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    },
                    ...(data && { body: JSON.stringify(data) })
                };
                
                const response = await fetch(url, config);
                const responseData = await response.json().catch(() => ({}));
                
                return { 
                    success: response.ok, 
                    data: responseData, 
                    status: response.status,
                    error: !response.ok ? `HTTP ${response.status}` : null
                };
            } catch (error) {
                return { 
                    success: false, 
                    error: error.message, 
                    status: 0,
                    data: null 
                };
            }
        }

        async function loginUser(userType, apiUrl) {
            const account = DEMO_ACCOUNTS[userType];
            const result = await makeRequest('POST', `${apiUrl}/api/auth/${userType}/login`, {
                email: account.email,
                password: account.password
            });
            
            if (result.success && result.data.token) {
                return { success: true, token: result.data.token, user: result.data.user };
            } else {
                return { success: false, error: result.error || 'Login failed' };
            }
        }

        // Test implementations
        async function testCriticalIssue1() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('Testing Critical Issue #1: Investor Sign-Out Functionality');
            
            // Step 1: Login as investor
            const loginResult = await loginUser('investor', apiUrl);
            if (!loginResult.success) {
                logTest('Investor Login', 'FAIL', `Cannot login: ${loginResult.error}`);
                return;
            }
            
            logTest('Investor Login', 'PASS', 'Successfully logged in as investor');
            const { token } = loginResult;
            
            // Step 2: Test logout endpoint
            const logoutResult = await makeRequest('POST', `${apiUrl}/api/auth/logout`, null, token);
            if (logoutResult.success) {
                logTest('Investor Logout Endpoint', 'PASS', 'Logout endpoint responds successfully');
            } else {
                logTest('Investor Logout Endpoint', 'FAIL', `Logout failed: ${logoutResult.error}`);
                return;
            }
            
            // Step 3: Verify token is invalidated
            const authTestResult = await makeRequest('GET', `${apiUrl}/api/auth/profile`, null, token);
            if (!authTestResult.success && authTestResult.status === 401) {
                logTest('Token Invalidation', 'PASS', 'Token properly invalidated after logout');
            } else {
                logTest('Token Invalidation', 'FAIL', 'Token still valid after logout - security risk');
            }
        }

        async function testCriticalIssue2() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('Testing Critical Issue #2: Investor Dashboard Functionality');
            
            const loginResult = await loginUser('investor', apiUrl);
            if (!loginResult.success) {
                logTest('Investor Dashboard - Login Required', 'FAIL', 'Cannot test dashboard without login');
                return;
            }
            
            const { token } = loginResult;
            
            // Test dashboard endpoint
            const dashboardResult = await makeRequest('GET', `${apiUrl}/api/dashboard/investor`, null, token);
            if (dashboardResult.success) {
                logTest('Investor Dashboard Endpoint', 'PASS', 'Dashboard endpoint responds');
                
                // Verify required dashboard data
                const data = dashboardResult.data;
                const requiredFields = ['portfolioOverview', 'savedPitches', 'ndaStatus', 'recentActivity'];
                
                for (const field of requiredFields) {
                    if (data && data[field] !== undefined) {
                        logTest(`Dashboard - ${field}`, 'PASS', `${field} data present`);
                    } else {
                        logTest(`Dashboard - ${field}`, 'FAIL', `${field} data missing`);
                    }
                }
            } else {
                logTest('Investor Dashboard Endpoint', 'FAIL', `Dashboard error: ${dashboardResult.error}`);
            }
        }

        async function testBrowseTabSeparation() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('Testing Browse Pitches: Tab Content Separation');
            
            // Test Trending Tab
            const trendingResult = await makeRequest('GET', `${apiUrl}/api/pitches/trending`);
            if (trendingResult.success) {
                logTest('Trending Tab Endpoint', 'PASS', 'Trending endpoint responds');
            } else {
                logTest('Trending Tab Endpoint', 'FAIL', `Trending endpoint error: ${trendingResult.error}`);
            }
            
            // Test New Tab
            const newResult = await makeRequest('GET', `${apiUrl}/api/pitches/new`);
            if (newResult.success) {
                logTest('New Tab Endpoint', 'PASS', 'New endpoint responds');
            } else {
                logTest('New Tab Endpoint', 'FAIL', `New endpoint error: ${newResult.error}`);
            }
            
            // Test Top Rated Tab (should NOT exist)
            const topRatedResult = await makeRequest('GET', `${apiUrl}/api/pitches/top-rated`);
            if (!topRatedResult.success && topRatedResult.status === 404) {
                logTest('Top Rated Tab Removal', 'PASS', 'Top Rated endpoint properly removed (404)');
            } else if (topRatedResult.success) {
                logTest('Top Rated Tab Removal', 'FAIL', 'Top Rated endpoint still exists - should be removed');
            } else {
                logTest('Top Rated Tab Removal', 'SKIP', `Unexpected error: ${topRatedResult.error}`);
            }
        }

        async function testAccessControl() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('Testing Access Control: Investor Pitch Creation Restriction');
            
            const loginResult = await loginUser('investor', apiUrl);
            if (!loginResult.success) {
                logTest('Access Control Test Setup', 'FAIL', 'Cannot login as investor');
                return;
            }
            
            const { token } = loginResult;
            
            // Attempt to create a pitch as investor (should fail)
            const createPitchData = {
                title: 'Test Pitch - Should Not Be Created',
                logline: 'This pitch should not be created by an investor',
                genre: 'Test',
                format: 'Feature'
            };
            
            const createResult = await makeRequest('POST', `${apiUrl}/api/pitches`, createPitchData, token);
            
            if (!createResult.success && createResult.status === 403) {
                logTest('Investor Pitch Creation Block', 'PASS', 'Investor properly blocked from creating pitches (403 Forbidden)');
            } else if (createResult.success) {
                logTest('Investor Pitch Creation Block', 'FAIL', 'Investor can create pitches - SECURITY VIOLATION');
            } else {
                logTest('Investor Pitch Creation Block', 'SKIP', `Unexpected error: ${createResult.error}`);
            }
            
            // Test that investor CAN view pitches
            const viewResult = await makeRequest('GET', `${apiUrl}/api/pitches`, null, token);
            if (viewResult.success) {
                logTest('Investor Pitch Viewing', 'PASS', 'Investor can view pitches');
            } else {
                logTest('Investor Pitch Viewing', 'FAIL', `Investor cannot view pitches: ${viewResult.error}`);
            }
        }

        async function testGeneralBrowse() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('Testing General Browse with Sorting');
            
            const sortOptions = [
                { sort: 'alphabetical', order: 'asc', name: 'Alphabetical A-Z' },
                { sort: 'date', order: 'desc', name: 'Date (Newest First)' },
                { sort: 'budget', order: 'desc', name: 'Budget (High to Low)' },
                { sort: 'views', order: 'desc', name: 'Views (Most Viewed)' }
            ];
            
            for (const option of sortOptions) {
                const result = await makeRequest('GET', `${apiUrl}/api/pitches/browse/general?sort=${option.sort}&order=${option.order}`);
                
                if (result.success) {
                    logTest(`General Browse - ${option.name}`, 'PASS', 'Sort option endpoint responds');
                } else {
                    logTest(`General Browse - ${option.name}`, 'FAIL', `Sort option error: ${result.error}`);
                }
            }
        }

        async function testBasicConnectivity() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('Testing Basic API Connectivity');
            
            // Test backend connectivity
            const connectResult = await makeRequest('GET', `${apiUrl}/`);
            if (connectResult.success) {
                logTest('Backend Connectivity', 'PASS', 'Backend server is responding');
            } else {
                logTest('Backend Connectivity', 'FAIL', `Backend server not responding: ${connectResult.error}`);
            }
            
            // Test health endpoint
            const healthResult = await makeRequest('GET', `${apiUrl}/health`);
            if (healthResult.success) {
                logTest('Health Check Endpoint', 'PASS', 'Health endpoint available');
            } else {
                logTest('Health Check Endpoint', 'SKIP', 'Health endpoint not available');
            }
            
            // Test pitches endpoint
            const pitchesResult = await makeRequest('GET', `${apiUrl}/api/pitches`);
            if (pitchesResult.success) {
                logTest('Pitches Endpoint', 'PASS', 'Pitches endpoint responds');
            } else {
                logTest('Pitches Endpoint', 'FAIL', `Pitches endpoint error: ${pitchesResult.error}`);
            }
        }

        // Main test functions
        async function runQuickTests() {
            clearResults();
            log('üöÄ Starting Quick API Tests');
            
            await testBasicConnectivity();
            await testCriticalIssue1();
            await testCriticalIssue2();
            await testAccessControl();
            
            log('‚úÖ Quick tests completed');
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Starting Comprehensive Client Requirements Tests');
            
            try {
                await testBasicConnectivity();
                await testCriticalIssue1();
                await testCriticalIssue2();
                await testBrowseTabSeparation();
                await testGeneralBrowse();
                await testAccessControl();
                
                log('‚úÖ All tests completed');
                
                // Generate final summary
                const passRate = testResults.total > 0 ? (testResults.passed / testResults.total * 100).toFixed(1) : 0;
                log(`üìä Final Results: ${testResults.passed}/${testResults.total} tests passed (${passRate}%)`);
                
            } catch (error) {
                log(`‚ùå Test execution error: ${error.message}`);
                logTest('Test Execution', 'FAIL', `Unexpected error: ${error.message}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Frontend Integration Test Suite loaded');
            log('Click "Run All Tests" to begin comprehensive testing');
            log('Click "Quick API Tests" for basic validation');
        });
    </script>
</body>
</html>