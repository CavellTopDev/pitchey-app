# Cloudflare Load Balancer Configuration
# Multi-region deployment with intelligent routing

name = "pitchey-global-lb"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]
account_id = "e16d3bf549153de23459a6c6a06a431b"

# Primary worker configuration
main = "src/worker-load-balancer.ts"

# Regional deployments for geographic distribution
[[deployments]]
name = "pitchey-us-east"
region = "enam"  # Eastern North America
route = "pitchey-us-east.cavelltheleaddev.workers.dev/*"
workers_dev = true

[[deployments]]
name = "pitchey-us-west"
region = "wnam"  # Western North America  
route = "pitchey-us-west.cavelltheleaddev.workers.dev/*"
workers_dev = true

[[deployments]]
name = "pitchey-europe"
region = "eeur"  # Eastern Europe
route = "pitchey-eu.cavelltheleaddev.workers.dev/*"
workers_dev = true

[[deployments]]
name = "pitchey-asia"
region = "apac"  # Asia Pacific
route = "pitchey-asia.cavelltheleaddev.workers.dev/*"
workers_dev = true

# Smart Placement for optimal performance
[placement]
mode = "smart"

# Environment variables for load balancing
[vars]
JWT_SECRET = "vYGh89KjLmNpQrStUwXyZ123456789ABCDEFGHIJKLMNOPQRSTuvwxyz"
# Regional worker URLs
US_EAST_WORKER = "https://pitchey-us-east.cavelltheleaddev.workers.dev"
US_WEST_WORKER = "https://pitchey-us-west.cavelltheleaddev.workers.dev"
EU_WORKER = "https://pitchey-eu.cavelltheleaddev.workers.dev"
ASIA_WORKER = "https://pitchey-asia.cavelltheleaddev.workers.dev"
# Fallback configuration
PRIMARY_REGION = "us-east"
FALLBACK_REGION = "us-west"
# Load balancing algorithm
LB_ALGORITHM = "weighted_round_robin"  # Options: round_robin, weighted_round_robin, least_connections, geo_proximity
# Health check configuration
HEALTH_CHECK_INTERVAL = "30"  # seconds
HEALTH_CHECK_TIMEOUT = "5"  # seconds
HEALTH_CHECK_RETRIES = "3"
# Circuit breaker configuration  
CIRCUIT_BREAKER_THRESHOLD = "50"  # Error percentage to trigger
CIRCUIT_BREAKER_WINDOW = "60"  # seconds
CIRCUIT_BREAKER_COOLDOWN = "30"  # seconds before retry
# Request coalescing
COALESCE_WINDOW = "100"  # milliseconds
MAX_COALESCED_REQUESTS = "10"
# Cost optimization
MAX_SUBREQUESTS = "50"  # Per worker invocation
CACHE_DEFAULT_TTL = "300"  # 5 minutes
STALE_WHILE_REVALIDATE = "86400"  # 24 hours

# KV Namespaces for distributed state
[[kv_namespaces]]
binding = "HEALTH_STATUS"
id = "health-status-kv-id"

[[kv_namespaces]]
binding = "LOAD_METRICS"
id = "load-metrics-kv-id"

[[kv_namespaces]]
binding = "CIRCUIT_BREAKER_STATE"
id = "circuit-breaker-kv-id"

[[kv_namespaces]]
binding = "REQUEST_CACHE"
id = "request-cache-kv-id"

[[kv_namespaces]]
binding = "RATE_LIMITS"
id = "rate-limits-kv-id"

# Analytics Engine for monitoring
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "pitchey_load_balancer"

# Durable Objects for stateful coordination
[[durable_objects.bindings]]
name = "LOAD_COORDINATOR"
class_name = "LoadCoordinator"

[[durable_objects.bindings]]
name = "HEALTH_MONITOR"
class_name = "HealthMonitor"

[[durable_objects.bindings]]
name = "COST_TRACKER"
class_name = "CostTracker"

# Queue for async processing
[[queues.producers]]
binding = "ASYNC_QUEUE"
queue = "pitchey-async-tasks"

[[queues.consumers]]
queue = "pitchey-async-tasks"
max_batch_size = 100
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pitchey-dlq"

# R2 for distributed storage
[[r2_buckets]]
binding = "METRICS_STORAGE"
bucket_name = "pitchey-metrics"

# Hyperdrive for database connection pooling
[[hyperdrive]]
binding = "HYPERDRIVE_PRIMARY"
id = "primary-db-hyperdrive-id"

[[hyperdrive]]
binding = "HYPERDRIVE_REPLICA"
id = "replica-db-hyperdrive-id"

# Service bindings for worker-to-worker communication
[[services]]
binding = "US_EAST_SERVICE"
service = "pitchey-us-east"

[[services]]
binding = "US_WEST_SERVICE"
service = "pitchey-us-west"

[[services]]
binding = "EU_SERVICE"
service = "pitchey-europe"

[[services]]
binding = "ASIA_SERVICE"
service = "pitchey-asia"

# Triggers for scheduled tasks
[triggers]
crons = [
  "*/1 * * * *",   # Health checks every minute
  "*/5 * * * *",   # Metrics aggregation every 5 minutes
  "*/15 * * * *",  # Cost analysis every 15 minutes
  "0 * * * *",     # Hourly report generation
  "0 0 * * *"      # Daily optimization
]

# Rate limiting rules
[[rate_limiting]]
threshold = 100
period = 60
characteristics = ["cf.colo.id", "ip.src"]

# Custom limits for different endpoints
[[rate_limiting]]
threshold = 10
period = 60
characteristics = ["ip.src"]
path_pattern = "/api/auth/*"

[[rate_limiting]]
threshold = 5
period = 60
characteristics = ["ip.src"]
path_pattern = "/api/upload/*"

# Observability configuration
[observability]
enabled = true
sampling_rate = 0.1  # 10% sampling for traces
log_level = "info"
metrics_enabled = true

# Traffic routing rules
[[routes]]
pattern = "pitchey.pages.dev/*"
zone_name = "cavelltheleaddev.com"

[[routes]]
pattern = "api.pitchey.com/*"
zone_name = "cavelltheleaddev.com"

[[routes]]
pattern = "ws.pitchey.com/*"
zone_name = "cavelltheleaddev.com"

# Canary deployment configuration
[canary]
enabled = false
percentage = 10  # 10% of traffic to canary
cookie_affinity = true
session_affinity = "ip"

# Migrations for Durable Objects
[[migrations]]
tag = "v1"
new_sqlite_classes = ["LoadCoordinator", "HealthMonitor", "CostTracker"]