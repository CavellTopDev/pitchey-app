<!DOCTYPE html>
<html>
<head>
    <title>Debug Marketplace Frontend</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .success { color: green; }
        .failure { color: red; }
        .info { color: blue; }
        pre { background: #f4f4f4; padding: 10px; margin: 10px 0; }
        .step { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
    </style>
</head>
<body>
    <h1>Debug Marketplace Data Flow</h1>
    <div id="results"></div>

    <script>
        async function debugMarketplace() {
            const results = document.getElementById('results');
            
            results.innerHTML += `<div class="step"><h2>Step 1: Test Backend API</h2>`;
            
            try {
                const response = await fetch('http://localhost:8001/api/pitches/public');
                const backendData = await response.json();
                
                results.innerHTML += `<p class="info">Backend response status: ${response.status}</p>`;
                results.innerHTML += `<p class="info">Backend pitches count: ${backendData.pitches?.length || 0}</p>`;
                
                const stellarPitches = backendData.pitches?.filter(p => 
                    p.creator?.username === 'stellarproduction'
                ) || [];
                
                results.innerHTML += `<p class="info">Stellar pitches in backend: ${stellarPitches.length}</p>`;
                stellarPitches.forEach(pitch => {
                    results.innerHTML += `<p>- ${pitch.title} (${pitch.creator?.userType})</p>`;
                });
                results.innerHTML += `</div>`;
                
                // Step 2: Simulate frontend pitch service
                results.innerHTML += `<div class="step"><h2>Step 2: Simulate Frontend Pitch Service</h2>`;
                
                // This simulates what pitchService.getPublicPitches() does
                const frontendPitches = backendData.pitches || [];
                results.innerHTML += `<p class="info">Frontend would receive: ${frontendPitches.length} pitches</p>`;
                
                const frontendStellar = frontendPitches.filter(p => 
                    p.creator?.username === 'stellarproduction'
                );
                results.innerHTML += `<p class="info">Stellar pitches after frontend processing: ${frontendStellar.length}</p>`;
                results.innerHTML += `</div>`;
                
                // Step 3: Test filtering logic
                results.innerHTML += `<div class="step"><h2>Step 3: Test Filtering Logic</h2>`;
                
                // Simulate the filtering logic from applyFilters()
                let filtered = [...frontendPitches];
                
                // Default view sorting (newest first)
                filtered = filtered.sort((a, b) => 
                    new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
                );
                
                const filteredStellar = filtered.filter(p => 
                    p.creator?.username === 'stellarproduction'
                );
                results.innerHTML += `<p class="info">Stellar pitches after filtering: ${filteredStellar.length}</p>`;
                
                // Show all pitches with creators
                results.innerHTML += `<h3>All Pitches with Creator Info:</h3>`;
                filtered.forEach((pitch, index) => {
                    const isStella = pitch.creator?.username === 'stellarproduction';
                    const className = isStella ? 'success' : 'info';
                    results.innerHTML += `<p class="${className}">${index + 1}. ${pitch.title} by ${pitch.creator?.username} (${pitch.creator?.userType}) ${isStella ? '← STELLAR' : ''}</p>`;
                });
                
                results.innerHTML += `</div>`;
                
                if (filteredStellar.length > 0) {
                    results.innerHTML += `<div class="success"><h2>✅ STELLAR PITCHES SHOULD BE VISIBLE</h2></div>`;
                } else {
                    results.innerHTML += `<div class="failure"><h2>❌ STELLAR PITCHES MISSING</h2></div>`;
                }
                
            } catch (error) {
                results.innerHTML += `<div class="failure">Error: ${error.message}</div>`;
                console.error('Debug failed:', error);
            }
        }
        
        debugMarketplace();
    </script>
</body>
</html>