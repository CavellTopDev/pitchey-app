# Pre-commit configuration for quality enforcement
# Ensures code quality, security, and testing standards before commits

repos:
  # ==================== CODE FORMATTING ====================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim Trailing Whitespace
      - id: end-of-file-fixer
        name: Fix End of Files
      - id: check-yaml
        name: Check YAML Syntax
      - id: check-added-large-files
        name: Check for Large Files
        args: ['--maxkb=1000']
      - id: check-merge-conflict
        name: Check for Merge Conflicts
      - id: check-json
        name: Check JSON Syntax
        exclude: '^(package-lock\.json|yarn\.lock)$'
      - id: pretty-format-json
        name: Format JSON Files
        args: ['--autofix', '--indent=2']
        exclude: '^(package-lock\.json|yarn\.lock)$'

  # ==================== TYPESCRIPT/JAVASCRIPT ====================
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v8.56.0
    hooks:
      - id: eslint
        name: ESLint (Frontend)
        files: '^frontend/.*\.(js|jsx|ts|tsx)$'
        additional_dependencies:
          - eslint@8.56.0
          - '@typescript-eslint/parser@6.21.0'
          - '@typescript-eslint/eslint-plugin@6.21.0'
        args: ['--fix', '--max-warnings=0']

  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v3.1.0
    hooks:
      - id: prettier
        name: Prettier (Frontend)
        files: '^frontend/.*\.(js|jsx|ts|tsx|css|scss|json|md)$'
        args: ['--write']

  # ==================== DENO (BACKEND) ====================
  - repo: local
    hooks:
      - id: deno-fmt
        name: Deno Format (Backend)
        entry: deno fmt
        language: system
        files: '^src/.*\.ts$|^tests/.*\.ts$'
        pass_filenames: true

      - id: deno-lint
        name: Deno Lint (Backend)
        entry: deno lint
        language: system
        files: '^src/.*\.ts$|^tests/.*\.ts$'
        pass_filenames: true

      - id: deno-check
        name: Deno Type Check (Backend)
        entry: deno check
        language: system
        files: '^src/.*\.ts$'
        pass_filenames: true

  # ==================== SECURITY SCANNING ====================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        name: Detect Secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: |
          (?x)^(
            .*\.lock$|
            .*\.log$|
            .*\.min\.js$|
            .*\.map$|
            node_modules/.*|
            \.git/.*
          )$

  - repo: https://github.com/gitguardian/ggshield
    rev: v1.25.0
    hooks:
      - id: ggshield
        name: GitGuardian Security Scan
        language: python
        stages: [commit]

  # ==================== DEPENDENCY SECURITY ====================
  - repo: local
    hooks:
      - id: npm-audit
        name: NPM Security Audit (Frontend)
        entry: bash -c 'cd frontend && npm audit --audit-level=moderate'
        language: system
        files: '^frontend/package\.json$|^frontend/package-lock\.json$'
        pass_filenames: false

      - id: check-deno-deps
        name: Check Deno Dependencies
        entry: bash -c 'deno task deps:check'
        language: system
        files: '^deno\.(json|jsonc)$|^import_map\.json$'
        pass_filenames: false

  # ==================== DATABASE MIGRATIONS ====================
  - repo: local
    hooks:
      - id: migration-validation
        name: Validate Database Migrations
        entry: bash -c 'deno task db:validate-migrations'
        language: system
        files: '^src/db/migrations/.*\.sql$'
        pass_filenames: false

  # ==================== COMMIT MESSAGE VALIDATION ====================
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v3.13.0
    hooks:
      - id: commitizen
        name: Validate Commit Message
        stages: [commit-msg]

  # ==================== TESTING REQUIREMENTS ====================
  - repo: local
    hooks:
      - id: unit-tests
        name: Run Unit Tests
        entry: bash -c 'cd tests && deno test unit/ --parallel --coverage=coverage/unit'
        language: system
        files: '^(src/.*\.ts|tests/unit/.*\.test\.ts)$'
        pass_filenames: false

      - id: frontend-tests
        name: Run Frontend Tests
        entry: bash -c 'cd frontend && npm test -- --run --reporter=json > test-results.json'
        language: system
        files: '^frontend/(src/.*|.*\.test\.(js|jsx|ts|tsx))$'
        pass_filenames: false

      - id: test-coverage-check
        name: Check Test Coverage
        entry: bash -c './scripts/check-coverage.sh'
        language: system
        files: '^(src/.*\.ts|tests/.*\.test\.ts|frontend/src/.*\.(js|jsx|ts|tsx))$'
        pass_filenames: false

  # ==================== API CONTRACT VALIDATION ====================
  - repo: local
    hooks:
      - id: api-contract-validation
        name: Validate API Contracts
        entry: bash -c 'deno task test:contract'
        language: system
        files: '^(src/routes/.*\.ts|api-spec\.yaml)$'
        pass_filenames: false

  # ==================== PERFORMANCE CHECKS ====================
  - repo: local
    hooks:
      - id: performance-regression
        name: Check Performance Regression
        entry: bash -c './scripts/performance-check.sh'
        language: system
        files: '^(src/.*\.ts|tests/performance/.*\.test\.ts)$'
        pass_filenames: false

  # ==================== ACCESSIBILITY CHECKS ====================
  - repo: local
    hooks:
      - id: accessibility-tests
        name: Run Accessibility Tests
        entry: bash -c 'cd frontend && npm run test:a11y'
        language: system
        files: '^frontend/src/.*\.(jsx|tsx)$'
        pass_filenames: false

# ==================== CONFIGURATION ====================
default_language_version:
  python: python3.11
  node: '18.19.0'

fail_fast: false

# Skip hooks for specific scenarios
ci:
  skip: [npm-audit, performance-regression]  # Skip in CI for speed

# Hook configuration
repos:
  - repo: meta
    hooks:
      - id: check-hooks-apply
        name: Check hooks apply
      - id: check-useless-excludes
        name: Check for useless excludes