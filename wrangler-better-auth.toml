# Cloudflare Workers Configuration for Better Auth + Pitchey Platform
name = "pitchey-better-auth"
main = "src/auth/auth-worker.ts"
compatibility_date = "2024-12-16"
compatibility_flags = ["nodejs_compat"]
account_id = "e16d3bf549153de23459a6c6a06a431b"

[vars]
# Better Auth Configuration
BETTER_AUTH_URL = "https://pitchey-production.cavelltheleaddev.workers.dev"
SESSION_COOKIE_NAME = "pitchey-session"
SESSION_MAX_AGE = "2592000"
ENVIRONMENT = "production"

# App Configuration  
FRONTEND_URL = "https://pitchey.pages.dev"
SENTRY_DSN = "https://fd5664ae577039ccb7cce31e91f54533@o4510137537396736.ingest.de.sentry.io/4510138308755536"
SENTRY_ENVIRONMENT = "production"
SENTRY_RELEASE = "better-auth-v1.0"
NODE_ENV = "production"

# Security Configuration
CORS_ORIGINS = "https://pitchey.pages.dev,https://pitchey-production.cavelltheleaddev.workers.dev"
RATE_LIMIT_ENABLED = "true"
RATE_LIMIT_WINDOW = "60"
RATE_LIMIT_MAX_REQUESTS = "100"

# Session Configuration
SESSION_SECURE = "true"
SESSION_SAME_SITE = "lax"
SESSION_HTTP_ONLY = "true"

# OAuth Configuration
OAUTH_ENABLED = "true"
MAGIC_LINK_ENABLED = "true"
EMAIL_VERIFICATION_ENABLED = "true"

# KV Namespaces for sessions and rate limiting
[[kv_namespaces]]
binding = "SESSIONS_KV"
id = "98c88a185eb448e4868fcc87e458b3ac"

[[kv_namespaces]]  
binding = "RATE_LIMIT_KV"
id = "98c88a185eb448e4868fcc87e458b3ac"

# KV for static content caching
[[kv_namespaces]]
binding = "CACHE"
id = "98c88a185eb448e4868fcc87e458b3ac"

# R2 for file storage
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "pitchey-uploads"

# Durable Objects for real-time features
[[durable_objects.bindings]]
name = "WEBSOCKET_ROOMS"
class_name = "WebSocketRoom"

[[durable_objects.bindings]]
name = "NOTIFICATION_ROOM"
class_name = "NotificationRoom"

# Neon PostgreSQL via Hyperdrive
[[hyperdrive]]
binding = "HYPERDRIVE"
id = "983d4a1818264b5dbdca26bacf167dee"

# Migrations
[[migrations]]
tag = "v3"
new_sqlite_classes = ["WebSocketRoom"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["NotificationRoom"]

# Environment-specific configurations
[env.production]
name = "pitchey-production-auth"

[env.production.vars]
BETTER_AUTH_URL = "https://pitchey-production.cavelltheleaddev.workers.dev"
ENVIRONMENT = "production"
SESSION_SECURE = "true"
EMAIL_VERIFICATION_ENABLED = "true"

[env.preview]
name = "pitchey-preview-auth"

[env.preview.vars]
BETTER_AUTH_URL = "https://pitchey-preview.cavelltheleaddev.workers.dev"
ENVIRONMENT = "preview"
SESSION_SECURE = "true"
EMAIL_VERIFICATION_ENABLED = "false"

[env.development]
name = "pitchey-development-auth"

[env.development.vars]
BETTER_AUTH_URL = "http://localhost:8787"
ENVIRONMENT = "development"
SESSION_SECURE = "false"
EMAIL_VERIFICATION_ENABLED = "false"
CORS_ORIGINS = "http://localhost:5173,http://localhost:8001,http://localhost:3000"

# Scheduled tasks (disabled for auth worker)
[triggers]
crons = []

# Build configuration
[build]
command = "npm run build"

# Analytics and observability
[observability]
enabled = true

# Performance settings
[placement]
mode = "smart"

# Compatibility settings for Better Auth
[limits]
cpu_ms = 50
memory_mb = 128

# Additional analytics
[analytics_engine_datasets]
[[analytics_engine_datasets]]
binding = "AUTH_ANALYTICS"

# Comments explaining secrets management:
# The following secrets should be set using wrangler secret put:
# - BETTER_AUTH_SECRET (required)
# - DATABASE_URL (required) 
# - NEON_DATABASE_URL (optional, fallback)
# - GOOGLE_CLIENT_SECRET (optional, for OAuth)
# - GITHUB_CLIENT_SECRET (optional, for OAuth)
#
# Example commands:
# wrangler secret put BETTER_AUTH_SECRET
# wrangler secret put DATABASE_URL