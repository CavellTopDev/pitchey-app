<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Diagnosis Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected { background: #d4edda; border: 1px solid #c3e6cb; }
        .connecting { background: #fff3cd; border: 1px solid #ffeaa7; }
        .disconnected { background: #f8d7da; border: 1px solid #f5c6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Diagnosis Tool</h1>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="status" class="status disconnected">Disconnected</div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>JWT Token Test</h2>
        <input type="text" id="tokenInput" placeholder="Paste JWT token here" style="width: 100%; margin: 5px 0;">
        <button onclick="testToken()">Test Token</button>
        <button onclick="useStoredToken()">Use Stored Token</button>
        <div id="tokenStatus"></div>
    </div>

    <div class="test-section">
        <h2>Connection Details</h2>
        <p><strong>Server URL:</strong> <span id="serverUrl">http://localhost:8001</span></p>
        <p><strong>WebSocket URL:</strong> <span id="wsUrl">ws://localhost:8001/ws</span></p>
        <p><strong>Current Token:</strong> <span id="currentToken">None</span></p>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        let ws = null;
        let currentToken = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `${timestamp} ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = status;
            statusElement.className = `status ${className}`;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function useStoredToken() {
            const token = localStorage.getItem('authToken');
            if (token) {
                currentToken = token;
                document.getElementById('tokenInput').value = token;
                document.getElementById('currentToken').textContent = token.substring(0, 50) + '...';
                log(`Using stored token: ${token.substring(0, 20)}...`);
                testToken();
            } else {
                log('No stored token found', 'error');
                document.getElementById('currentToken').textContent = 'None';
            }
        }

        async function testToken() {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value.trim();
            
            if (!token) {
                log('No token provided', 'error');
                return;
            }

            currentToken = token;
            document.getElementById('currentToken').textContent = token.substring(0, 50) + '...';

            try {
                log('Testing JWT token validity...');
                
                // Decode JWT payload (basic decode, no verification)
                const parts = token.split('.');
                if (parts.length !== 3) {
                    log('Invalid JWT format - should have 3 parts separated by dots', 'error');
                    return;
                }

                const payload = JSON.parse(atob(parts[1]));
                log(`JWT Payload: ${JSON.stringify(payload, null, 2)}`);

                // Check expiration
                if (payload.exp) {
                    const expiration = new Date(payload.exp * 1000);
                    const now = new Date();
                    if (expiration < now) {
                        log(`Token is EXPIRED! Expired at: ${expiration.toISOString()}`, 'error');
                    } else {
                        log(`Token is valid until: ${expiration.toISOString()}`);
                    }
                }

                // Test token with HTTP request first
                log('Testing token with HTTP request...');
                const response = await fetch('http://localhost:8001/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`HTTP auth test successful: ${JSON.stringify(data)}`);
                    document.getElementById('tokenStatus').innerHTML = '<span style="color: green;">‚úÖ Token is valid</span>';
                } else {
                    const errorText = await response.text();
                    log(`HTTP auth test failed (${response.status}): ${errorText}`, 'error');
                    document.getElementById('tokenStatus').innerHTML = '<span style="color: red;">‚ùå Token is invalid</span>';
                }

            } catch (error) {
                log(`Token test error: ${error.message}`, 'error');
                document.getElementById('tokenStatus').innerHTML = '<span style="color: red;">‚ùå Token test failed</span>';
            }
        }

        function testConnection() {
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                log('Connection already exists, closing first...');
                ws.close();
            }

            if (!currentToken) {
                log('No token available. Please test a token first.', 'error');
                return;
            }

            const wsUrl = `ws://localhost:8001/ws?token=${currentToken}`;
            log(`Attempting WebSocket connection to: ws://localhost:8001/ws?token=<hidden>`);
            log(`Full URL for debugging: ${wsUrl.replace(/token=.*/, 'token=<hidden>')}`);
            
            updateStatus('Connecting...', 'connecting');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    log('‚úÖ WebSocket connection opened successfully!');
                    updateStatus('Connected', 'connected');
                    
                    // Send a test message
                    const testMessage = {
                        type: 'ping',
                        timestamp: new Date().toISOString(),
                        data: { test: true }
                    };
                    ws.send(JSON.stringify(testMessage));
                    log(`Sent test message: ${JSON.stringify(testMessage)}`);
                };

                ws.onmessage = function(event) {
                    log(`üì® Received message: ${event.data}`);
                    try {
                        const message = JSON.parse(event.data);
                        log(`üì¶ Parsed message: ${JSON.stringify(message, null, 2)}`);
                    } catch (e) {
                        log(`Failed to parse message as JSON: ${e.message}`, 'warn');
                    }
                };

                ws.onclose = function(event) {
                    log(`üîå WebSocket closed - Code: ${event.code}, Reason: "${event.reason}", Clean: ${event.wasClean}`);
                    updateStatus(`Disconnected (${event.code})`, 'disconnected');
                    
                    // Log specific close codes
                    switch(event.code) {
                        case 1000:
                            log('Normal closure');
                            break;
                        case 1001:
                            log('Going away (page refresh or navigation)');
                            break;
                        case 1002:
                            log('Protocol error');
                            break;
                        case 1003:
                            log('Unsupported data type');
                            break;
                        case 1006:
                            log('‚ùå ABNORMAL CLOSURE - This is the error we\'re investigating!', 'error');
                            log('Possible causes: Server error, network issue, or premature connection termination', 'error');
                            break;
                        case 1008:
                            log('Policy violation (often authentication related)', 'error');
                            break;
                        case 1011:
                            log('Server error', 'error');
                            break;
                        default:
                            if (event.code >= 4000) {
                                log(`Custom application error: ${event.code}`, 'error');
                            } else {
                                log(`Unknown close code: ${event.code}`, 'warn');
                            }
                    }
                };

                ws.onerror = function(event) {
                    log(`‚ùå WebSocket error occurred:`, 'error');
                    log(`ReadyState: ${ws.readyState}`, 'error');
                    log(`URL: ${ws.url}`, 'error');
                    log(`Event: ${JSON.stringify(event)}`, 'error');
                    updateStatus('Error', 'error');
                };

            } catch (error) {
                log(`Failed to create WebSocket: ${error.message}`, 'error');
                updateStatus('Failed to create connection', 'error');
            }
        }

        function disconnect() {
            if (ws) {
                log('Manually disconnecting WebSocket...');
                ws.close(1000, 'Manual disconnect');
                ws = null;
                updateStatus('Disconnected', 'disconnected');
            } else {
                log('No active connection to disconnect');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('WebSocket Diagnosis Tool loaded');
            useStoredToken(); // Try to load stored token
        });
    </script>
</body>
</html>