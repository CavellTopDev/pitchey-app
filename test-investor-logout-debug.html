<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investor Logout Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .credentials { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .step { margin: 15px 0; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Investor Logout Debug Test</h1>
        <p>This test will debug why investor logout is broken while other user types work fine.</p>
        
        <div class="credentials">
            <h3>üìã Test Credentials (Demo Accounts)</h3>
            <p><strong>Investor:</strong> sarah.investor@demo.com / Demo123</p>
            <p><strong>Creator:</strong> alex.creator@demo.com / Demo123</p>
            <p><strong>Production:</strong> stellar.production@demo.com / Demo123</p>
        </div>

        <!-- Server Health Check -->
        <div class="test-section">
            <h3>üîß Step 1: Server Health Check</h3>
            <div id="healthResult" class="test-result"></div>
            <button onclick="checkServerHealth()">Check Server Health</button>
        </div>

        <!-- User Type Login Tests -->
        <div class="test-section">
            <h3>üîê Step 2: Login All User Types</h3>
            <div id="loginResults"></div>
            <button onclick="testAllLogins()">Test All Logins</button>
        </div>

        <!-- Logout Backend Endpoint Test -->
        <div class="test-section">
            <h3>üö™ Step 3: Backend Logout Endpoint Test</h3>
            <div id="logoutEndpointResults"></div>
            <button onclick="testLogoutEndpoint()">Test Logout Endpoint</button>
        </div>

        <!-- Frontend Store Logout Test -->
        <div class="test-section">
            <h3>üñ•Ô∏è Step 4: Frontend Store Logout Test</h3>
            <div id="frontendLogoutResults"></div>
            <button onclick="testFrontendLogout()">Test Frontend Logout</button>
        </div>

        <!-- Storage Clearing Test -->
        <div class="test-section">
            <h3>üíæ Step 5: Storage Clearing Test</h3>
            <div id="storageResults"></div>
            <button onclick="testStorageClearing()">Test Storage Clearing</button>
        </div>

        <!-- Complete Logout Workflow -->
        <div class="test-section">
            <h3>üîÑ Step 6: Complete Logout Workflow Test</h3>
            <div id="workflowResults"></div>
            <button onclick="testCompleteWorkflow()">Test Complete Workflow</button>
        </div>

        <!-- Final Diagnosis -->
        <div class="test-section">
            <h3>ü©∫ Step 7: Diagnosis & Fix Recommendation</h3>
            <div id="diagnosisResults"></div>
            <button onclick="generateDiagnosis()">Generate Diagnosis</button>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:8001';
        let testResults = {};
        let authTokens = {};

        // Utility functions
        function log(message, type = 'info', containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = { text: await response.text() };
                }

                return {
                    success: response.ok,
                    status: response.status,
                    data,
                    headers: Object.fromEntries(response.headers.entries())
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message,
                    data: null
                };
            }
        }

        // Test Functions
        async function checkServerHealth() {
            clearResults('healthResult');
            log('üîç Checking server health...', 'info', 'healthResult');
            
            const result = await makeRequest(`${API_URL}/health`);
            if (result.success) {
                log('‚úÖ Server is healthy', 'success', 'healthResult');
                log(`<pre>${JSON.stringify(result.data, null, 2)}</pre>`, 'info', 'healthResult');
                testResults.serverHealth = 'healthy';
            } else {
                log(`‚ùå Server health check failed: ${result.error || result.data?.error || 'Unknown error'}`, 'error', 'healthResult');
                testResults.serverHealth = 'unhealthy';
            }
        }

        async function testAllLogins() {
            clearResults('loginResults');
            log('üîç Testing login for all user types...', 'info', 'loginResults');
            
            const credentials = {
                investor: { email: 'sarah.investor@demo.com', password: 'Demo123' },
                creator: { email: 'alex.creator@demo.com', password: 'Demo123' },
                production: { email: 'stellar.production@demo.com', password: 'Demo123' }
            };

            testResults.logins = {};
            authTokens = {};

            for (const [userType, creds] of Object.entries(credentials)) {
                log(`üîê Testing ${userType} login...`, 'info', 'loginResults');
                
                const result = await makeRequest(`${API_URL}/api/auth/${userType}/login`, {
                    method: 'POST',
                    body: JSON.stringify(creds)
                });

                if (result.success && result.data?.data?.token) {
                    const token = result.data.data.token;
                    authTokens[userType] = token;
                    testResults.logins[userType] = 'success';
                    log(`‚úÖ ${userType} login successful`, 'success', 'loginResults');
                    log(`Token: ${token.substring(0, 20)}...`, 'info', 'loginResults');
                } else if (result.success && result.data?.token) {
                    const token = result.data.token;
                    authTokens[userType] = token;
                    testResults.logins[userType] = 'success';
                    log(`‚úÖ ${userType} login successful (alternate format)`, 'success', 'loginResults');
                    log(`Token: ${token.substring(0, 20)}...`, 'info', 'loginResults');
                } else {
                    testResults.logins[userType] = 'failed';
                    log(`‚ùå ${userType} login failed: ${result.error || JSON.stringify(result.data)}`, 'error', 'loginResults');
                }
            }
        }

        async function testLogoutEndpoint() {
            clearResults('logoutEndpointResults');
            log('üîç Testing logout endpoint for all user types...', 'info', 'logoutEndpointResults');
            
            testResults.logoutEndpoint = {};

            for (const [userType, token] of Object.entries(authTokens)) {
                if (!token) {
                    log(`‚ö†Ô∏è No token available for ${userType}, skipping logout test`, 'warning', 'logoutEndpointResults');
                    continue;
                }

                log(`üö™ Testing logout for ${userType}...`, 'info', 'logoutEndpointResults');
                
                const result = await makeRequest(`${API_URL}/api/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({})
                });

                if (result.success) {
                    testResults.logoutEndpoint[userType] = 'success';
                    log(`‚úÖ ${userType} logout endpoint successful`, 'success', 'logoutEndpointResults');
                    log(`<pre>${JSON.stringify(result.data, null, 2)}</pre>`, 'info', 'logoutEndpointResults');
                } else {
                    testResults.logoutEndpoint[userType] = 'failed';
                    log(`‚ùå ${userType} logout endpoint failed: ${result.error || JSON.stringify(result.data)}`, 'error', 'logoutEndpointResults');
                    log(`Status: ${result.status}`, 'error', 'logoutEndpointResults');
                }
            }
        }

        async function testFrontendLogout() {
            clearResults('frontendLogoutResults');
            log('üîç Testing frontend logout store behavior...', 'info', 'frontendLogoutResults');
            
            // Test localStorage manipulation
            log('üíæ Testing localStorage behavior...', 'info', 'frontendLogoutResults');
            
            // Simulate what the frontend stores
            localStorage.setItem('authToken', 'test-token-123');
            localStorage.setItem('user', JSON.stringify({id: 1, userType: 'investor'}));
            localStorage.setItem('userType', 'investor');
            localStorage.setItem('pitchey:localhost:8001:authToken', 'test-namespaced-token');
            localStorage.setItem('pitchey:localhost:8001:user', JSON.stringify({id: 1, userType: 'investor'}));
            localStorage.setItem('pitchey:localhost:8001:userType', 'investor');
            
            log('‚úÖ Set test localStorage items', 'success', 'frontendLogoutResults');
            
            // Test clearing behavior
            const removeItem = (key) => {
                const nsKey = `pitchey:${new URL('http://localhost:8001').host}:${key}`;
                localStorage.removeItem(nsKey);
                localStorage.removeItem(key);
            };
            
            removeItem('authToken');
            removeItem('user');
            removeItem('userType');
            
            log('üßπ Simulated frontend logout clearing', 'info', 'frontendLogoutResults');
            
            // Check if items were cleared
            const authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            const userType = localStorage.getItem('userType');
            
            if (!authToken && !user && !userType) {
                log('‚úÖ localStorage properly cleared', 'success', 'frontendLogoutResults');
                testResults.frontendLogout = 'success';
            } else {
                log('‚ùå localStorage not properly cleared', 'error', 'frontendLogoutResults');
                log(`Remaining items: authToken=${authToken}, user=${user}, userType=${userType}`, 'error', 'frontendLogoutResults');
                testResults.frontendLogout = 'failed';
            }
        }

        async function testStorageClearing() {
            clearResults('storageResults');
            log('üîç Testing storage clearing mechanisms...', 'info', 'storageResults');
            
            // Test different storage scenarios
            const storageTests = [
                {
                    name: 'Basic localStorage',
                    setup: () => {
                        localStorage.setItem('authToken', 'test123');
                        localStorage.setItem('user', '{"id":1}');
                    },
                    clear: () => {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('user');
                    }
                },
                {
                    name: 'Namespaced localStorage',
                    setup: () => {
                        localStorage.setItem('pitchey:localhost:8001:authToken', 'test123');
                        localStorage.setItem('pitchey:localhost:8001:user', '{"id":1}');
                    },
                    clear: () => {
                        localStorage.removeItem('pitchey:localhost:8001:authToken');
                        localStorage.removeItem('pitchey:localhost:8001:user');
                    }
                },
                {
                    name: 'SessionStorage',
                    setup: () => {
                        sessionStorage.setItem('authToken', 'test123');
                        sessionStorage.setItem('user', '{"id":1}');
                    },
                    clear: () => {
                        sessionStorage.clear();
                    }
                }
            ];

            testResults.storageClearing = {};

            for (const test of storageTests) {
                log(`üß™ Testing ${test.name}...`, 'info', 'storageResults');
                
                // Setup
                test.setup();
                
                // Clear
                test.clear();
                
                // Check if cleared
                const authToken = localStorage.getItem('authToken') || 
                                  localStorage.getItem('pitchey:localhost:8001:authToken') ||
                                  sessionStorage.getItem('authToken');
                
                if (!authToken) {
                    log(`‚úÖ ${test.name} clearing works`, 'success', 'storageResults');
                    testResults.storageClearing[test.name] = 'success';
                } else {
                    log(`‚ùå ${test.name} clearing failed: ${authToken}`, 'error', 'storageResults');
                    testResults.storageClearing[test.name] = 'failed';
                }
            }
        }

        async function testCompleteWorkflow() {
            clearResults('workflowResults');
            log('üîç Testing complete logout workflow for investor...', 'info', 'workflowResults');
            
            // Step 1: Login as investor
            log('üîê Step 1: Login as investor...', 'info', 'workflowResults');
            const loginResult = await makeRequest(`${API_URL}/api/auth/investor/login`, {
                method: 'POST',
                body: JSON.stringify({
                    email: 'sarah.investor@demo.com',
                    password: 'Demo123'
                })
            });

            if (!loginResult.success) {
                log(`‚ùå Investor login failed: ${loginResult.error}`, 'error', 'workflowResults');
                return;
            }

            const token = loginResult.data?.data?.token || loginResult.data?.token;
            if (!token) {
                log(`‚ùå No token received from login`, 'error', 'workflowResults');
                return;
            }

            log('‚úÖ Investor login successful', 'success', 'workflowResults');

            // Step 2: Store auth data (simulate frontend)
            localStorage.setItem('authToken', token);
            localStorage.setItem('user', JSON.stringify(loginResult.data.data?.user || loginResult.data.user));
            localStorage.setItem('userType', 'investor');
            
            log('‚úÖ Auth data stored in localStorage', 'success', 'workflowResults');

            // Step 3: Test logout endpoint
            log('üö™ Step 2: Call logout endpoint...', 'info', 'workflowResults');
            const logoutResult = await makeRequest(`${API_URL}/api/auth/logout`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({})
            });

            if (logoutResult.success) {
                log('‚úÖ Logout endpoint responded successfully', 'success', 'workflowResults');
                log(`Response: ${JSON.stringify(logoutResult.data)}`, 'info', 'workflowResults');
            } else {
                log(`‚ùå Logout endpoint failed: ${logoutResult.error}`, 'error', 'workflowResults');
                log(`Status: ${logoutResult.status}`, 'error', 'workflowResults');
            }

            // Step 4: Clear storage (simulate frontend cleanup)
            log('üßπ Step 3: Clear localStorage...', 'info', 'workflowResults');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            localStorage.removeItem('userType');

            // Step 5: Verify token is invalid
            log('üîç Step 4: Verify token is invalidated...', 'info', 'workflowResults');
            const verifyResult = await makeRequest(`${API_URL}/api/profile`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!verifyResult.success) {
                log('‚úÖ Token properly invalidated', 'success', 'workflowResults');
                testResults.completeWorkflow = 'success';
            } else {
                log('‚ùå Token still valid after logout', 'error', 'workflowResults');
                testResults.completeWorkflow = 'failed';
            }
        }

        function generateDiagnosis() {
            clearResults('diagnosisResults');
            log('ü©∫ Analyzing test results...', 'info', 'diagnosisResults');
            
            const issues = [];
            const fixes = [];

            // Check server health
            if (testResults.serverHealth !== 'healthy') {
                issues.push('Server is not responding or unhealthy');
                fixes.push('Start the backend server: PORT=8001 deno run --allow-all working-server.ts');
            }

            // Check login functionality
            const failedLogins = Object.entries(testResults.logins || {})
                .filter(([type, result]) => result === 'failed')
                .map(([type]) => type);
            
            if (failedLogins.length > 0) {
                issues.push(`Login failed for: ${failedLogins.join(', ')}`);
                fixes.push('Check database connection and demo account existence');
            }

            // Check logout endpoint
            const failedLogouts = Object.entries(testResults.logoutEndpoint || {})
                .filter(([type, result]) => result === 'failed')
                .map(([type]) => type);
            
            if (failedLogouts.includes('investor')) {
                issues.push('Investor logout endpoint specifically failing');
                fixes.push('Debug investor-specific logout implementation in working-server.ts');
            }

            // Check storage clearing
            if (testResults.frontendLogout === 'failed') {
                issues.push('Frontend storage clearing not working properly');
                fixes.push('Fix localStorage clearing logic in frontend auth store');
            }

            // Display results
            if (issues.length === 0) {
                log('‚úÖ No issues detected! Logout should be working properly.', 'success', 'diagnosisResults');
            } else {
                log('‚ùå Issues detected:', 'error', 'diagnosisResults');
                issues.forEach(issue => {
                    log(`‚Ä¢ ${issue}`, 'error', 'diagnosisResults');
                });
                
                log('üîß Recommended fixes:', 'warning', 'diagnosisResults');
                fixes.forEach(fix => {
                    log(`‚Ä¢ ${fix}`, 'warning', 'diagnosisResults');
                });
            }

            // Show detailed test summary
            log('<h4>üìä Test Summary:</h4>', 'info', 'diagnosisResults');
            log(`<pre>${JSON.stringify(testResults, null, 2)}</pre>`, 'info', 'diagnosisResults');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Investor Logout Debug Test Ready', 'success', 'healthResult');
            log('Click "Check Server Health" to begin testing.', 'info', 'healthResult');
        });
    </script>
</body>
</html>