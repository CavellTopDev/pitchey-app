name = "pitchey-api"
main = "src/worker-simple.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# Cloudflare Pages config for static deployments
pages_build_output_dir = "frontend/dist"

[vars]
# Used for CORS and redirects
FRONTEND_URL = "https://pitchey.pages.dev"

# Set secrets with: wrangler secret put JWT_SECRET
# JWT_SECRET is read from environment secrets at deploy time

# Progressive migration: proxy unmatched API routes to existing Deno backend
ORIGIN_URL = "https://pitchey-backend-fresh.deno.dev"

[[kv_namespaces]]
binding = "CACHE"
id = "98c88a185eb448e4868fcc87e458b3ac"

[[r2_buckets]]
binding = "R2_BUCKET"
# Replace with your R2 bucket name: wrangler r2 bucket create pitchey-uploads
bucket_name = "pitchey-uploads"

[[durable_objects.bindings]]
name = "WEBSOCKET_ROOM"
class_name = "WebSocketRoom"

# Database Configuration - Hyperdrive for Neon PostgreSQL
[[hyperdrive]]
binding = "HYPERDRIVE"
# Run ./hyperdrive-setup.sh to get your Hyperdrive ID
# Then replace this with the actual ID from the setup script
id = "983d4a1818264b5dbdca26bacf167dee"

# 2) D1 (SQLite at the edge)
# [[d1_databases]]
# binding = "DB"
# database_name = "pitchey-db"
# database_id = "REPLACE_WITH_D1_ID"

[env.production]
# Production-only vars; secrets still come from GitHub Actions or wrangler secrets
[env.production.vars]
FRONTEND_URL = "https://pitchey.pages.dev"
ORIGIN_URL = "https://pitchey-backend-fresh.deno.dev"

# Re-declare bindings for the production environment (not inherited)
[[env.production.kv_namespaces]]
binding = "CACHE"
id = "98c88a185eb448e4868fcc87e458b3ac"

[[env.production.r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "pitchey-uploads"

[[env.production.durable_objects.bindings]]
name = "WEBSOCKET_ROOM"
class_name = "WebSocketRoom"

# Production Hyperdrive binding
[[env.production.hyperdrive]]
binding = "HYPERDRIVE"
# Same ID as development - Hyperdrive handles environment separation
id = "983d4a1818264b5dbdca26bacf167dee"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["WebSocketRoom"]
