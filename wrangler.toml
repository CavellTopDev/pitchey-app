# =====================================================
# Pitchey Production Configuration with Container Services
# Integrated deployment for existing production URLs
# =====================================================

# ===== MAIN WORKER CONFIGURATION =====
name = "pitchey-api-prod"
main = "src/worker-integrated.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat", "experimental"]
account_id = "02967e39e44b6266e7873829e94849f5"

# Production domain routing (existing URLs)
routes = [
  { pattern = "pitchey-api-prod.ndlovucavelle.workers.dev/*", custom_domain = true }
]

# ===== CONTAINER SERVICES INTEGRATION =====
# Note: Container endpoints will be available at:
# https://pitchey-api-prod.ndlovucavelle.workers.dev/api/containers/*

# ===== DURABLE OBJECTS =====
[[durable_objects.bindings]]
name = "NOTIFICATION_HUB"
class_name = "NotificationHub"

[[durable_objects.bindings]]
name = "WEBSOCKET_ROOMS"
class_name = "WebSocketRoom"

[[durable_objects.bindings]]
name = "CONTAINER_ORCHESTRATOR"
class_name = "ContainerOrchestrator"

[[durable_objects.bindings]]
name = "JOB_SCHEDULER"
class_name = "JobScheduler"

[[migrations]]
tag = "v3"
new_classes = ["NotificationHub", "WebSocketRoom", "ContainerOrchestrator", "JobScheduler"]

# ===== R2 STORAGE =====
[[r2_buckets]]
binding = "PITCH_STORAGE"
bucket_name = "pitchey-pitches"

[[r2_buckets]]
binding = "NDA_STORAGE"
bucket_name = "pitchey-ndas"

[[r2_buckets]]
binding = "MEDIA_STORAGE"
bucket_name = "pitchey-media"

[[r2_buckets]]
binding = "PROCESSED_STORAGE"
bucket_name = "pitchey-processed"

[[r2_buckets]]
binding = "TEMP_STORAGE"
bucket_name = "pitchey-temp"

# ===== KV NAMESPACES =====
[[kv_namespaces]]
binding = "CACHE"
id = "cache_namespace_prod"

[[kv_namespaces]]
binding = "SESSION_STORE"
id = "session_namespace_prod"

[[kv_namespaces]]
binding = "RATE_LIMITER"
id = "rate_limiter_namespace_prod"

[[kv_namespaces]]
binding = "JOB_STATUS"
id = "job_status_namespace_prod"

[[kv_namespaces]]
binding = "CONTAINER_METRICS"
id = "container_metrics_namespace_prod"

# ===== QUEUES FOR CONTAINER PROCESSING =====
[[queues.producers]]
binding = "VIDEO_PROCESSING_QUEUE"
queue = "pitchey-video-processing"

[[queues.producers]]
binding = "DOCUMENT_PROCESSING_QUEUE"
queue = "pitchey-document-processing"

[[queues.producers]]
binding = "AI_INFERENCE_QUEUE"
queue = "pitchey-ai-inference"

[[queues.producers]]
binding = "MEDIA_TRANSCODING_QUEUE"
queue = "pitchey-media-transcoding"

[[queues.producers]]
binding = "CODE_EXECUTION_QUEUE"
queue = "pitchey-code-execution"

[[queues.consumers]]
queue = "pitchey-video-processing"
max_batch_size = 5
max_batch_timeout = 300
max_retries = 3
dead_letter_queue = "pitchey-video-dlq"

[[queues.consumers]]
queue = "pitchey-document-processing"
max_batch_size = 10
max_batch_timeout = 60
max_retries = 3
dead_letter_queue = "pitchey-document-dlq"

[[queues.consumers]]
queue = "pitchey-ai-inference"
max_batch_size = 8
max_batch_timeout = 180
max_retries = 2
dead_letter_queue = "pitchey-ai-dlq"

[[queues.consumers]]
queue = "pitchey-media-transcoding"
max_batch_size = 3
max_batch_timeout = 600
max_retries = 3
dead_letter_queue = "pitchey-media-dlq"

[[queues.consumers]]
queue = "pitchey-code-execution"
max_batch_size = 20
max_batch_timeout = 30
max_retries = 1
dead_letter_queue = "pitchey-code-dlq"

# ===== ANALYTICS ENGINE =====
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "pitchey_metrics"

[[analytics_engine_datasets]]
binding = "CONTAINER_ANALYTICS"
dataset = "pitchey_container_metrics"

[[analytics_engine_datasets]]
binding = "JOB_ANALYTICS"
dataset = "pitchey_job_analytics"

# ===== CRON TRIGGERS =====
[triggers]
crons = [
  "*/5 * * * *",    # Every 5 min: Check NDA expirations
  "*/5 * * * *",    # Every 5 min: Container health checks
  "*/10 * * * *",   # Every 10 min: Job queue monitoring
  "0 * * * *",      # Hourly: Send digest emails
  "0 * * * *",      # Hourly: Container metrics aggregation
  "0 0 * * *",      # Daily: Export audit logs
  "0 0 * * *",      # Daily: Archive completed jobs
  "0 2 * * 0",      # Weekly: Database cleanup
  "*/15 * * * *"    # Every 15 min: Update trending algorithm
]

# ===== ENVIRONMENT VARIABLES =====
[vars]
# Platform Configuration
FRONTEND_URL = "https://pitchey-5o8-66n.pages.dev"
BACKEND_URL = "https://pitchey-api-prod.ndlovucavelle.workers.dev"
ENVIRONMENT = "production"
VERSION = "2.0-integrated"

# Container Service Configuration
ENABLE_CONTAINERS = "true"
CONTAINER_ORCHESTRATION = "true"
CONTAINER_AUTO_SCALING = "true"
CONTAINER_HEALTH_MONITORING = "true"

# Processing Limits
MAX_VIDEO_PROCESSING_TIME = "1800"
MAX_DOCUMENT_PROCESSING_TIME = "300"
MAX_AI_INFERENCE_TIME = "120"
MAX_CODE_EXECUTION_TIME = "30"

# Feature Flags
ENABLE_DURABLE_OBJECTS = "true"
ENABLE_WEBSOCKETS = "true"
ENABLE_QUEUES = "true"
ENABLE_ANALYTICS = "true"
MAX_WEBSOCKET_CONNECTIONS = "100000"
CACHE_TTL = "300"

# Security Configuration
RATE_LIMITING_ENABLED = "true"
REQUEST_TIMEOUT_MS = "30000"
SANDBOX_EXECUTION = "true"

# Legacy Compatibility
REDIS_CACHE_ENABLED = "true"
ENABLE_EDGE_CACHING = "true"

# Build Configuration
[build]
command = "npm run build"
[build.upload]
format = "service-worker"