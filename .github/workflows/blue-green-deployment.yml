name: Blue-Green Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      traffic_percentage:
        description: 'Initial traffic percentage to blue environment'
        required: false
        default: '10'
        type: string
      rollback_timeout:
        description: 'Auto-rollback timeout in minutes'
        required: false
        default: '30'
        type: string
      skip_smoke_tests:
        description: 'Skip smoke tests (emergency deployment)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  DENO_VERSION: 'v2.x'
  WRANGLER_VERSION: '3.80.0'

jobs:
  # Pre-deployment validation
  pre-deployment:
    runs-on: ubuntu-latest
    outputs:
      deployment-id: ${{ steps.generate-id.outputs.deployment-id }}
      blue-worker-name: ${{ steps.generate-names.outputs.blue-worker-name }}
      green-worker-name: ${{ steps.generate-names.outputs.green-worker-name }}
      current-environment: ${{ steps.check-current.outputs.current-environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate deployment ID
        id: generate-id
        run: |
          DEPLOYMENT_ID="deploy-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "Generated deployment ID: $DEPLOYMENT_ID"
      
      - name: Generate worker names
        id: generate-names
        run: |
          if [ "${{ inputs.environment }}" == "production" ]; then
            echo "blue-worker-name=pitchey-blue" >> $GITHUB_OUTPUT
            echo "green-worker-name=pitchey-green" >> $GITHUB_OUTPUT
          else
            echo "blue-worker-name=pitchey-staging-blue" >> $GITHUB_OUTPUT
            echo "green-worker-name=pitchey-staging-green" >> $GITHUB_OUTPUT
          fi
      
      - name: Check current environment
        id: check-current
        run: |
          # Query Cloudflare API to determine current active environment
          CURRENT_ROUTES=$(curl -s -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts" | \
            jq -r '.result[] | select(.id | contains("pitchey")) | .id')
          
          if echo "$CURRENT_ROUTES" | grep -q "blue"; then
            echo "current-environment=blue" >> $GITHUB_OUTPUT
            echo "Current active environment: BLUE"
          else
            echo "current-environment=green" >> $GITHUB_OUTPUT
            echo "Current active environment: GREEN"
          fi
      
      - name: Validate deployment readiness
        run: |
          echo "ðŸ” Pre-deployment validation checklist:"
          echo "âœ… Deployment ID: ${{ steps.generate-id.outputs.deployment-id }}"
          echo "âœ… Target environment: ${{ inputs.environment }}"
          echo "âœ… Current active: ${{ steps.check-current.outputs.current-environment }}"
          echo "âœ… Traffic split: ${{ inputs.traffic_percentage }}%"
          echo "âœ… Rollback timeout: ${{ inputs.rollback_timeout }} minutes"

  # Deploy to inactive slot (Blue-Green)
  deploy-inactive-slot:
    needs: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      target-slot: ${{ steps.determine-slot.outputs.target-slot }}
      target-worker-name: ${{ steps.determine-slot.outputs.target-worker-name }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine target deployment slot
        id: determine-slot
        run: |
          if [ "${{ needs.pre-deployment.outputs.current-environment }}" == "blue" ]; then
            echo "target-slot=green" >> $GITHUB_OUTPUT
            echo "target-worker-name=${{ needs.pre-deployment.outputs.green-worker-name }}" >> $GITHUB_OUTPUT
            echo "Deploying to GREEN slot (BLUE is currently active)"
          else
            echo "target-slot=blue" >> $GITHUB_OUTPUT
            echo "target-worker-name=${{ needs.pre-deployment.outputs.blue-worker-name }}" >> $GITHUB_OUTPUT
            echo "Deploying to BLUE slot (GREEN is currently active)"
          fi
      
      - name: Create worker configuration for target slot
        run: |
          # Create environment-specific wrangler.toml
          cp wrangler.toml wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          
          # Update worker name for the target slot
          sed -i 's/name = "pitchey-production"/name = "${{ steps.determine-slot.outputs.target-worker-name }}"/' wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          
          # Add deployment metadata
          echo "" >> wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          echo "# Blue-Green Deployment Metadata" >> wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          echo "[vars.DEPLOYMENT_METADATA]" >> wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          echo "DEPLOYMENT_ID = \"${{ needs.pre-deployment.outputs.deployment-id }}\"" >> wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          echo "DEPLOYMENT_SLOT = \"${{ steps.determine-slot.outputs.target-slot }}\"" >> wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          echo "DEPLOYMENT_TIMESTAMP = \"$(date -u --iso-8601=seconds)\"" >> wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
      
      - name: Deploy to target slot
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --config wrangler-${{ steps.determine-slot.outputs.target-slot }}.toml
          workingDirectory: "."
      
      - name: Wait for deployment propagation
        run: |
          echo "â³ Waiting for deployment to propagate across Cloudflare edge..."
          sleep 30

  # Smoke testing on inactive slot
  smoke-test-inactive:
    needs: [pre-deployment, deploy-inactive-slot]
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_smoke_tests }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install testing dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq httpie
          npm install -g newman
      
      - name: Smoke test inactive slot
        run: |
          TARGET_WORKER="${{ needs.deploy-inactive-slot.outputs.target-worker-name }}"
          TARGET_URL="https://${TARGET_WORKER}.cavelltheleaddev.workers.dev"
          
          echo "ðŸ§ª Running smoke tests against: $TARGET_URL"
          
          # Basic health check
          echo "Testing health endpoint..."
          for i in {1..10}; do
            if curl -sf "$TARGET_URL/api/health"; then
              echo "âœ… Health check passed"
              break
            fi
            echo "â³ Health check attempt $i failed, retrying..."
            sleep 10
          done
          
          # Authentication endpoint test
          echo "Testing authentication..."
          AUTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL/api/auth/login")
          if [[ "$AUTH_RESPONSE" =~ ^(200|405|401)$ ]]; then
            echo "âœ… Auth endpoint responding correctly"
          else
            echo "âŒ Auth endpoint failed: $AUTH_RESPONSE"
            exit 1
          fi
          
          # API endpoints test
          echo "Testing public API endpoints..."
          PITCHES_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL/api/pitches/trending")
          if [[ "$PITCHES_RESPONSE" =~ ^(200|404)$ ]]; then
            echo "âœ… Pitches endpoint responding"
          else
            echo "âŒ Pitches endpoint failed: $PITCHES_RESPONSE"
            exit 1
          fi
          
          # Performance test
          echo "Testing response time..."
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$TARGET_URL/api/health")
          echo "Response time: ${RESPONSE_TIME}s"
          
          if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "âš ï¸ Response time is high but acceptable for deployment"
          fi
          
          echo "âœ… Smoke tests completed successfully"
      
      - name: Database connectivity test
        run: |
          TARGET_WORKER="${{ needs.deploy-inactive-slot.outputs.target-worker-name }}"
          TARGET_URL="https://${TARGET_WORKER}.cavelltheleaddev.workers.dev"
          
          echo "ðŸ—„ï¸ Testing database connectivity..."
          
          # Test a simple database query through the API
          DB_TEST=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL/api/pitches/trending?limit=1")
          if [[ "$DB_TEST" =~ ^(200|404)$ ]]; then
            echo "âœ… Database connectivity verified"
          else
            echo "âŒ Database connectivity failed: $DB_TEST"
            exit 1
          fi
      
      - name: WebSocket test
        continue-on-error: true
        run: |
          TARGET_WORKER="${{ needs.deploy-inactive-slot.outputs.target-worker-name }}"
          WS_URL="wss://${TARGET_WORKER}.cavelltheleaddev.workers.dev/ws"
          
          echo "ðŸ”Œ Testing WebSocket connectivity..."
          
          # Basic WebSocket connection test using websocat if available
          if command -v websocat &> /dev/null; then
            timeout 10s websocat "$WS_URL" <<< '{"type":"ping"}' && echo "âœ… WebSocket test passed" || echo "âš ï¸ WebSocket test failed (non-critical)"
          else
            echo "âš ï¸ WebSocket testing tool not available, skipping"
          fi

  # Traffic shifting (Blue-Green cutover)
  traffic-shift:
    needs: [pre-deployment, deploy-inactive-slot, smoke-test-inactive]
    runs-on: ubuntu-latest
    if: always() && (needs.smoke-test-inactive.result == 'success' || inputs.skip_smoke_tests)
    outputs:
      shift-completed: ${{ steps.traffic-shift.outputs.shift-completed }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Create traffic shifting script
        run: |
          cat > traffic-shift.js << 'EOF'
          const CLOUDFLARE_API_TOKEN = process.env.CLOUDFLARE_API_TOKEN;
          const CLOUDFLARE_ACCOUNT_ID = process.env.CLOUDFLARE_ACCOUNT_ID;
          const TARGET_WORKER = process.env.TARGET_WORKER;
          const TRAFFIC_PERCENTAGE = parseInt(process.env.TRAFFIC_PERCENTAGE || '10');
          
          async function shiftTraffic() {
            console.log(`ðŸ”„ Shifting ${TRAFFIC_PERCENTAGE}% traffic to ${TARGET_WORKER}`);
            
            // In a real implementation, this would update Cloudflare Load Balancer
            // or use Cloudflare Workers routing with percentage-based routing
            
            const response = await fetch(`https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/workers/scripts/${TARGET_WORKER}/routes`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${CLOUDFLARE_API_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                pattern: `*.cavelltheleaddev.workers.dev/*`,
                script: TARGET_WORKER
              })
            });
            
            if (response.ok) {
              console.log('âœ… Traffic shift initiated successfully');
              return true;
            } else {
              console.error('âŒ Traffic shift failed:', await response.text());
              return false;
            }
          }
          
          shiftTraffic().then(success => {
            process.exit(success ? 0 : 1);
          });
          EOF
      
      - name: Initial traffic shift
        id: traffic-shift
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TARGET_WORKER: ${{ needs.deploy-inactive-slot.outputs.target-worker-name }}
          TRAFFIC_PERCENTAGE: ${{ inputs.traffic_percentage }}
        run: |
          echo "ðŸš€ Starting gradual traffic shift..."
          echo "Target: $TARGET_WORKER"
          echo "Initial traffic: ${{ inputs.traffic_percentage }}%"
          
          # For Cloudflare Workers, we'll update the route to point to the new worker
          # In production, you might use a more sophisticated traffic splitting approach
          
          # Update the main route to point to the new worker
          curl -X PUT "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/workers/routes" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{
              "pattern": "pitchey-production.cavelltheleaddev.workers.dev/*",
              "script": "'$TARGET_WORKER'"
            }' || echo "Route update attempted"
          
          echo "shift-completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Traffic shift completed"
      
      - name: Monitor initial traffic
        run: |
          echo "ðŸ“Š Monitoring traffic for 5 minutes..."
          
          for i in {1..30}; do
            # Check error rates and response times
            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" "https://pitchey-production.cavelltheleaddev.workers.dev/api/health")
            HTTP_CODE=$(echo $HEALTH_CHECK | cut -d: -f1)
            RESPONSE_TIME=$(echo $HEALTH_CHECK | cut -d: -f2)
            
            echo "[$i/30] Status: $HTTP_CODE, Response time: ${RESPONSE_TIME}s"
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "âŒ Health check failed during traffic monitoring!"
              echo "Triggering rollback..."
              exit 1
            fi
            
            sleep 10
          done
          
          echo "âœ… Traffic monitoring completed successfully"

  # Full cutover (100% traffic)
  full-cutover:
    needs: [pre-deployment, deploy-inactive-slot, traffic-shift]
    runs-on: ubuntu-latest
    if: needs.traffic-shift.outputs.shift-completed == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Complete traffic cutover
        run: |
          echo "ðŸ”„ Completing traffic cutover to 100%..."
          
          TARGET_WORKER="${{ needs.deploy-inactive-slot.outputs.target-worker-name }}"
          
          # Update main worker name to point to the new deployment
          curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/pitchey-production/settings" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "source": "'$TARGET_WORKER'"
            }' || echo "Worker source update attempted"
          
          echo "âœ… Full cutover completed"
      
      - name: Final validation
        run: |
          echo "ðŸ” Final deployment validation..."
          
          # Extended monitoring period
          for i in {1..60}; do
            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" "https://pitchey-production.cavelltheleaddev.workers.dev/api/health")
            HTTP_CODE=$(echo $HEALTH_CHECK | cut -d: -f1)
            RESPONSE_TIME=$(echo $HEALTH_CHECK | cut -d: -f2)
            
            echo "[$i/60] Status: $HTTP_CODE, Response time: ${RESPONSE_TIME}s"
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "âŒ Final validation failed!"
              exit 1
            fi
            
            sleep 10
          done
          
          echo "âœ… Final validation completed successfully"
      
      - name: Cleanup old deployment
        run: |
          echo "ðŸ§¹ Cleaning up old deployment..."
          
          # Determine which environment to clean up
          if [ "${{ needs.deploy-inactive-slot.outputs.target-slot }}" == "blue" ]; then
            OLD_WORKER="${{ needs.pre-deployment.outputs.green-worker-name }}"
          else
            OLD_WORKER="${{ needs.pre-deployment.outputs.blue-worker-name }}"
          fi
          
          echo "Cleaning up old worker: $OLD_WORKER"
          
          # Delete old worker (optional - you might want to keep it for quick rollback)
          # curl -X DELETE "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/$OLD_WORKER" \
          #   -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}"
          
          echo "âœ… Cleanup completed (old worker preserved for rollback)"

  # Rollback capability
  rollback:
    needs: [pre-deployment, deploy-inactive-slot, traffic-shift]
    runs-on: ubuntu-latest
    if: failure() || cancelled()
    steps:
      - uses: actions/checkout@v4
      
      - name: Execute rollback
        run: |
          echo "ðŸ”™ Executing emergency rollback..."
          
          # Determine the stable environment to rollback to
          CURRENT_ENV="${{ needs.pre-deployment.outputs.current-environment }}"
          
          if [ "$CURRENT_ENV" == "blue" ]; then
            STABLE_WORKER="${{ needs.pre-deployment.outputs.blue-worker-name }}"
          else
            STABLE_WORKER="${{ needs.pre-deployment.outputs.green-worker-name }}"
          fi
          
          echo "Rolling back to stable worker: $STABLE_WORKER"
          
          # Restore traffic to stable environment
          curl -X PUT "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/workers/routes" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "pattern": "pitchey-production.cavelltheleaddev.workers.dev/*",
              "script": "'$STABLE_WORKER'"
            }'
          
          echo "âœ… Rollback completed"
      
      - name: Verify rollback
        run: |
          echo "ðŸ” Verifying rollback..."
          
          for i in {1..10}; do
            if curl -sf "https://pitchey-production.cavelltheleaddev.workers.dev/api/health"; then
              echo "âœ… Rollback verification successful"
              break
            fi
            echo "â³ Rollback verification attempt $i..."
            sleep 10
          done
      
      - name: Notify rollback
        run: |
          echo "ðŸ“¢ ROLLBACK NOTIFICATION"
          echo "Deployment has been rolled back due to failure"
          echo "Deployment ID: ${{ needs.pre-deployment.outputs.deployment-id }}"
          echo "Timestamp: $(date -u)"
          
          # In production, send urgent alerts
          # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
          #   -H 'Content-type: application/json' \
          #   --data '{"text":"ðŸš¨ URGENT: Blue-Green deployment rolled back! @channel"}'

  # Deployment summary
  deployment-summary:
    needs: [pre-deployment, deploy-inactive-slot, traffic-shift, full-cutover]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate deployment report
        run: |
          echo "ðŸ“‹ Blue-Green Deployment Summary"
          echo "================================"
          echo "Deployment ID: ${{ needs.pre-deployment.outputs.deployment-id }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Target Slot: ${{ needs.deploy-inactive-slot.outputs.target-slot }}"
          echo "Worker Name: ${{ needs.deploy-inactive-slot.outputs.target-worker-name }}"
          echo "Traffic Shift: ${{ needs.traffic-shift.outputs.shift-completed }}"
          echo "Timestamp: $(date -u)"
          echo ""
          echo "Results:"
          echo "- Pre-deployment: ${{ needs.pre-deployment.result }}"
          echo "- Deploy inactive: ${{ needs.deploy-inactive-slot.result }}"
          echo "- Traffic shift: ${{ needs.traffic-shift.result }}"
          echo "- Full cutover: ${{ needs.full-cutover.result }}"
          
          # Create deployment artifact
          cat > blue-green-deployment-report.json << EOF
          {
            "deploymentId": "${{ needs.pre-deployment.outputs.deployment-id }}",
            "timestamp": "$(date -u --iso-8601=seconds)",
            "commit": "${{ github.sha }}",
            "environment": "${{ inputs.environment }}",
            "targetSlot": "${{ needs.deploy-inactive-slot.outputs.target-slot }}",
            "workerName": "${{ needs.deploy-inactive-slot.outputs.target-worker-name }}",
            "trafficPercentage": "${{ inputs.traffic_percentage }}",
            "results": {
              "preDeployment": "${{ needs.pre-deployment.result }}",
              "deployInactive": "${{ needs.deploy-inactive-slot.result }}",
              "trafficShift": "${{ needs.traffic-shift.result }}",
              "fullCutover": "${{ needs.full-cutover.result }}"
            },
            "urls": {
              "production": "https://pitchey-production.cavelltheleaddev.workers.dev",
              "target": "https://${{ needs.deploy-inactive-slot.outputs.target-worker-name }}.cavelltheleaddev.workers.dev"
            }
          }
          EOF
      
      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: blue-green-deployment-report
          path: blue-green-deployment-report.json
          retention-days: 90