name: Advanced Secret Rotation Pipeline

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      rotation_type:
        description: 'Type of secret rotation'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - database
          - jwt
          - api-keys
          - certificates

env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_NAMESPACE: production

permissions:
  id-token: write
  contents: read

jobs:
  pre-rotation-validation:
    runs-on: ubuntu-latest
    outputs:
      rotation_plan: ${{ steps.plan.outputs.plan }}
      backup_id: ${{ steps.backup.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SecretRotation
          aws-region: us-east-1
          
      - name: Authenticate to Vault using GitHub OIDC
        id: vault-auth
        run: |
          # Get GitHub OIDC token
          GITHUB_TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=vault-production" | jq -r '.value')
          
          # Authenticate to Vault
          VAULT_TOKEN=$(vault write -field=token auth/jwt/login \
            role=github-actions \
            jwt=$GITHUB_TOKEN)
          
          echo "::add-mask::$VAULT_TOKEN"
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
          
          # Verify authentication
          vault token lookup
          
      - name: Create rotation plan
        id: plan
        run: |
          cat > rotation-plan.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "rotation_type": "${{ github.event.inputs.rotation_type || 'all' }}",
            "services": {
              "database": {
                "current_version": "$(vault kv get -field=version secret/database/credentials)",
                "rotation_method": "blue-green",
                "rollback_window": "15m"
              },
              "jwt": {
                "current_kid": "$(vault kv get -field=kid secret/jwt/keys)",
                "rotation_method": "key-rotation",
                "grace_period": "24h"
              },
              "api_keys": {
                "services": ["cloudflare", "neon", "upstash"],
                "rotation_method": "rolling-update"
              }
            }
          }
          EOF
          
          echo "plan=$(cat rotation-plan.json | base64 -w0)" >> $GITHUB_OUTPUT
          
      - name: Backup current secrets
        id: backup
        run: |
          BACKUP_ID="rotation-backup-$(date +%s)"
          
          # Create encrypted backup
          vault kv get -format=json secret/database/credentials | \
            gpg --encrypt --armor --recipient security@pitchey.com > db-backup.gpg
          
          vault kv get -format=json secret/jwt/keys | \
            gpg --encrypt --armor --recipient security@pitchey.com > jwt-backup.gpg
          
          # Store in S3 with versioning
          aws s3 cp db-backup.gpg s3://pitchey-secret-backups/$BACKUP_ID/db-backup.gpg \
            --sse aws:kms --sse-kms-key-id ${{ secrets.KMS_KEY_ID }}
          
          aws s3 cp jwt-backup.gpg s3://pitchey-secret-backups/$BACKUP_ID/jwt-backup.gpg \
            --sse aws:kms --sse-kms-key-id ${{ secrets.KMS_KEY_ID }}
          
          echo "id=$BACKUP_ID" >> $GITHUB_OUTPUT
          
          # Audit log
          echo "Secret backup created: $BACKUP_ID" | \
            aws s3 cp - s3://pitchey-audit-logs/secret-rotation/$(date +%Y/%m/%d)/backup-$BACKUP_ID.log

  rotate-database-credentials:
    needs: pre-rotation-validation
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.rotation_type, 'database') || github.event.inputs.rotation_type == 'all'
    steps:
      - name: Setup Vault
        run: |
          # Install Vault CLI
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install vault
          
      - name: Generate new database credentials
        id: new-creds
        run: |
          # Use Vault's database secrets engine
          NEW_CREDS=$(vault read -format=json database/creds/pitchey-app)
          
          DB_USER=$(echo $NEW_CREDS | jq -r '.data.username')
          DB_PASS=$(echo $NEW_CREDS | jq -r '.data.password')
          
          echo "::add-mask::$DB_PASS"
          echo "username=$DB_USER" >> $GITHUB_OUTPUT
          
          # Test connection with new credentials
          PGPASSWORD=$DB_PASS psql -h ${{ secrets.DB_HOST }} -U $DB_USER -d pitchey -c "SELECT 1" || exit 1
          
      - name: Update Cloudflare Worker secrets
        run: |
          # Install Wrangler
          npm install -g wrangler
          
          # Update database URL in Cloudflare
          NEW_DATABASE_URL="postgresql://${{ steps.new-creds.outputs.username }}:***@${{ secrets.DB_HOST }}/pitchey?sslmode=require"
          
          echo "$NEW_DATABASE_URL" | wrangler secret put DATABASE_URL \
            --env production \
            --name pitchey-production
            
          # Verify deployment
          sleep 10
          curl -f https://pitchey-production.cavelltheleaddev.workers.dev/health || exit 1
          
      - name: Revoke old credentials
        if: success()
        run: |
          # Wait for connections to drain
          sleep 60
          
          # Revoke old database credentials
          vault lease revoke $(vault kv get -field=lease_id secret/database/old-credentials) || true
          
          # Move current to old
          vault kv put secret/database/old-credentials \
            username=$(vault kv get -field=username secret/database/credentials) \
            revoked_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)

  rotate-jwt-keys:
    needs: pre-rotation-validation
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.rotation_type, 'jwt') || github.event.inputs.rotation_type == 'all'
    steps:
      - name: Generate new RSA keypair
        id: generate-keys
        run: |
          # Generate 4096-bit RSA keypair
          openssl genrsa -out private.pem 4096
          openssl rsa -in private.pem -pubout -out public.pem
          
          # Generate key ID
          KID=$(uuidgen)
          echo "kid=$KID" >> $GITHUB_OUTPUT
          
          # Create JWK format
          npm install -g pem-jwk
          pem-jwk private.pem > private.jwk
          pem-jwk public.pem > public.jwk
          
          # Add metadata to JWK
          jq --arg kid "$KID" \
             --arg use "sig" \
             --arg alg "RS256" \
             '. + {kid: $kid, use: $use, alg: $alg}' private.jwk > private-final.jwk
             
      - name: Store in Vault with rotation
        run: |
          # Get current keys for grace period
          CURRENT_KEYS=$(vault kv get -format=json secret/jwt/keys)
          
          # Store new keys with rotation metadata
          vault kv put secret/jwt/keys \
            current_kid="${{ steps.generate-keys.outputs.kid }}" \
            current_private_key=@private.pem \
            current_public_key=@public.pem \
            current_jwk=@private-final.jwk \
            previous_kid=$(echo $CURRENT_KEYS | jq -r '.data.data.current_kid') \
            previous_public_key=$(echo $CURRENT_KEYS | jq -r '.data.data.current_public_key') \
            rotation_timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            grace_period_ends=$(date -u -d "+24 hours" +%Y-%m-%dT%H:%M:%SZ)
            
      - name: Update Cloudflare Worker
        run: |
          # Update JWT keys in Worker
          wrangler secret put JWT_PRIVATE_KEY < private.pem \
            --env production \
            --name pitchey-production
            
          wrangler secret put JWT_PUBLIC_KEY < public.pem \
            --env production \
            --name pitchey-production
            
          wrangler secret put JWT_KID \
            --env production \
            --name pitchey-production \
            <<< "${{ steps.generate-keys.outputs.kid }}"
            
      - name: Distribute public keys
        run: |
          # Update public key endpoint
          cat > jwks.json << EOF
          {
            "keys": [
              $(cat public.jwk),
              $(vault kv get -field=previous_jwk secret/jwt/keys || echo '{}')
            ]
          }
          EOF
          
          # Upload to CDN for client verification
          aws s3 cp jwks.json s3://pitchey-public/.well-known/jwks.json \
            --cache-control "max-age=3600" \
            --content-type "application/json"
            
      - name: Cleanup
        if: always()
        run: |
          shred -vfz private.pem private.jwk private-final.jwk 2>/dev/null || true
          rm -f private.pem public.pem *.jwk jwks.json

  rotate-api-keys:
    needs: pre-rotation-validation
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.rotation_type, 'api-keys') || github.event.inputs.rotation_type == 'all'
    strategy:
      matrix:
        service: [cloudflare, neon, upstash]
    steps:
      - name: Rotate ${{ matrix.service }} API key
        run: |
          case "${{ matrix.service }}" in
            cloudflare)
              # Rotate Cloudflare API token
              NEW_TOKEN=$(curl -X POST "https://api.cloudflare.com/client/v4/user/tokens" \
                -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                -H "Content-Type: application/json" \
                --data '{
                  "name": "pitchey-production-'$(date +%s)'",
                  "policies": [{
                    "effect": "allow",
                    "resources": {
                      "com.cloudflare.api.account.*": "*"
                    },
                    "permission_groups": [{
                      "id": "c8fed203ed3043cba015a93ad1616f1f",
                      "name": "Workers Scripts Write"
                    }]
                  }]
                }' | jq -r '.result.value')
              
              # Update in Vault and GitHub
              vault kv put secret/api-keys/cloudflare token=$NEW_TOKEN
              gh secret set CLOUDFLARE_API_TOKEN --body "$NEW_TOKEN"
              ;;
              
            neon)
              # Rotate Neon API key
              echo "Rotating Neon API key..."
              # Implementation specific to Neon API
              ;;
              
            upstash)
              # Rotate Upstash Redis token
              echo "Rotating Upstash token..."
              # Implementation specific to Upstash API
              ;;
          esac

  verify-rotation:
    needs: [rotate-database-credentials, rotate-jwt-keys, rotate-api-keys]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Run integration tests
        run: |
          # Test database connectivity
          curl -f https://pitchey-production.cavelltheleaddev.workers.dev/api/health/database || exit 1
          
          # Test JWT validation
          TEST_TOKEN=$(curl -X POST https://pitchey-production.cavelltheleaddev.workers.dev/api/auth/test \
            -H "Content-Type: application/json" \
            -d '{"test": true}' | jq -r '.token')
          
          curl -f https://pitchey-production.cavelltheleaddev.workers.dev/api/auth/verify \
            -H "Authorization: Bearer $TEST_TOKEN" || exit 1
            
      - name: Security scan
        run: |
          # Scan for exposed secrets
          trufflehog filesystem . --only-verified || exit 1
          
          # Verify no hardcoded secrets
          gitleaks detect --source . --verbose || exit 1
          
      - name: Generate rotation report
        run: |
          cat > rotation-report.md << EOF
          # Secret Rotation Report
          
          **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Rotation Type**: ${{ github.event.inputs.rotation_type || 'scheduled' }}
          **Backup ID**: ${{ needs.pre-rotation-validation.outputs.backup_id }}
          
          ## Results
          | Service | Status |
          |---------|--------|
          | Database | ${{ needs.rotate-database-credentials.result }} |
          | JWT Keys | ${{ needs.rotate-jwt-keys.result }} |
          | API Keys | ${{ needs.rotate-api-keys.result }} |
          
          ## Verification
          - Health Check: $(curl -s -o /dev/null -w "%{http_code}" https://pitchey-production.cavelltheleaddev.workers.dev/health)
          - Database: $(curl -s https://pitchey-production.cavelltheleaddev.workers.dev/api/health/database | jq -r '.status')
          - Cache: $(curl -s https://pitchey-production.cavelltheleaddev.workers.dev/api/health/cache | jq -r '.status')
          
          ## Next Rotation
          Scheduled for: $(date -u -d "+6 hours" +%Y-%m-%dT%H:%M:%SZ)
          EOF
          
          # Store report
          aws s3 cp rotation-report.md \
            s3://pitchey-audit-logs/secret-rotation/$(date +%Y/%m/%d)/report-$(date +%s).md

  rollback-on-failure:
    needs: verify-rotation
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Initiate rollback
        run: |
          echo "Rolling back secret rotation due to verification failure"
          
          # Restore from backup
          BACKUP_ID="${{ needs.pre-rotation-validation.outputs.backup_id }}"
          
          # Download backups
          aws s3 cp s3://pitchey-secret-backups/$BACKUP_ID/db-backup.gpg db-backup.gpg
          aws s3 cp s3://pitchey-secret-backups/$BACKUP_ID/jwt-backup.gpg jwt-backup.gpg
          
          # Decrypt and restore
          gpg --decrypt db-backup.gpg | vault kv put secret/database/credentials -
          gpg --decrypt jwt-backup.gpg | vault kv put secret/jwt/keys -
          
          # Update Cloudflare with restored secrets
          # ... restoration logic ...
          
      - name: Alert security team
        if: always()
        run: |
          # Send critical alert
          curl -X POST ${{ secrets.PAGERDUTY_ENDPOINT }} \
            -H "Content-Type: application/json" \
            -d '{
              "routing_key": "${{ secrets.PAGERDUTY_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "Secret rotation rollback initiated",
                "severity": "critical",
                "source": "github-actions",
                "custom_details": {
                  "backup_id": "${{ needs.pre-rotation-validation.outputs.backup_id }}",
                  "workflow_run": "${{ github.run_id }}"
                }
              }
            }'