name: Container Integration Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'containers/**'
      - 'tests/containers/**'
      - 'src/containers/**'
      - '.github/workflows/container-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'containers/**'
      - 'tests/containers/**'
      - 'src/containers/**'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - services
        - integration
        - performance
        - security
      runtime:
        description: 'Container runtime to use'
        required: false
        default: 'docker'
        type: choice
        options:
        - docker
        - podman
      timeout:
        description: 'Test timeout in minutes'
        required: false
        default: '60'
        type: string

env:
  # Container test configuration
  TEST_ENVIRONMENT: ci
  CONTAINER_REGISTRY: ghcr.io
  IMAGE_PREFIX: pitchey-containers
  
  # Performance test configuration
  K6_VERSION: 0.47.0
  
  # Security scanning configuration
  TRIVY_VERSION: 0.48.0

jobs:
  # Job to prepare test environment and build containers
  prepare:
    name: Prepare Test Environment
    runs-on: ubuntu-latest
    outputs:
      test-matrix: ${{ steps.matrix.outputs.matrix }}
      container-images: ${{ steps.build.outputs.images }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Setup test matrix
        id: matrix
        run: |
          if [ "${{ github.event.inputs.test_type }}" = "services" ]; then
            MATRIX='{"include":[{"runtime":"docker","test-type":"services"}]}'
          elif [ "${{ github.event.inputs.test_type }}" = "performance" ]; then
            MATRIX='{"include":[{"runtime":"docker","test-type":"performance"}]}'
          elif [ "${{ github.event.inputs.test_type }}" = "security" ]; then
            MATRIX='{"include":[{"runtime":"docker","test-type":"security"}]}'
          else
            MATRIX='{"include":[
              {"runtime":"docker","test-type":"services"},
              {"runtime":"docker","test-type":"integration"},
              {"runtime":"docker","test-type":"performance"},
              {"runtime":"docker","test-type":"security"},
              {"runtime":"podman","test-type":"services"}
            ]}'
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          
      - name: Generate test fixtures
        run: |
          cd tests/containers/fixtures
          ./generate-test-files.sh
          
      - name: Cache test fixtures
        uses: actions/cache@v3
        with:
          path: tests/containers/fixtures
          key: test-fixtures-${{ hashFiles('tests/containers/fixtures/generate-test-files.sh') }}
          
      - name: Build container images
        id: build
        run: |
          cd containers
          
          # Build all container images
          docker-compose -f docker-compose.test.yml build --parallel
          
          # Tag images for testing
          IMAGES=""
          for service in video-processor document-processor ai-inference media-transcoder code-executor; do
            IMAGE_TAG="test-${service}:${{ github.sha }}"
            docker tag "containers_${service}" "$IMAGE_TAG"
            IMAGES="$IMAGES $IMAGE_TAG"
          done
          
          echo "images=$IMAGES" >> $GITHUB_OUTPUT
          
      - name: Save container images
        run: |
          mkdir -p /tmp/container-images
          for image in ${{ steps.build.outputs.images }}; do
            docker save "$image" | gzip > "/tmp/container-images/$(echo $image | tr '/:' '_').tar.gz"
          done
          
      - name: Upload container images
        uses: actions/upload-artifact@v3
        with:
          name: container-images
          path: /tmp/container-images/
          retention-days: 1

  # Main test job matrix
  test:
    name: ${{ matrix.test-type }} tests (${{ matrix.runtime }})
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.test-matrix != ''
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.test-matrix) }}
      
    timeout-minutes: ${{ fromJson(github.event.inputs.timeout || '60') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
          
      - name: Setup Docker
        if: matrix.runtime == 'docker'
        uses: docker/setup-buildx-action@v3
        
      - name: Setup Podman
        if: matrix.runtime == 'podman'
        run: |
          sudo apt-get update
          sudo apt-get install -y podman podman-compose
          
      - name: Setup k6
        if: matrix.test-type == 'performance' || matrix.test-type == 'all'
        run: |
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver keyserver.ubuntu.com --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          
      - name: Setup Trivy
        if: matrix.test-type == 'security' || matrix.test-type == 'all'
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          
      - name: Cache test fixtures
        uses: actions/cache@v3
        with:
          path: tests/containers/fixtures
          key: test-fixtures-${{ hashFiles('tests/containers/fixtures/generate-test-files.sh') }}
          
      - name: Download container images
        uses: actions/download-artifact@v3
        with:
          name: container-images
          path: /tmp/container-images/
          
      - name: Load container images
        run: |
          for image_file in /tmp/container-images/*.tar.gz; do
            docker load < "$image_file"
          done
          
      - name: Start container services
        run: |
          cd containers
          
          # Start services based on runtime
          if [ "${{ matrix.runtime }}" = "docker" ]; then
            docker-compose -f docker-compose.test.yml up -d
          else
            podman-compose -f docker-compose.test.yml up -d
          fi
          
          # Wait for services to be healthy
          timeout 300 bash -c '
            until curl -f http://localhost:8081/health > /dev/null 2>&1 && \
                  curl -f http://localhost:8082/health > /dev/null 2>&1 && \
                  curl -f http://localhost:8083/health > /dev/null 2>&1 && \
                  curl -f http://localhost:8084/health > /dev/null 2>&1 && \
                  curl -f http://localhost:8085/health > /dev/null 2>&1; do
              echo "Waiting for services to be ready..."
              sleep 10
            done
          '
          
      - name: Run service tests
        if: matrix.test-type == 'services' || matrix.test-type == 'all'
        run: |
          export CONTAINER_RUNTIME="${{ matrix.runtime }}"
          export TEST_ENVIRONMENT="ci"
          
          # Run individual service tests
          for service in video-processor ai-inference code-executor; do
            echo "Testing $service..."
            deno test --allow-all "tests/containers/services/$service.test.ts" || exit 1
          done
          
      - name: Run integration tests
        if: matrix.test-type == 'integration' || matrix.test-type == 'all'
        run: |
          export CONTAINER_RUNTIME="${{ matrix.runtime }}"
          export TEST_ENVIRONMENT="ci"
          
          # Run integration tests
          if [ -f "tests/containers/integration/e2e-workflows.test.ts" ]; then
            deno test --allow-all "tests/containers/integration/e2e-workflows.test.ts"
          fi
          
      - name: Run performance tests
        if: matrix.test-type == 'performance' || matrix.test-type == 'all'
        run: |
          export CONTAINER_RUNTIME="${{ matrix.runtime }}"
          export TEST_ENVIRONMENT="ci"
          
          # Run Deno performance tests
          if [ -f "tests/containers/performance/benchmark-suite.test.ts" ]; then
            deno test --allow-all "tests/containers/performance/benchmark-suite.test.ts"
          fi
          
          # Run k6 load tests
          if [ -f "tests/containers/performance/load-testing.js" ]; then
            k6 run --duration=2m --vus=5 "tests/containers/performance/load-testing.js"
          fi
          
      - name: Run security tests
        if: matrix.test-type == 'security' || matrix.test-type == 'all'
        run: |
          export CONTAINER_RUNTIME="${{ matrix.runtime }}"
          export TEST_ENVIRONMENT="ci"
          
          # Run Deno security tests
          deno test --allow-all "tests/containers/security/container-security.test.ts"
          
          # Run Trivy security scans on container images
          for service in video-processor document-processor ai-inference media-transcoder code-executor; do
            echo "Scanning $service for vulnerabilities..."
            trivy image --exit-code 1 --severity HIGH,CRITICAL "test-${service}:${{ github.sha }}" || echo "âš ï¸ Vulnerabilities found in $service"
          done
          
      - name: Run runtime compatibility tests
        if: matrix.test-type == 'all'
        run: |
          export CONTAINER_RUNTIME="${{ matrix.runtime }}"
          export TEST_ENVIRONMENT="ci"
          
          if [ -f "tests/containers/runtime/${{ matrix.runtime }}-compatibility.test.ts" ]; then
            deno test --allow-all "tests/containers/runtime/${{ matrix.runtime }}-compatibility.test.ts"
          fi
          
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "Collecting container logs..."
          mkdir -p /tmp/logs
          
          cd containers
          if [ "${{ matrix.runtime }}" = "docker" ]; then
            docker-compose -f docker-compose.test.yml logs > /tmp/logs/container-logs.txt
            docker stats --no-stream > /tmp/logs/container-stats.txt
          else
            podman-compose -f docker-compose.test.yml logs > /tmp/logs/container-logs.txt
            podman stats --no-stream > /tmp/logs/container-stats.txt
          fi
          
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs-${{ matrix.runtime }}-${{ matrix.test-type }}
          path: /tmp/logs/
          retention-days: 7
          
      - name: Generate test report
        if: always()
        run: |
          cd tests/containers
          
          # Generate test summary
          echo "# Container Test Report" > test-report.md
          echo "## Configuration" >> test-report.md
          echo "- **Runtime**: ${{ matrix.runtime }}" >> test-report.md
          echo "- **Test Type**: ${{ matrix.test-type }}" >> test-report.md
          echo "- **Environment**: ci" >> test-report.md
          echo "- **Timestamp**: $(date -u)" >> test-report.md
          echo "" >> test-report.md
          
          if [ -d "reports" ]; then
            echo "## Test Results" >> test-report.md
            for report in reports/*.json; do
              if [ -f "$report" ]; then
                echo "- $(basename "$report")" >> test-report.md
              fi
            done
          fi
          
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-report-${{ matrix.runtime }}-${{ matrix.test-type }}
          path: tests/containers/test-report.md
          retention-days: 30
          
      - name: Cleanup containers
        if: always()
        run: |
          cd containers
          
          if [ "${{ matrix.runtime }}" = "docker" ]; then
            docker-compose -f docker-compose.test.yml down -v --remove-orphans
            docker system prune -f
          else
            podman-compose -f docker-compose.test.yml down -v
            podman system prune -f
          fi

  # Job to aggregate results and publish
  results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: always()
    
    steps:
      - name: Download all test reports
        uses: actions/download-artifact@v3
        with:
          path: /tmp/test-reports/
          
      - name: Generate summary report
        run: |
          echo "# Container Integration Test Summary" > summary.md
          echo "**Workflow**: ${{ github.workflow }}" >> summary.md
          echo "**Run ID**: ${{ github.run_id }}" >> summary.md
          echo "**Commit**: ${{ github.sha }}" >> summary.md
          echo "**Timestamp**: $(date -u)" >> summary.md
          echo "" >> summary.md
          
          echo "## Test Results" >> summary.md
          
          # Count test artifacts
          SERVICE_TESTS=$(find /tmp/test-reports -name "*services*" | wc -l)
          INTEGRATION_TESTS=$(find /tmp/test-reports -name "*integration*" | wc -l)
          PERFORMANCE_TESTS=$(find /tmp/test-reports -name "*performance*" | wc -l)
          SECURITY_TESTS=$(find /tmp/test-reports -name "*security*" | wc -l)
          
          echo "- **Service Tests**: $SERVICE_TESTS completed" >> summary.md
          echo "- **Integration Tests**: $INTEGRATION_TESTS completed" >> summary.md
          echo "- **Performance Tests**: $PERFORMANCE_TESTS completed" >> summary.md
          echo "- **Security Tests**: $SECURITY_TESTS completed" >> summary.md
          echo "" >> summary.md
          
          echo "## Job Status" >> summary.md
          echo "- **Overall**: ${{ needs.test.result }}" >> summary.md
          
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "" >> summary.md
            echo "âš ï¸ **Some tests failed. Check individual job logs for details.**" >> summary.md
            echo "" >> summary.md
            echo "### Failed Jobs" >> summary.md
            if [ -d "/tmp/test-reports" ]; then
              find /tmp/test-reports -name "*logs*" -type d | while read logdir; do
                echo "- $(basename "$logdir")" >> summary.md
              done
            fi
          fi
          
          echo "" >> summary.md
          echo "## Next Steps" >> summary.md
          echo "1. Review test reports and logs" >> summary.md
          echo "2. Fix any failing tests" >> summary.md
          echo "3. Update container configurations if needed" >> summary.md
          echo "4. Re-run tests to verify fixes" >> summary.md
          
      - name: Create job summary
        run: |
          cat summary.md >> $GITHUB_STEP_SUMMARY
          
      - name: Upload summary report
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: summary.md
          retention-days: 30
          
      - name: Notify on failure
        if: failure() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš¨ Container integration tests failed. Please check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })

  # Cleanup job to remove temporary artifacts
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [results]
    if: always()
    
    steps:
      - name: Delete temporary artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: |
            container-images
          failOnError: false
          
      - name: Cleanup completed
        run: echo "âœ… Cleanup completed successfully"