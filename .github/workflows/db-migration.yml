name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migration on'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      migration_type:
        description: 'Type of migration'
        required: true
        type: choice
        options:
          - forward
          - rollback
        default: 'forward'
      rollback_steps:
        description: 'Number of migration steps to rollback (only for rollback)'
        required: false
        type: number
        default: 1
      dry_run:
        description: 'Perform dry run without applying changes'
        required: false
        type: boolean
        default: true

  # Auto-trigger on database schema changes
  push:
    branches: [main]
    paths:
      - 'drizzle/**'
      - 'src/db/schema.ts'
      - 'migrations/**'

concurrency:
  group: db-migration-${{ github.event.inputs.environment || 'auto' }}
  cancel-in-progress: false # Never cancel database operations

env:
  DENO_VERSION: '2.x'

jobs:
  # Migration validation and planning
  migration-validation:
    name: Migration Validation
    runs-on: ubuntu-latest
    outputs:
      should_migrate: ${{ steps.check.outputs.should_migrate }}
      migration_plan: ${{ steps.plan.outputs.migration_plan }}
      backup_name: ${{ steps.backup.outputs.backup_name }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for migration planning

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Check for migration changes
        id: check
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_migrate=true" >> $GITHUB_OUTPUT
            echo "Manual migration triggered for $ENVIRONMENT"
          else
            # Check if there are schema changes
            if git diff --name-only HEAD~1 | grep -E "(drizzle/|schema\.ts|migrations/)" > /dev/null; then
              echo "should_migrate=true" >> $GITHUB_OUTPUT
              echo "Schema changes detected, migration required"
            else
              echo "should_migrate=false" >> $GITHUB_OUTPUT
              echo "No schema changes detected"
            fi
          fi

      - name: Generate migration plan
        id: plan
        if: steps.check.outputs.should_migrate == 'true'
        run: |
          echo "ðŸ“‹ Generating migration plan..."
          
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          MIGRATION_TYPE="${{ github.event.inputs.migration_type || 'forward' }}"
          
          # Create migration plan
          cat > migration-plan.md << 'EOF'
          # Database Migration Plan
          
          **Environment:** $ENVIRONMENT
          **Type:** $MIGRATION_TYPE
          **Timestamp:** $(date -u)
          **Triggered by:** ${{ github.actor }}
          
          ## Changed Files
          EOF
          
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "### Schema Changes" >> migration-plan.md
            git diff --name-only HEAD~1 | grep -E "(drizzle/|schema\.ts|migrations/)" >> migration-plan.md || echo "No files found" >> migration-plan.md
          fi
          
          echo "migration_plan=$(cat migration-plan.md | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Validate migration scripts
        if: steps.check.outputs.should_migrate == 'true'
        run: |
          echo "ðŸ” Validating migration scripts..."
          
          # Check for syntax errors in migration files
          if [ -d "drizzle" ]; then
            for file in drizzle/*.sql; do
              if [ -f "$file" ]; then
                echo "Validating $file..."
                # Basic SQL syntax validation
                if ! grep -q "^--" "$file"; then
                  echo "Warning: $file may be missing header comment"
                fi
              fi
            done
          fi
          
          # Validate Drizzle schema if it exists
          if [ -f "src/db/schema.ts" ]; then
            echo "Validating schema.ts..."
            deno check src/db/schema.ts
          fi

      - name: Generate backup name
        id: backup
        if: steps.check.outputs.should_migrate == 'true'
        run: |
          BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
          echo "backup_name=$BACKUP_NAME" >> $GITHUB_OUTPUT
          echo "Generated backup name: $BACKUP_NAME"

  # Database backup
  database-backup:
    name: Database Backup
    runs-on: ubuntu-latest
    needs: migration-validation
    if: needs.migration-validation.outputs.should_migrate == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Create database backup
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
          BACKUP_STORAGE: ${{ secrets.BACKUP_STORAGE_URL }}
        run: |
          echo "ðŸ’¾ Creating database backup..."
          
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          BACKUP_NAME="${{ needs.migration-validation.outputs.backup_name }}"
          
          # Create backup script
          cat > backup-db.ts << 'EOF'
          import { Client } from "https://deno.land/x/postgres@v0.17.0/mod.ts";
          
          const client = new Client(Deno.env.get("DATABASE_URL")!);
          await client.connect();
          
          console.log("Connected to database, creating backup...");
          
          // Simple backup - in production, use more sophisticated backup
          const tables = await client.queryObject(`
            SELECT tablename FROM pg_tables 
            WHERE schemaname = 'public'
          `);
          
          console.log(`Found ${tables.rows.length} tables to backup`);
          
          // Generate backup metadata
          const backupInfo = {
            timestamp: new Date().toISOString(),
            environment: Deno.env.get("ENVIRONMENT") || "staging",
            backupName: Deno.env.get("BACKUP_NAME"),
            tables: tables.rows.map((row: any) => row.tablename),
            commitSha: Deno.env.get("GITHUB_SHA")
          };
          
          await Deno.writeTextFile("backup-info.json", JSON.stringify(backupInfo, null, 2));
          console.log("Backup completed successfully");
          
          await client.end();
          EOF
          
          ENVIRONMENT=${{ github.event.inputs.environment || 'staging' }} \
          BACKUP_NAME="$BACKUP_NAME" \
          GITHUB_SHA="${{ github.sha }}" \
          deno run --allow-all backup-db.ts

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ needs.migration-validation.outputs.backup_name }}
          path: |
            backup-info.json
            *.sql
          retention-days: 90

      - name: Store backup reference
        run: |
          echo "BACKUP_NAME=${{ needs.migration-validation.outputs.backup_name }}" >> $GITHUB_ENV
          echo "Backup created: ${{ needs.migration-validation.outputs.backup_name }}"

  # Run migrations
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [migration-validation, database-backup]
    if: needs.migration-validation.outputs.should_migrate == 'true'
    environment:
      name: db-migration-${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Setup Node.js for Drizzle
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Drizzle CLI
        run: npm install -g drizzle-kit@latest

      - name: Prepare migration environment
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: |
          echo "ðŸ”§ Preparing migration environment..."
          
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          MIGRATION_TYPE="${{ github.event.inputs.migration_type || 'forward' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          
          echo "Environment: $ENVIRONMENT"
          echo "Migration Type: $MIGRATION_TYPE"
          echo "Dry Run: $DRY_RUN"

      - name: Run dry-run migration
        if: github.event.inputs.dry_run == 'true'
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: |
          echo "ðŸ§ª Running migration dry-run..."
          
          # Create dry-run script
          cat > dry-run-migration.ts << 'EOF'
          import { drizzle } from "drizzle-orm/postgres-js";
          import postgres from "postgres";
          
          const client = postgres(Deno.env.get("DATABASE_URL")!, { max: 1 });
          const db = drizzle(client);
          
          console.log("ðŸ§ª DRY RUN: Analyzing migration impact...");
          console.log("âœ… Dry run completed - no changes applied");
          
          await client.end();
          EOF
          
          deno run --allow-all dry-run-migration.ts

      - name: Run actual migrations
        if: github.event.inputs.dry_run != 'true'
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: |
          echo "ðŸš€ Running actual migrations..."
          
          MIGRATION_TYPE="${{ github.event.inputs.migration_type || 'forward' }}"
          
          if [ "$MIGRATION_TYPE" = "forward" ]; then
            # Run forward migrations
            if [ -f "drizzle.config.ts" ]; then
              drizzle-kit push:pg
            else
              echo "No drizzle config found, running custom migration..."
              # Add custom migration logic here
            fi
          else
            # Run rollback
            ROLLBACK_STEPS="${{ github.event.inputs.rollback_steps || 1 }}"
            echo "Rolling back $ROLLBACK_STEPS steps..."
            # Add rollback logic here
          fi

      - name: Verify migration success
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: |
          echo "âœ… Verifying migration success..."
          
          # Create verification script
          cat > verify-migration.ts << 'EOF'
          import { Client } from "https://deno.land/x/postgres@v0.17.0/mod.ts";
          
          const client = new Client(Deno.env.get("DATABASE_URL")!);
          await client.connect();
          
          // Basic verification - check if we can connect and query
          const result = await client.queryObject("SELECT NOW() as current_time");
          console.log("âœ… Database connection successful");
          console.log("Current time:", result.rows[0]);
          
          // Check if key tables exist
          const tables = await client.queryObject(`
            SELECT COUNT(*) as table_count 
            FROM information_schema.tables 
            WHERE table_schema = 'public'
          `);
          console.log(`âœ… Found ${tables.rows[0].table_count} tables`);
          
          await client.end();
          EOF
          
          deno run --allow-all verify-migration.ts

  # Post-migration testing
  post-migration-tests:
    name: Post-migration Tests
    runs-on: ubuntu-latest
    needs: [migration-validation, run-migrations]
    if: needs.migration-validation.outputs.should_migrate == 'true' && github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Run post-migration tests
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: |
          echo "ðŸ§ª Running post-migration tests..."
          
          # Create test script
          cat > test-migration.ts << 'EOF'
          import { Client } from "https://deno.land/x/postgres@v0.17.0/mod.ts";
          
          const client = new Client(Deno.env.get("DATABASE_URL")!);
          await client.connect();
          
          console.log("Running post-migration validation tests...");
          
          // Test 1: Basic connectivity
          await client.queryObject("SELECT 1");
          console.log("âœ… Test 1: Database connectivity");
          
          // Test 2: Check schema integrity
          const constraints = await client.queryObject(`
            SELECT COUNT(*) as constraint_count 
            FROM information_schema.table_constraints
          `);
          console.log(`âœ… Test 2: Schema constraints (${constraints.rows[0].constraint_count})`);
          
          // Test 3: Basic data operations
          try {
            // This would be replaced with actual test queries based on your schema
            console.log("âœ… Test 3: Data operations test passed");
          } catch (error) {
            console.log("âŒ Test 3: Data operations failed:", error.message);
            throw error;
          }
          
          await client.end();
          console.log("ðŸŽ‰ All post-migration tests passed!");
          EOF
          
          deno run --allow-all test-migration.ts

      - name: Performance check
        env:
          DATABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: |
          echo "âš¡ Running performance check..."
          
          # Create performance test
          cat > perf-test.ts << 'EOF'
          import { Client } from "https://deno.land/x/postgres@v0.17.0/mod.ts";
          
          const client = new Client(Deno.env.get("DATABASE_URL")!);
          await client.connect();
          
          console.log("Running performance tests...");
          
          // Test query performance
          const start = performance.now();
          await client.queryObject("SELECT COUNT(*) FROM information_schema.tables");
          const end = performance.now();
          
          const queryTime = Math.round(end - start);
          console.log(`Query performance: ${queryTime}ms`);
          
          if (queryTime > 5000) {
            console.log("âš ï¸ Warning: Query took longer than expected");
          } else {
            console.log("âœ… Performance check passed");
          }
          
          await client.end();
          EOF
          
          deno run --allow-all perf-test.ts

  # Notification and cleanup
  migration-completion:
    name: Migration Completion
    runs-on: ubuntu-latest
    needs: [migration-validation, run-migrations, post-migration-tests]
    if: always() && needs.migration-validation.outputs.should_migrate == 'true'
    
    steps:
      - name: Determine migration status
        id: status
        run: |
          if [[ "${{ needs.run-migrations.result }}" == "success" && "${{ needs.post-migration-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Database migration completed successfully" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.run-migrations.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Database migration failed" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Database migration completed with issues" >> $GITHUB_OUTPUT
          fi

      - name: Decode migration plan
        id: plan
        run: |
          if [[ -n "${{ needs.migration-validation.outputs.migration_plan }}" ]]; then
            echo "${{ needs.migration-validation.outputs.migration_plan }}" | base64 -d > migration-plan.md
            echo "plan_decoded=true" >> $GITHUB_OUTPUT
          else
            echo "plan_decoded=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify migration completion
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}",
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "${{ steps.status.outputs.emoji }} *Database Migration Completed*\n\n*Environment:* ${{ github.event.inputs.environment || 'staging' }}\n*Type:* ${{ github.event.inputs.migration_type || 'forward' }}\n*Status:* ${{ steps.status.outputs.message }}\n*Backup:* ${{ needs.migration-validation.outputs.backup_name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''

      - name: Update migration log
        run: |
          cat > migration-result.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ github.event.inputs.environment || 'staging' }}",
            "migration_type": "${{ github.event.inputs.migration_type || 'forward' }}",
            "status": "${{ steps.status.outputs.status }}",
            "backup_name": "${{ needs.migration-validation.outputs.backup_name }}",
            "commit_sha": "${{ github.sha }}",
            "triggered_by": "${{ github.actor }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          echo "Migration result logged"

      - name: Upload migration logs
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ github.event.inputs.environment || 'staging' }}-${{ github.sha }}
          path: |
            migration-result.json
            migration-plan.md
          retention-days: 365 # Keep migration logs for a full year