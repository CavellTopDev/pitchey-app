name: Multi-Region Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      regions:
        description: 'Target regions for deployment (comma-separated)'
        required: true
        default: 'us-east,us-west,eu-west,asia-pacific'
        type: string
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      rollout_strategy:
        description: 'Rollout strategy'
        required: true
        default: 'sequential'
        type: choice
        options:
          - sequential
          - parallel
          - canary
      health_check_timeout:
        description: 'Health check timeout per region (seconds)'
        required: false
        default: '300'
        type: string
      failover_enabled:
        description: 'Enable automatic failover'
        required: false
        default: true
        type: boolean

env:
  DEPLOYMENT_TIMEOUT: 1800  # 30 minutes
  HEALTH_CHECK_INTERVAL: 30
  CLOUDFLARE_API_BASE: 'https://api.cloudflare.com/client/v4'

jobs:
  # Pre-deployment planning
  deployment-planning:
    runs-on: ubuntu-latest
    outputs:
      regions: ${{ steps.parse-regions.outputs.regions }}
      deployment-matrix: ${{ steps.create-matrix.outputs.deployment-matrix }}
      deployment-id: ${{ steps.generate-id.outputs.deployment-id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate deployment ID
        id: generate-id
        run: |
          DEPLOYMENT_ID="multi-region-$(date +%Y%m%d%H%M%S)-$(git rev-parse --short HEAD)"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "Generated deployment ID: $DEPLOYMENT_ID"
      
      - name: Parse regions
        id: parse-regions
        run: |
          REGIONS_INPUT="${{ inputs.regions }}"
          
          # Convert comma-separated regions to array
          IFS=',' read -ra REGIONS_ARRAY <<< "$REGIONS_INPUT"
          
          # Validate regions
          VALID_REGIONS=""
          for region in "${REGIONS_ARRAY[@]}"; do
            region=$(echo "$region" | tr -d ' ')
            case "$region" in
              us-east|us-west|us-central|eu-west|eu-central|asia-pacific|ap-southeast|ap-northeast)
                VALID_REGIONS="$VALID_REGIONS $region"
                ;;
              *)
                echo "âš ï¸ Invalid region: $region"
                ;;
            esac
          done
          
          # Convert to JSON array
          REGIONS_JSON="["
          first=true
          for region in $VALID_REGIONS; do
            if [ "$first" = true ]; then
              REGIONS_JSON="$REGIONS_JSON\"$region\""
              first=false
            else
              REGIONS_JSON="$REGIONS_JSON,\"$region\""
            fi
          done
          REGIONS_JSON="$REGIONS_JSON]"
          
          echo "regions=$REGIONS_JSON" >> $GITHUB_OUTPUT
          echo "Valid regions for deployment: $REGIONS_JSON"
      
      - name: Create deployment matrix
        id: create-matrix
        run: |
          REGIONS='${{ steps.parse-regions.outputs.regions }}'
          
          # Create matrix based on rollout strategy
          if [ "${{ inputs.rollout_strategy }}" == "sequential" ]; then
            # For sequential, we'll use a single job with region iteration
            MATRIX='{"include":[{"strategy":"sequential","regions":'$REGIONS'}]}'
          elif [ "${{ inputs.rollout_strategy }}" == "parallel" ]; then
            # For parallel, create one job per region
            MATRIX='{"region":'$REGIONS'}'
          else  # canary
            # For canary, deploy to first region, then others
            FIRST_REGION=$(echo $REGIONS | jq -r '.[0]')
            REMAINING_REGIONS=$(echo $REGIONS | jq -r '.[1:]')
            MATRIX='{"include":[{"strategy":"canary-primary","region":"'$FIRST_REGION'"},{"strategy":"canary-secondary","regions":'$REMAINING_REGIONS'}]}'
          fi
          
          echo "deployment-matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Deployment matrix: $MATRIX"
      
      - name: Validate deployment plan
        run: |
          echo "ðŸ” Deployment Plan Validation"
          echo "============================="
          echo "Deployment ID: ${{ steps.generate-id.outputs.deployment-id }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Regions: ${{ steps.parse-regions.outputs.regions }}"
          echo "Strategy: ${{ inputs.rollout_strategy }}"
          echo "Failover: ${{ inputs.failover_enabled }}"
          echo "Health Check Timeout: ${{ inputs.health_check_timeout }}s"

  # Regional deployment (parallel/sequential based on strategy)
  regional-deployment:
    needs: deployment-planning
    runs-on: ubuntu-latest
    if: inputs.rollout_strategy == 'parallel'
    strategy:
      matrix: ${{ fromJson(needs.deployment-planning.outputs.deployment-matrix) }}
      fail-fast: false
      max-parallel: 3  # Limit parallel deployments
    steps:
      - uses: actions/checkout@v4
      
      - name: Install deployment tools
        run: |
          # Install Cloudflare CLI and other tools
          npm install -g wrangler@latest
          sudo apt-get update && sudo apt-get install -y jq curl
      
      - name: Configure region-specific settings
        id: configure-region
        run: |
          REGION="${{ matrix.region }}"
          
          # Map regions to Cloudflare data centers and configurations
          case "$REGION" in
            us-east)
              WORKER_NAME="pitchey-${{ inputs.environment }}-use1"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-use1"
              SUBDOMAIN_PREFIX="use1"
              ;;
            us-west)
              WORKER_NAME="pitchey-${{ inputs.environment }}-usw2"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-usw2"
              SUBDOMAIN_PREFIX="usw2"
              ;;
            us-central)
              WORKER_NAME="pitchey-${{ inputs.environment }}-usc1"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-usc1"
              SUBDOMAIN_PREFIX="usc1"
              ;;
            eu-west)
              WORKER_NAME="pitchey-${{ inputs.environment }}-euw1"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-euw1"
              SUBDOMAIN_PREFIX="euw1"
              ;;
            eu-central)
              WORKER_NAME="pitchey-${{ inputs.environment }}-euc1"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-euc1"
              SUBDOMAIN_PREFIX="euc1"
              ;;
            asia-pacific)
              WORKER_NAME="pitchey-${{ inputs.environment }}-ap1"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-ap1"
              SUBDOMAIN_PREFIX="ap1"
              ;;
            ap-southeast)
              WORKER_NAME="pitchey-${{ inputs.environment }}-apse2"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-apse2"
              SUBDOMAIN_PREFIX="apse2"
              ;;
            ap-northeast)
              WORKER_NAME="pitchey-${{ inputs.environment }}-apne1"
              PAGES_PROJECT="pitchey-${{ inputs.environment }}-apne1"
              SUBDOMAIN_PREFIX="apne1"
              ;;
          esac
          
          echo "worker-name=$WORKER_NAME" >> $GITHUB_OUTPUT
          echo "pages-project=$PAGES_PROJECT" >> $GITHUB_OUTPUT
          echo "subdomain-prefix=$SUBDOMAIN_PREFIX" >> $GITHUB_OUTPUT
          
          echo "Region configuration for $REGION:"
          echo "- Worker: $WORKER_NAME"
          echo "- Pages: $PAGES_PROJECT"
          echo "- Subdomain: $SUBDOMAIN_PREFIX"
      
      - name: Create region-specific configuration
        run: |
          REGION="${{ matrix.region }}"
          WORKER_NAME="${{ steps.configure-region.outputs.worker-name }}"
          SUBDOMAIN_PREFIX="${{ steps.configure-region.outputs.subdomain-prefix }}"
          
          # Create region-specific wrangler.toml
          cat > "wrangler-$REGION.toml" << EOF
          name = "$WORKER_NAME"
          main = "src/worker-production-db.ts"
          compatibility_date = "2024-11-01"
          compatibility_flags = ["nodejs_compat"]
          account_id = "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          
          [vars]
          ENVIRONMENT = "${{ inputs.environment }}"
          REGION = "$REGION"
          FRONTEND_URL = "https://$SUBDOMAIN_PREFIX.pitchey.pages.dev"
          
          # Region-specific KV namespace
          [[kv_namespaces]]
          binding = "KV"
          id = "${{ secrets.CLOUDFLARE_KV_ID }}"
          
          # Shared R2 bucket with region prefix
          [[r2_buckets]]
          binding = "R2_BUCKET"
          bucket_name = "pitchey-uploads"
          
          # Durable Objects
          [[durable_objects.bindings]]
          name = "WEBSOCKET_ROOM"
          class_name = "WebSocketRoom"
          
          [[durable_objects.bindings]]
          name = "NOTIFICATION_ROOM"
          class_name = "NotificationRoom"
          
          # Region-specific routes
          [[routes]]
          pattern = "$SUBDOMAIN_PREFIX-api.pitchey.com/*"
          zone_id = "${{ secrets.CLOUDFLARE_ZONE_ID }}"
          EOF
          
          echo "âœ… Region-specific configuration created for $REGION"
      
      - name: Deploy worker to region
        run: |
          REGION="${{ matrix.region }}"
          
          echo "ðŸš€ Deploying worker to $REGION..."
          
          # Deploy using region-specific config
          wrangler deploy --config "wrangler-$REGION.toml"
          
          echo "âœ… Worker deployed to $REGION"
      
      - name: Health check region deployment
        run: |
          REGION="${{ matrix.region }}"
          WORKER_NAME="${{ steps.configure-region.outputs.worker-name }}"
          SUBDOMAIN_PREFIX="${{ steps.configure-region.outputs.subdomain-prefix }}"
          
          echo "ðŸ” Health checking $REGION deployment..."
          
          HEALTH_URL="https://$WORKER_NAME.cavelltheleaddev.workers.dev/api/health"
          TIMEOUT="${{ inputs.health_check_timeout }}"
          INTERVAL="$HEALTH_CHECK_INTERVAL"
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -sf "$HEALTH_URL"; then
              echo "âœ… Health check passed for $REGION"
              
              # Test region-specific functionality
              REGION_INFO=$(curl -s "$HEALTH_URL" | jq -r '.region // "unknown"')
              echo "Region reported by worker: $REGION_INFO"
              
              exit 0
            fi
            
            echo "â³ Health check attempt failed, retrying in ${INTERVAL}s... (${ELAPSED}/${TIMEOUT}s)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "âŒ Health check failed for $REGION after ${TIMEOUT}s"
          exit 1
      
      - name: Configure region-specific routing
        run: |
          REGION="${{ matrix.region }}"
          WORKER_NAME="${{ steps.configure-region.outputs.worker-name }}"
          SUBDOMAIN_PREFIX="${{ steps.configure-region.outputs.subdomain-prefix }}"
          
          echo "ðŸŒ Configuring regional routing for $REGION..."
          
          # Create regional subdomain DNS record
          curl -X POST "$CLOUDFLARE_API_BASE/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "type": "CNAME",
              "name": "'$SUBDOMAIN_PREFIX'-api",
              "content": "'$WORKER_NAME'.cavelltheleaddev.workers.dev",
              "ttl": 300,
              "comment": "Regional API endpoint for '$REGION'"
            }' || echo "DNS record may already exist"
          
          # Create regional frontend subdomain
          curl -X POST "$CLOUDFLARE_API_BASE/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "type": "CNAME",
              "name": "'$SUBDOMAIN_PREFIX'",
              "content": "pitchey.pages.dev",
              "ttl": 300,
              "comment": "Regional frontend for '$REGION'"
            }' || echo "DNS record may already exist"
          
          echo "âœ… Regional routing configured for $REGION"

  # Sequential deployment (alternative strategy)
  sequential-deployment:
    needs: deployment-planning
    runs-on: ubuntu-latest
    if: inputs.rollout_strategy == 'sequential'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install deployment tools
        run: |
          npm install -g wrangler@latest
          sudo apt-get update && sudo apt-get install -y jq curl
      
      - name: Sequential region deployment
        run: |
          REGIONS='${{ needs.deployment-planning.outputs.regions }}'
          REGION_COUNT=$(echo $REGIONS | jq '. | length')
          
          echo "ðŸš€ Starting sequential deployment to $REGION_COUNT regions..."
          
          for i in $(seq 0 $((REGION_COUNT - 1))); do
            REGION=$(echo $REGIONS | jq -r ".[$i]")
            echo "Deploying to region $((i + 1))/$REGION_COUNT: $REGION"
            
            # Use the same deployment logic as parallel but one at a time
            bash .github/scripts/deploy-region.sh "$REGION" "${{ inputs.environment }}"
            
            if [ $? -ne 0 ]; then
              echo "âŒ Deployment failed for region: $REGION"
              
              if [ "${{ inputs.failover_enabled }}" == "true" ]; then
                echo "ðŸ”„ Failover enabled, continuing with next region..."
                continue
              else
                echo "ðŸ’¥ Failover disabled, stopping deployment"
                exit 1
              fi
            fi
            
            echo "âœ… Successfully deployed to $REGION"
            
            # Wait between regions to avoid rate limits
            sleep 10
          done
          
          echo "ðŸŽ‰ Sequential deployment completed"

  # Canary deployment
  canary-deployment:
    needs: deployment-planning
    runs-on: ubuntu-latest
    if: inputs.rollout_strategy == 'canary'
    strategy:
      matrix: ${{ fromJson(needs.deployment-planning.outputs.deployment-matrix) }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Canary primary deployment
        if: matrix.strategy == 'canary-primary'
        run: |
          REGION="${{ matrix.region }}"
          
          echo "ðŸ¤ Deploying canary to primary region: $REGION"
          
          # Deploy to primary region
          bash .github/scripts/deploy-region.sh "$REGION" "${{ inputs.environment }}"
          
          # Extended health monitoring for canary
          echo "ðŸ“Š Extended canary monitoring for 5 minutes..."
          
          for i in {1..10}; do
            # Collect metrics from the canary deployment
            HEALTH_RESPONSE=$(curl -s "https://$REGION-api.pitchey.com/api/health" || echo "error")
            ERROR_RATE=$(curl -s "https://$REGION-api.pitchey.com/api/metrics/errors" | jq -r '.error_rate // 0' 2>/dev/null || echo "0")
            
            echo "[$i/10] Health: $HEALTH_RESPONSE, Error Rate: $ERROR_RATE%"
            
            # Check if error rate is acceptable
            if (( $(echo "$ERROR_RATE > 5" | bc -l) )); then
              echo "âŒ Canary error rate too high: $ERROR_RATE%"
              exit 1
            fi
            
            sleep 30
          done
          
          echo "âœ… Canary primary deployment successful"
      
      - name: Canary secondary deployment
        if: matrix.strategy == 'canary-secondary'
        run: |
          echo "ðŸš€ Deploying to remaining regions after successful canary..."
          
          REGIONS='${{ matrix.regions }}'
          
          # Deploy to all remaining regions in parallel
          echo $REGIONS | jq -r '.[]' | while read -r region; do
            echo "Deploying to secondary region: $region"
            bash .github/scripts/deploy-region.sh "$region" "${{ inputs.environment }}" &
          done
          
          # Wait for all background deployments
          wait
          
          echo "âœ… Canary secondary deployments completed"

  # Global load balancer configuration
  configure-global-routing:
    needs: [deployment-planning, regional-deployment, sequential-deployment, canary-deployment]
    runs-on: ubuntu-latest
    if: always() && (needs.regional-deployment.result == 'success' || needs.sequential-deployment.result == 'success' || needs.canary-deployment.result == 'success')
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure global load balancing
        run: |
          echo "ðŸŒ Configuring global load balancing..."
          
          REGIONS='${{ needs.deployment-planning.outputs.regions }}'
          
          # Create load balancer pool for each region
          POOLS=""
          
          echo $REGIONS | jq -r '.[]' | while read -r region; do
            case "$region" in
              us-east) SUBDOMAIN="use1" ;;
              us-west) SUBDOMAIN="usw2" ;;
              us-central) SUBDOMAIN="usc1" ;;
              eu-west) SUBDOMAIN="euw1" ;;
              eu-central) SUBDOMAIN="euc1" ;;
              asia-pacific) SUBDOMAIN="ap1" ;;
              ap-southeast) SUBDOMAIN="apse2" ;;
              ap-northeast) SUBDOMAIN="apne1" ;;
            esac
            
            # Create pool for region
            POOL_RESPONSE=$(curl -X POST "$CLOUDFLARE_API_BASE/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/load_balancers/pools" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{
                "name": "pitchey-'$region'-pool",
                "description": "Pool for '$region' region",
                "enabled": true,
                "origins": [
                  {
                    "name": "'$region'-worker",
                    "address": "'$SUBDOMAIN'-api.pitchey.com",
                    "enabled": true,
                    "weight": 1
                  }
                ],
                "monitor": {
                  "type": "https",
                  "description": "Health check for '$region'",
                  "path": "/api/health",
                  "interval": 60,
                  "retries": 2,
                  "timeout": 10,
                  "expected_codes": "200"
                }
              }')
            
            POOL_ID=$(echo $POOL_RESPONSE | jq -r '.result.id // empty')
            
            if [ -n "$POOL_ID" ]; then
              echo "âœ… Created pool for $region: $POOL_ID"
              POOLS="$POOLS $POOL_ID"
            else
              echo "âš ï¸ Failed to create pool for $region"
            fi
          done
          
          echo "Created pools: $POOLS"
      
      - name: Configure geo-routing
        run: |
          echo "ðŸ—ºï¸ Configuring geographic routing..."
          
          # Create regional fallback rules
          curl -X PUT "$CLOUDFLARE_API_BASE/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/load_balancers" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "name": "api.pitchey.com",
              "fallback_pool": "pitchey-us-east-pool",
              "default_pools": ["pitchey-us-east-pool"],
              "description": "Multi-region API load balancer",
              "ttl": 30,
              "region_pools": {
                "WNAM": ["pitchey-us-west-pool", "pitchey-us-central-pool"],
                "ENAM": ["pitchey-us-east-pool", "pitchey-us-central-pool"],
                "WEU": ["pitchey-eu-west-pool", "pitchey-eu-central-pool"],
                "EEU": ["pitchey-eu-central-pool", "pitchey-eu-west-pool"],
                "APAC": ["pitchey-ap1-pool", "pitchey-apse2-pool", "pitchey-apne1-pool"]
              },
              "pop_pools": {},
              "country_pools": {},
              "proxied": true,
              "enabled": true,
              "session_affinity": "cookie"
            }'
          
          echo "âœ… Geographic routing configured"

  # Health monitoring across all regions
  global-health-monitoring:
    needs: [deployment-planning, configure-global-routing]
    runs-on: ubuntu-latest
    if: always() && needs.configure-global-routing.result == 'success'
    steps:
      - name: Monitor global health
        run: |
          echo "ðŸ“Š Starting global health monitoring..."
          
          REGIONS='${{ needs.deployment-planning.outputs.regions }}'
          MONITORING_DURATION=600  # 10 minutes
          CHECK_INTERVAL=30
          
          END_TIME=$(($(date +%s) + MONITORING_DURATION))
          
          while [ $(date +%s) -lt $END_TIME ]; do
            echo "ðŸ” Global health check at $(date)"
            
            HEALTHY_REGIONS=0
            TOTAL_REGIONS=$(echo $REGIONS | jq '. | length')
            
            echo $REGIONS | jq -r '.[]' | while read -r region; do
              case "$region" in
                us-east) SUBDOMAIN="use1" ;;
                us-west) SUBDOMAIN="usw2" ;;
                us-central) SUBDOMAIN="usc1" ;;
                eu-west) SUBDOMAIN="euw1" ;;
                eu-central) SUBDOMAIN="euc1" ;;
                asia-pacific) SUBDOMAIN="ap1" ;;
                ap-southeast) SUBDOMAIN="apse2" ;;
                ap-northeast) SUBDOMAIN="apne1" ;;
              esac
              
              HEALTH_URL="https://$SUBDOMAIN-api.pitchey.com/api/health"
              
              if curl -sf "$HEALTH_URL" >/dev/null 2>&1; then
                echo "âœ… $region: healthy"
                HEALTHY_REGIONS=$((HEALTHY_REGIONS + 1))
              else
                echo "âŒ $region: unhealthy"
              fi
            done
            
            HEALTH_PERCENTAGE=$((HEALTHY_REGIONS * 100 / TOTAL_REGIONS))
            echo "Global health: $HEALTHY_REGIONS/$TOTAL_REGIONS regions healthy ($HEALTH_PERCENTAGE%)"
            
            if [ $HEALTH_PERCENTAGE -lt 50 ]; then
              echo "ðŸš¨ CRITICAL: Less than 50% of regions are healthy!"
              
              if [ "${{ inputs.failover_enabled }}" == "true" ]; then
                echo "ðŸ”„ Triggering emergency failover procedures..."
                # Implement emergency failover logic
              fi
            fi
            
            sleep $CHECK_INTERVAL
          done
          
          echo "âœ… Global health monitoring completed"

  # Deployment summary and reporting
  deployment-summary:
    needs: [deployment-planning, regional-deployment, sequential-deployment, canary-deployment, configure-global-routing, global-health-monitoring]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate deployment report
        run: |
          echo "ðŸŒ Multi-Region Deployment Summary"
          echo "=================================="
          echo "Deployment ID: ${{ needs.deployment-planning.outputs.deployment-id }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Strategy: ${{ inputs.rollout_strategy }}"
          echo "Regions: ${{ needs.deployment-planning.outputs.regions }}"
          echo "Failover Enabled: ${{ inputs.failover_enabled }}"
          echo "Timestamp: $(date -u)"
          echo ""
          echo "Results:"
          echo "- Regional Deployment: ${{ needs.regional-deployment.result }}"
          echo "- Sequential Deployment: ${{ needs.sequential-deployment.result }}"
          echo "- Canary Deployment: ${{ needs.canary-deployment.result }}"
          echo "- Global Routing: ${{ needs.configure-global-routing.result }}"
          echo "- Health Monitoring: ${{ needs.global-health-monitoring.result }}"
          
          # Create comprehensive deployment report
          cat > multi-region-deployment-report.json << EOF
          {
            "deploymentId": "${{ needs.deployment-planning.outputs.deployment-id }}",
            "timestamp": "$(date -u --iso-8601=seconds)",
            "commit": "${{ github.sha }}",
            "environment": "${{ inputs.environment }}",
            "strategy": "${{ inputs.rollout_strategy }}",
            "regions": ${{ needs.deployment-planning.outputs.regions }},
            "configuration": {
              "failoverEnabled": ${{ inputs.failover_enabled }},
              "healthCheckTimeout": ${{ inputs.health_check_timeout }}
            },
            "results": {
              "regionalDeployment": "${{ needs.regional-deployment.result }}",
              "sequentialDeployment": "${{ needs.sequential-deployment.result }}",
              "canaryDeployment": "${{ needs.canary-deployment.result }}",
              "globalRouting": "${{ needs.configure-global-routing.result }}",
              "healthMonitoring": "${{ needs.global-health-monitoring.result }}"
            },
            "endpoints": {
              "global": "https://api.pitchey.com",
              "frontend": "https://pitchey.com"
            }
          }
          EOF
      
      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: multi-region-deployment-report
          path: multi-region-deployment-report.json
          retention-days: 90
      
      - name: Notify deployment status
        run: |
          if [ "${{ needs.regional-deployment.result }}" == "success" ] || 
             [ "${{ needs.sequential-deployment.result }}" == "success" ] || 
             [ "${{ needs.canary-deployment.result }}" == "success" ]; then
            echo "ðŸŽ‰ Multi-region deployment completed successfully!"
            
            # Success notification
            # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            #   -H 'Content-type: application/json' \
            #   --data '{"text":"ðŸŒ Multi-region deployment successful for Pitchey '${{ inputs.environment }}'"}'
          else
            echo "âŒ Multi-region deployment failed!"
            
            # Failure notification
            # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            #   -H 'Content-type: application/json' \
            #   --data '{"text":"ðŸš¨ URGENT: Multi-region deployment failed for Pitchey! @channel"}'
          fi