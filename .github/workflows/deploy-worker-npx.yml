name: Deploy Worker via NPX

on:
  workflow_dispatch:
    inputs:
      deploy_auth_fix:
        description: 'Deploy authentication fix'
        type: boolean
        default: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker with NPX Wrangler
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Prepare Auth-Fixed Service
        run: |
          echo "Preparing authentication-fixed worker service..."
          if [ -f "src/worker-service-auth-fixed.ts" ]; then
            echo "Found auth-fixed service, copying to index.ts..."
            cp src/worker-service-auth-fixed.ts src/index.ts
          else
            echo "Auth-fixed service not found, using default"
          fi
          
      - name: Deploy with NPX Wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Deploying with npx wrangler..."
          npx wrangler deploy \
            --compatibility-date 2024-09-23 \
            --name pitchey-optimized \
            --var JWT_SECRET:"${{ secrets.JWT_SECRET }}" \
            --var DATABASE_URL:"${{ secrets.DATABASE_URL }}" \
            --var FRONTEND_URL:"https://pitchey.pages.dev" \
            --var SENTRY_DSN:"${{ secrets.SENTRY_DSN }}"
            
      - name: Test Authentication Fixes
        if: success()
        run: |
          echo "Waiting for deployment..."
          sleep 20
          
          echo "Testing Creator Portal..."
          creator_response=$(curl -s -X POST "https://pitchey-optimized.cavelltheleaddev.workers.dev/api/auth/creator/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"alex.creator@demo.com","password":"Demo123"}')
          
          if echo "$creator_response" | grep -q '"userType":"creator"'; then
            echo "✅ Creator portal fixed - returns correct user type"
          else
            echo "⚠️ Creator portal still needs attention"
            echo "$creator_response"
          fi
          
          echo "Testing Investor Portal..."
          investor_response=$(curl -s -X POST "https://pitchey-optimized.cavelltheleaddev.workers.dev/api/auth/investor/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"sarah.investor@demo.com","password":"Demo123"}')
          
          if echo "$investor_response" | grep -q '"userType":"investor"'; then
            echo "✅ Investor portal fixed - returns correct user type"
          else
            echo "⚠️ Investor portal still needs attention"
            echo "$investor_response"
          fi