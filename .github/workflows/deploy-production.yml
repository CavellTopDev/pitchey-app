name: Deploy to Production
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deployment)'
        required: false
        default: false
        type: boolean

jobs:
  # Run tests before deployment
  test:
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run type checking
        run: npm run type-check
        
      - name: Run linter
        run: npm run lint
        
      - name: Run tests
        run: npm test
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: https://pitchey-api.ndlovucavelle.workers.dev
          VITE_WS_URL: wss://pitchey-api.ndlovucavelle.workers.dev
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

  # Deploy database migrations
  migrate:
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run production migrations
        run: |
          npm run db:migrate:prod
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          
      - name: Verify database health
        run: |
          npm run db:health-check
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}

  # Deploy Cloudflare Worker
  deploy-worker:
    needs: [migrate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Deploy Worker to Cloudflare
        run: |
          npm install -g wrangler
          wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: Update Worker secrets
        run: |
          echo "${{ secrets.NEON_DATABASE_URL }}" | wrangler secret put DATABASE_URL --env production
          echo "${{ secrets.JWT_SECRET }}" | wrangler secret put JWT_SECRET --env production
          echo "${{ secrets.UPSTASH_REDIS_REST_URL }}" | wrangler secret put UPSTASH_REDIS_REST_URL --env production
          echo "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}" | wrangler secret put UPSTASH_REDIS_REST_TOKEN --env production
          echo "${{ secrets.SENTRY_DSN }}" | wrangler secret put SENTRY_DSN --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # Deploy frontend to Cloudflare Pages
  deploy-frontend:
    needs: [deploy-worker]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: https://pitchey-api.ndlovucavelle.workers.dev
          VITE_WS_URL: wss://pitchey-api.ndlovucavelle.workers.dev
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NODE_ENV: production
          
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: pitchey
          directory: frontend/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          deploymentName: production
          wranglerVersion: '3'
          
  # Run smoke tests
  smoke-test:
    needs: [deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Wait for deployment to stabilize
        run: sleep 30
        
      - name: Health check - API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://pitchey-production.cavelltheleaddev.workers.dev/health)
          if [ $response -ne 200 ]; then
            echo "API health check failed with status $response"
            exit 1
          fi
          echo "✅ API is healthy"
          
      - name: Health check - Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://pitchey.pages.dev)
          if [ $response -ne 200 ]; then
            echo "Frontend health check failed with status $response"
            exit 1
          fi
          echo "✅ Frontend is accessible"
          
      - name: Database connectivity check
        run: |
          curl -s https://pitchey-production.cavelltheleaddev.workers.dev/health/database | jq .status
          
      - name: Run E2E smoke tests
        run: |
          npm run test:e2e:smoke
        env:
          BASE_URL: https://pitchey.pages.dev
          API_URL: https://pitchey-production.cavelltheleaddev.workers.dev
          
  # Notify deployment status
  notify:
    needs: [smoke-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send deployment notification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ needs.smoke-test.result }}' === 'success' ? '✅' : '❌';
            const color = '${{ needs.smoke-test.result }}' === 'success' ? '28a745' : 'dc3545';
            
            // Create deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 1,
              state: '${{ needs.smoke-test.result }}' === 'success' ? 'success' : 'failure',
              environment_url: 'https://pitchey.pages.dev',
              description: `Deployment ${status}`,
            });
            
            // Send Slack notification if webhook is configured
            if ('${{ secrets.SLACK_WEBHOOK }}') {
              await fetch('${{ secrets.SLACK_WEBHOOK }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: `${status} Production deployment completed`,
                  attachments: [{
                    color: color,
                    fields: [
                      { title: 'Environment', value: 'Production', short: true },
                      { title: 'Version', value: '${{ github.sha }}'.substring(0, 7), short: true },
                      { title: 'Deployed by', value: '${{ github.actor }}', short: true },
                      { title: 'Status', value: '${{ needs.smoke-test.result }}', short: true },
                    ],
                    actions: [
                      {
                        type: 'button',
                        text: 'View Site',
                        url: 'https://pitchey.pages.dev'
                      },
                      {
                        type: 'button', 
                        text: 'View Deployment',
                        url: '${{ github.event.head_commit.url }}'
                      }
                    ]
                  }]
                })
              });
            }
            
      - name: Create Sentry release
        if: needs.smoke-test.result == 'success'
        run: |
          npm install -g @sentry/cli
          export SENTRY_RELEASE="${{ github.sha }}"
          sentry-cli releases new $SENTRY_RELEASE
          sentry-cli releases set-commits $SENTRY_RELEASE --auto
          sentry-cli releases finalize $SENTRY_RELEASE
          sentry-cli releases deploys $SENTRY_RELEASE new -e production
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}