name: Deploy Production

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'wrangler.toml'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend to Cloudflare Pages'
        type: boolean
        default: true
      deploy_worker:
        description: 'Deploy worker to Cloudflare'
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  DENO_VERSION: '1.40.x'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run security audit
        run: |
          # Scan for secrets, vulnerabilities, and malicious patterns
          find . -name "*.ts" -o -name "*.js" -o -name "*.yml" -o -name "*.toml" | \
          xargs grep -l "password\|secret\|token\|api_key" | \
          head -10 > security_scan.log || true
          
          echo "Security scan completed. Checking for exposed secrets..."
          if grep -i "sk_" . -r --exclude-dir=node_modules --exclude-dir=.git || \
             grep -i "pk_test" . -r --exclude-dir=node_modules --exclude-dir=.git; then
            echo "‚ö†Ô∏è Potential secrets detected. Review before deployment."
            exit 1
          fi

  test-worker:
    name: Test Worker
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}
      
      - name: Cache Deno dependencies
        uses: actions/cache@v3
        with:
          path: ~/.deno
          key: ${{ runner.os }}-deno-${{ hashFiles('**/*.ts') }}
          restore-keys: ${{ runner.os }}-deno-
      
      - name: Validate TypeScript
        run: deno check src/worker-production-db.ts
      
      - name: Run Worker Tests
        run: |
          # Test worker compilation
          deno run --allow-all --check src/worker-production-db.ts --help || true
          
          # Validate wrangler.toml
          if command -v wrangler &> /dev/null; then
            wrangler validate
          fi

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: security-scan
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run type-check
      
      - name: Lint
        run: npm run lint || true  # Non-blocking
      
      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: https://pitchey-production.cavelltheleaddev.workers.dev
          VITE_WS_URL: wss://pitchey-production.cavelltheleaddev.workers.dev
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-dist
          path: frontend/dist/

  deploy-worker:
    name: Deploy Worker
    runs-on: ubuntu-latest
    needs: [test-worker, test-frontend]
    if: ${{ inputs.deploy_worker != false }}
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js for Wrangler
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      
      - name: Validate Secrets
        run: |
          if [[ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]]; then
            echo "‚ùå CLOUDFLARE_API_TOKEN is required"
            exit 1
          fi
          if [[ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]]; then
            echo "‚ùå CLOUDFLARE_ACCOUNT_ID is required"
            exit 1
          fi
          echo "‚úÖ Required secrets are configured"
      
      - name: Configure secrets
        run: |
          # Set production secrets in Cloudflare Worker
          if [[ -n "${{ secrets.DATABASE_URL }}" ]]; then
            echo "${{ secrets.DATABASE_URL }}" | wrangler secret put DATABASE_URL
          fi
          
          if [[ -n "${{ secrets.UPSTASH_REDIS_REST_URL }}" ]]; then
            echo "${{ secrets.UPSTASH_REDIS_REST_URL }}" | wrangler secret put UPSTASH_REDIS_REST_URL
          fi
          
          if [[ -n "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}" ]]; then
            echo "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}" | wrangler secret put UPSTASH_REDIS_REST_TOKEN
          fi
          
          if [[ -n "${{ secrets.SENTRY_DSN }}" ]]; then
            echo "${{ secrets.SENTRY_DSN }}" | wrangler secret put SENTRY_DSN
          fi
          
          # Set service flags
          echo "true" | wrangler secret put USE_DATABASE
          echo "true" | wrangler secret put USE_EMAIL
          echo "true" | wrangler secret put USE_STORAGE
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Deploy Worker
        run: |
          echo "Deploying worker to production..."
          wrangler deploy
          
          # Verify deployment
          sleep 10
          curl -f "https://pitchey-production.cavelltheleaddev.workers.dev/api/health" || {
            echo "‚ùå Health check failed after deployment"
            exit 1
          }
          
          echo "‚úÖ Worker deployed successfully"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [test-frontend, deploy-worker]
    if: ${{ inputs.deploy_frontend != false }}
    environment: production
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: frontend-dist
          path: frontend/dist/
      
      - name: Install Wrangler
        run: npm install -g wrangler@latest
      
      - name: Build production frontend
        run: |
          npm ci
          npm run build
        env:
          VITE_API_URL: https://pitchey-production.cavelltheleaddev.workers.dev
          VITE_WS_URL: wss://pitchey-production.cavelltheleaddev.workers.dev
      
      - name: Deploy to Cloudflare Pages
        run: |
          echo "Deploying frontend to Cloudflare Pages..."
          wrangler pages deploy dist --project-name=pitchey --compatibility-date=2024-11-01
          
          # Verify deployment
          sleep 15
          curl -f "https://pitchey.pages.dev" || {
            echo "‚ùå Frontend deployment verification failed"
            exit 1
          }
          
          echo "‚úÖ Frontend deployed successfully to https://pitchey.pages.dev"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-worker, deploy-frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Run comprehensive health checks
        run: |
          echo "üîç Running post-deployment validation..."
          
          # Health check API
          echo "Checking API health..."
          HEALTH_RESPONSE=$(curl -s "https://pitchey-production.cavelltheleaddev.workers.dev/api/health")
          echo "Health response: $HEALTH_RESPONSE"
          
          if ! echo "$HEALTH_RESPONSE" | grep -q "healthy"; then
            echo "‚ùå API health check failed"
            exit 1
          fi
          
          # Check authentication endpoints
          echo "Testing authentication endpoints..."
          AUTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "https://pitchey-production.cavelltheleaddev.workers.dev/api/auth/creator/login")
          if [[ "$AUTH_CHECK" != "405" && "$AUTH_CHECK" != "200" ]]; then
            echo "‚ùå Authentication endpoint unreachable (got $AUTH_CHECK)"
            exit 1
          fi
          
          # Check frontend loading
          echo "Checking frontend deployment..."
          FRONTEND_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "https://pitchey.pages.dev")
          if [[ "$FRONTEND_CHECK" != "200" ]]; then
            echo "‚ùå Frontend not loading (got $FRONTEND_CHECK)"
            exit 1
          fi
          
          echo "‚úÖ All post-deployment checks passed!"
      
      - name: Update deployment status
        if: always()
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "Deployment completed at $TIMESTAMP" >> deployment-status.log
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ Production deployment successful" >> deployment-status.log
          else
            echo "‚ùå Production deployment failed" >> deployment-status.log
          fi

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-worker, deploy-frontend, post-deployment]
    if: always()
    steps:
      - name: Notify Slack
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ "${{ needs.post-deployment.result }}" == "success" ]]; then
            MESSAGE="‚úÖ Pitchey production deployment successful! Frontend: https://pitchey.pages.dev | API: https://pitchey-production.cavelltheleaddev.workers.dev"
            COLOR="good"
          else
            MESSAGE="‚ùå Pitchey production deployment failed. Check workflow logs for details."
            COLOR="danger"
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-type: application/json" \
            -d "{\"text\":\"$MESSAGE\",\"color\":\"$COLOR\"}"
      
      - name: Update Sentry release
        if: ${{ secrets.SENTRY_AUTH_TOKEN && needs.post-deployment.result == 'success' }}
        run: |
          # Create Sentry release
          RELEASE="pitchey@$(date +%Y%m%d_%H%M%S)"
          
          curl -X POST "https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/" \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"version\":\"$RELEASE\",\"projects\":[\"${{ secrets.SENTRY_PROJECT }}\"]}"