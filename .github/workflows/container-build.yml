name: Container Build Matrix

# Optimized container build workflow supporting both Docker and Podman
# with comprehensive testing and multi-platform support

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'Dockerfile*'
      - '*compose*.yml'
      - 'scripts/build-automation.sh'
      - '.github/workflows/container-build.yml'
  pull_request:
    branches: [main, develop]
  schedule:
    # Weekly builds to catch base image updates
    - cron: '0 6 * * 1'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  # =============================================================================
  # Build Matrix Generation
  # =============================================================================
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate build matrix
        id: generate
        run: |
          # Generate comprehensive build matrix
          matrix=$(cat << 'EOF'
          {
            "runtime": [
              {
                "name": "podman",
                "runner": "ubuntu-latest",
                "setup_cmd": "sudo apt-get update && sudo apt-get install -y podman",
                "build_cmd": "podman",
                "compose_cmd": "podman-compose"
              },
              {
                "name": "docker", 
                "runner": "ubuntu-latest",
                "setup_cmd": "echo 'Docker pre-installed'",
                "build_cmd": "docker",
                "compose_cmd": "docker-compose"
              }
            ],
            "component": [
              {
                "name": "frontend",
                "dockerfile": "frontend/Dockerfile.prod",
                "context": "frontend",
                "test_cmd": "npm test",
                "port": "8080"
              },
              {
                "name": "worker",
                "dockerfile": "Dockerfile.worker", 
                "context": ".",
                "test_cmd": "deno test",
                "port": "8787"
              },
              {
                "name": "nginx",
                "dockerfile": "Dockerfile.nginx",
                "context": ".",
                "test_cmd": "nginx -t",
                "port": "80"
              }
            ]
          }
          EOF
          )
          
          echo "matrix=${matrix}" >> $GITHUB_OUTPUT

      - name: Check if deployment needed
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # Security and Quality Checks
  # =============================================================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      - name: Run Hadolint Dockerfile linting
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: frontend/Dockerfile.prod
          failure-threshold: warning

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # =============================================================================
  # Multi-Runtime Container Builds
  # =============================================================================
  build-containers:
    name: Build ${{ matrix.component.name }} (${{ matrix.runtime.name }})
    runs-on: ${{ matrix.runtime.runner }}
    needs: [prepare-matrix, security-scan]
    if: always() && !cancelled() && needs.security-scan.result != 'failure'
    strategy:
      fail-fast: false
      matrix:
        runtime: ${{ fromJson(needs.prepare-matrix.outputs.matrix).runtime }}
        component: ${{ fromJson(needs.prepare-matrix.outputs.matrix).component }}
    env:
      BUILD_RUNTIME: ${{ matrix.runtime.name }}
      COMPONENT: ${{ matrix.component.name }}
      IMAGE_TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component.name }}:${{ github.sha }}
      LATEST_TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component.name }}:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup container runtime
        run: ${{ matrix.runtime.setup_cmd }}

      - name: Configure Podman for rootless operation
        if: matrix.runtime.name == 'podman'
        run: |
          # Setup rootless Podman
          sudo usermod --add-subuids 10000-75535 $USER || true
          sudo usermod --add-subgids 10000-75535 $USER || true
          
          # Create required directories
          mkdir -p ~/.config/containers
          mkdir -p ~/.local/share/containers/storage
          
          # Configure registries
          cat > ~/.config/containers/registries.conf << 'EOF'
          [registries.search]
          registries = ['docker.io', 'quay.io', 'ghcr.io']
          
          [registries.insecure]
          registries = []
          EOF
          
          # Test Podman
          podman info
          echo "Podman rootless configuration completed"

      - name: Set up Docker Buildx
        if: matrix.runtime.name == 'docker'
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ env.PLATFORMS }}

      - name: Set up QEMU for multi-platform builds
        if: contains(env.PLATFORMS, 'arm64')
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Log in to Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            ${{ matrix.runtime.build_cmd }} login ${{ env.REGISTRY }} \
              -u ${{ github.actor }} --password-stdin

      - name: Generate build metadata
        id: meta
        run: |
          # Generate comprehensive build metadata
          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          VERSION="${{ github.sha }}"
          
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          fi
          
          # Tags
          TAGS="${{ env.IMAGE_TAG }}"
          TAGS="${TAGS},${{ env.LATEST_TAG }}"
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component.name }}:stable"
          fi
          
          # Labels (OCI compliant)
          LABELS="org.opencontainers.image.title=${{ matrix.component.name }}"
          LABELS="${LABELS},org.opencontainers.image.description=Pitchey ${{ matrix.component.name }} container"
          LABELS="${LABELS},org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}"
          LABELS="${LABELS},org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}"
          LABELS="${LABELS},org.opencontainers.image.version=${VERSION}"
          LABELS="${LABELS},org.opencontainers.image.created=${TIMESTAMP}"
          LABELS="${LABELS},org.opencontainers.image.revision=${{ github.sha }}"
          LABELS="${LABELS},org.opencontainers.image.licenses=MIT"
          LABELS="${LABELS},org.opencontainers.image.vendor=Pitchey"
          LABELS="${LABELS},pitchey.component=${{ matrix.component.name }}"
          LABELS="${LABELS},pitchey.runtime=${{ matrix.runtime.name }}"
          LABELS="${LABELS},pitchey.build-id=${{ github.run_id }}"
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "labels=${LABELS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Generate Dockerfile if needed
        run: |
          if [[ ! -f "${{ matrix.component.dockerfile }}" ]]; then
            echo "Generating Dockerfile for ${{ matrix.component.name }}..."
            chmod +x scripts/build-automation.sh
            ./scripts/build-automation.sh ${{ matrix.component.name }}
          fi

      - name: Build container image (Podman)
        if: matrix.runtime.name == 'podman'
        run: |
          # Build with Podman for each platform
          IFS=',' read -ra PLATFORMS_ARRAY <<< "${{ env.PLATFORMS }}"
          
          for platform in "${PLATFORMS_ARRAY[@]}"; do
            echo "Building ${{ matrix.component.name }} for ${platform} with Podman..."
            
            # Build arguments
            BUILD_ARGS=(
              "--platform" "${platform}"
              "--build-arg" "BUILD_VERSION=${{ steps.meta.outputs.version }}"
              "--build-arg" "BUILD_TIMESTAMP=${{ steps.meta.outputs.timestamp }}"
              "--build-arg" "BUILD_RUNTIME=${{ matrix.runtime.name }}"
              "--build-arg" "COMPONENT=${{ matrix.component.name }}"
            )
            
            # Add labels
            IFS=',' read -ra LABELS_ARRAY <<< "${{ steps.meta.outputs.labels }}"
            for label in "${LABELS_ARRAY[@]}"; do
              BUILD_ARGS+=("--label" "${label}")
            done
            
            # Add tags (only on first platform to avoid conflicts)
            if [[ "${platform}" == "linux/amd64" ]]; then
              IFS=',' read -ra TAGS_ARRAY <<< "${{ steps.meta.outputs.tags }}"
              for tag in "${TAGS_ARRAY[@]}"; do
                BUILD_ARGS+=("--tag" "${tag}")
              done
            fi
            
            # Execute build
            podman build \
              "${BUILD_ARGS[@]}" \
              --file "${{ matrix.component.dockerfile }}" \
              "${{ matrix.component.context }}"
          done

      - name: Build container image (Docker)
        if: matrix.runtime.name == 'docker'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.component.context }}
          file: ${{ matrix.component.dockerfile }}
          platforms: ${{ env.PLATFORMS }}
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.component.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.component.name }}
          build-args: |
            BUILD_VERSION=${{ steps.meta.outputs.version }}
            BUILD_TIMESTAMP=${{ steps.meta.outputs.timestamp }}
            BUILD_RUNTIME=${{ matrix.runtime.name }}
            COMPONENT=${{ matrix.component.name }}

      - name: Test container functionality
        run: |
          echo "Testing ${{ matrix.component.name }} container..."
          
          # Start container for testing
          CONTAINER_ID=$(
            ${{ matrix.runtime.build_cmd }} run -d --rm \
              -p "${{ matrix.component.port }}:${{ matrix.component.port }}" \
              ${{ env.LATEST_TAG }} || echo ""
          )
          
          if [[ -z "$CONTAINER_ID" ]]; then
            echo "Failed to start container for testing"
            exit 1
          fi
          
          echo "Container started: $CONTAINER_ID"
          
          # Wait for container to be ready
          sleep 10
          
          # Basic health check
          if [[ "${{ matrix.component.name }}" == "frontend" ]]; then
            # Test frontend health endpoint
            curl -f "http://localhost:${{ matrix.component.port }}/health" || true
          elif [[ "${{ matrix.component.name }}" == "worker" ]]; then
            # Test worker API
            curl -f "http://localhost:${{ matrix.component.port }}/api/health" || true
          elif [[ "${{ matrix.component.name }}" == "nginx" ]]; then
            # Test nginx
            curl -f "http://localhost:${{ matrix.component.port }}/" || true
          fi
          
          # Stop container
          ${{ matrix.runtime.build_cmd }} stop "$CONTAINER_ID" || true
          
          echo "Container test completed successfully"

      - name: Run container security scan
        run: |
          # Scan container with Trivy
          if command -v trivy >/dev/null 2>&1; then
            echo "Scanning container image for vulnerabilities..."
            trivy image --exit-code 1 --severity HIGH,CRITICAL ${{ env.LATEST_TAG }}
          else
            echo "Trivy not available, skipping container security scan"
          fi

      - name: Push container image
        if: needs.prepare-matrix.outputs.should-deploy == 'true' || github.event_name == 'push'
        run: |
          echo "Pushing container images..."
          
          if [[ "${{ matrix.runtime.name }}" == "podman" ]]; then
            # Push with Podman
            IFS=',' read -ra TAGS_ARRAY <<< "${{ steps.meta.outputs.tags }}"
            for tag in "${TAGS_ARRAY[@]}"; do
              echo "Pushing: ${tag}"
              podman push "${tag}"
            done
          else
            echo "Docker push will be handled by build action"
          fi

      - name: Push container image (Docker)
        if: matrix.runtime.name == 'docker' && (needs.prepare-matrix.outputs.should-deploy == 'true' || github.event_name == 'push')
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.component.context }}
          file: ${{ matrix.component.dockerfile }}
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.component.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.component.name }}

  # =============================================================================
  # Integration Testing
  # =============================================================================
  integration-test:
    name: Integration Testing (${{ matrix.runtime.name }})
    runs-on: ubuntu-latest
    needs: [prepare-matrix, build-containers]
    if: always() && !cancelled()
    strategy:
      fail-fast: false
      matrix:
        runtime: ${{ fromJson(needs.prepare-matrix.outputs.matrix).runtime }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup container runtime
        run: ${{ matrix.runtime.setup_cmd }}

      - name: Configure container runtime for testing
        if: matrix.runtime.name == 'podman'
        run: |
          # Setup Podman for testing
          sudo usermod --add-subuids 10000-75535 $USER || true
          sudo usermod --add-subgids 10000-75535 $USER || true
          mkdir -p ~/.config/containers ~/.local/share/containers/storage
          podman info

      - name: Start development stack
        run: |
          echo "Starting development stack with ${{ matrix.runtime.name }}..."
          
          if [[ "${{ matrix.runtime.name }}" == "podman" ]]; then
            # Use podman-compose or docker-compose with podman socket
            if command -v podman-compose >/dev/null 2>&1; then
              podman-compose -f podman-compose.yml up -d
            else
              DOCKER_HOST="unix://${XDG_RUNTIME_DIR}/podman/podman.sock" \
                docker-compose -f podman-compose.yml up -d
            fi
          else
            docker-compose -f docker-compose.yml up -d
          fi
          
          # Wait for services to be ready
          sleep 30

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          
          # Test database connectivity
          if ${{ matrix.runtime.build_cmd }} ps | grep -q postgres; then
            echo "âœ… PostgreSQL container is running"
          else
            echo "âŒ PostgreSQL container not found"
            exit 1
          fi
          
          # Test Redis connectivity
          if ${{ matrix.runtime.build_cmd }} ps | grep -q redis; then
            echo "âœ… Redis container is running"
          else
            echo "âŒ Redis container not found"
            exit 1
          fi
          
          # Test service endpoints
          endpoints=(
            "http://localhost:5432"  # PostgreSQL
            "http://localhost:6380"  # Redis
            "http://localhost:9000"  # MinIO
            "http://localhost:8080"  # Adminer
          )
          
          for endpoint in "${endpoints[@]}"; do
            if curl -sf "${endpoint}" >/dev/null 2>&1; then
              echo "âœ… ${endpoint} is accessible"
            else
              echo "âš ï¸  ${endpoint} not accessible (may be expected)"
            fi
          done

      - name: Cleanup test environment
        if: always()
        run: |
          echo "Cleaning up test environment..."
          
          if [[ "${{ matrix.runtime.name }}" == "podman" ]]; then
            if command -v podman-compose >/dev/null 2>&1; then
              podman-compose -f podman-compose.yml down -v || true
            else
              DOCKER_HOST="unix://${XDG_RUNTIME_DIR}/podman/podman.sock" \
                docker-compose -f podman-compose.yml down -v || true
            fi
          else
            docker-compose -f docker-compose.yml down -v || true
          fi
          
          # Clean up containers and images
          ${{ matrix.runtime.build_cmd }} system prune -af || true

  # =============================================================================
  # Performance Benchmarking
  # =============================================================================
  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: [prepare-matrix, build-containers]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run performance benchmarks
        run: |
          echo "Running performance benchmarks..."
          
          # Container build time comparison
          echo "## Build Performance Comparison" > performance-report.md
          echo "| Component | Docker Build Time | Podman Build Time |" >> performance-report.md
          echo "|-----------|-------------------|-------------------|" >> performance-report.md
          
          # This would typically pull build times from the matrix jobs
          echo "| Frontend | TBD | TBD |" >> performance-report.md
          echo "| Worker | TBD | TBD |" >> performance-report.md
          echo "| Nginx | TBD | TBD |" >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md

  # =============================================================================
  # Summary and Notifications
  # =============================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [prepare-matrix, build-containers, integration-test]
    if: always()
    steps:
      - name: Generate build summary
        run: |
          echo "# Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** ${{ env.PLATFORMS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime | Status | Components |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.build-containers.result }} | Frontend, Worker, Nginx |" >> $GITHUB_STEP_SUMMARY
          echo "| Podman | ${{ needs.build-containers.result }} | Frontend, Worker, Nginx |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.integration-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Podman | ${{ needs.integration-test.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-containers.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.prepare-matrix.outputs.should-deploy }}" == "true" ]]; then
              echo "- âœ… Images pushed to ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸš€ Ready for deployment" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Images built successfully" >> $GITHUB_STEP_SUMMARY
              echo "- â„¹ï¸  No deployment scheduled for this build" >> $GITHUB_STEP_SUMMARY
            fi
          fi