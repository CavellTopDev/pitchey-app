name: Deploy Full Stack to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DENO_PROJECT: "pitchey-backend-fresh"
  CLOUDFLARE_PAGES_PROJECT: "pitchey"
  WORKER_NAME: "pitchey-api-production"

jobs:
  deploy-backend:
    name: Deploy Backend (Deno Deploy)
    runs-on: ubuntu-latest
    outputs:
      backend-url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Deploy to Deno Deploy (DISABLED - Migrated to Cloudflare)
        id: deploy
        run: |
          deno install -A -f https://deno.land/x/deploy/deployctl.ts
          
          echo "âš ï¸ Deno Deploy disabled - using Cloudflare Workers instead"
          echo "To deploy: wrangler deploy"
          exit 0  # Skip Deno deployment
          deployctl deploy \
            --project=${{ env.DENO_PROJECT }} \
            --entrypoint=working-server.ts \
            --token=${{ secrets.DENO_DEPLOY_TOKEN }} \
            --env="DATABASE_URL=${{ secrets.NEON_DATABASE_URL }}" \
            --env="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --env="DENO_ENV=production" \
            --env="NODE_ENV=production" \
            --env="FRONTEND_URL=https://pitchey.pages.dev" \
            --env="SENTRY_DSN=${{ secrets.SENTRY_DSN }}" \
            --production
            
      - name: Test Backend
        run: |
          sleep 10
          echo "Testing backend deployment..."
          
          # Test health
          curl -f "https://${{ env.DENO_PROJECT }}.deno.dev/" || echo "Health check failed"
          
          # Test browse endpoint
          response=$(curl -s "https://${{ env.DENO_PROJECT }}.deno.dev/api/browse?tab=trending")
          echo "Browse response: $response"

  deploy-worker:
    name: Deploy Worker (Cloudflare)
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: success()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler deploy

      - name: Test Worker
        run: |
          sleep 5
          echo "Testing Worker deployment..."
          curl -f "https://pitchey-api-production.cavelltheleaddev.workers.dev/api/browse?tab=trending" || echo "Worker test failed"

  deploy-frontend:
    name: Deploy Frontend (Cloudflare Pages)
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-worker]
    if: success()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_URL: https://pitchey-api-production.cavelltheleaddev.workers.dev
          VITE_WS_URL: wss://pitchey-backend-fresh.deno.dev/ws
          VITE_NODE_ENV: production
        run: npm run build

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler pages deploy frontend/dist --project-name=pitchey --compatibility-date=2024-11-01

      - name: Test Full Stack
        run: |
          sleep 10
          echo "Testing full stack deployment..."
          
          # Test frontend
          frontend_status=$(curl -s -o /dev/null -w "%{http_code}" "https://pitchey.pages.dev")
          echo "Frontend status: $frontend_status"
          
          # Test API through Worker
          api_status=$(curl -s -o /dev/null -w "%{http_code}" "https://pitchey-api-production.cavelltheleaddev.workers.dev/api/browse?tab=trending")
          echo "API status: $api_status"
          
          if [ "$frontend_status" = "200" ] && [ "$api_status" = "200" ]; then
            echo "ðŸš€ Full stack deployment successful!"
          else
            echo "âŒ Full stack deployment has issues"
          fi

  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-worker, deploy-frontend]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Deno) | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker (Cloudflare) | ${{ needs.deploy-worker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (Pages) | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Production URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://pitchey.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: https://pitchey-api-production.cavelltheleaddev.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://pitchey-backend-fresh.deno.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Browse**: https://pitchey.pages.dev/browse" >> $GITHUB_STEP_SUMMARY