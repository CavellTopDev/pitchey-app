# Custom Falco Rules for Pitchey Container Services
# Runtime security rules for detecting threats and policy violations

# Pitchey-specific macros and lists
- list: pitchey_services
  items: [pitchey-video-processor, pitchey-document-processor, pitchey-ai-inference, 
          pitchey-media-transcoder, pitchey-code-executor, pitchey-gateway, pitchey-redis]

- list: pitchey_sensitive_files
  items: [/etc/passwd, /etc/shadow, /etc/hosts, /etc/hostname, /root/.ssh,
          /home/*/.ssh, /etc/ssl, /etc/nginx, /etc/security]

- list: pitchey_allowed_executables
  items: [python3, python, node, nginx, redis-server, ffmpeg, pandoc, 
          gunicorn, uvicorn]

- list: pitchey_suspicious_network_tools
  items: [nc, netcat, ncat, telnet, wget, curl, nmap, masscan, sqlmap,
          nikto, dirb, gobuster, hydra]

- list: pitchey_crypto_miners
  items: [xmrig, cgminer, bfgminer, ethminer, t-rex, gminer, lolminer,
          teamredminer, nbminer, phoenixminer]

- macro: pitchey_container
  condition: (container.name in (pitchey_services))

- macro: sensitive_file_access
  condition: (fd.name in (pitchey_sensitive_files))

# Custom Rules for Pitchey Platform

# 1. Privilege Escalation Detection
- rule: Privilege Escalation in Pitchey Container
  desc: Detect privilege escalation attempts in Pitchey containers
  condition: >
    pitchey_container and spawned_process and 
    (proc.name in (sudo, su) or 
     proc.cmdline contains "chmod +s" or
     proc.cmdline contains "setuid" or
     proc.cmdline contains "setgid")
  output: >
    Privilege escalation attempt detected in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     cmdline=%proc.cmdline image=%container.image.repository)
  priority: HIGH
  tags: [privilege_escalation, pitchey]

# 2. Unauthorized Process Execution
- rule: Suspicious Process in Pitchey Container
  desc: Detect unauthorized or suspicious process execution
  condition: >
    pitchey_container and spawned_process and
    proc.name not in (pitchey_allowed_executables) and
    not proc.name in (sh, bash, dash) and
    not proc.pname in (pitchey_allowed_executables)
  output: >
    Unauthorized process executed in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     parent=%proc.pname cmdline=%proc.cmdline image=%container.image.repository)
  priority: MEDIUM
  tags: [unauthorized_process, pitchey]

# 3. Network Reconnaissance Tools
- rule: Network Reconnaissance in Pitchey Container
  desc: Detect network reconnaissance tools execution
  condition: >
    pitchey_container and spawned_process and
    proc.name in (pitchey_suspicious_network_tools)
  output: >
    Network reconnaissance tool detected in Pitchey container
    (user=%user.name container=%container.name tool=%proc.name 
     cmdline=%proc.cmdline image=%container.image.repository)
  priority: HIGH
  tags: [reconnaissance, network_tools, pitchey]

# 4. Cryptocurrency Mining Detection
- rule: Cryptocurrency Mining in Pitchey Container
  desc: Detect cryptocurrency mining activities
  condition: >
    pitchey_container and 
    (spawned_process and proc.name in (pitchey_crypto_miners)) or
    (outbound and fd.sip_name matches "*pool*" or fd.sip_name matches "*stratum*")
  output: >
    Cryptocurrency mining activity detected in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     connection=%fd.sip:%fd.sport image=%container.image.repository)
  priority: CRITICAL
  tags: [crypto_mining, pitchey]

# 5. Sensitive File Access
- rule: Sensitive File Access in Pitchey Container
  desc: Detect unauthorized access to sensitive files
  condition: >
    pitchey_container and open_read and 
    sensitive_file_access and
    not proc.name in (pitchey_allowed_executables)
  output: >
    Sensitive file accessed in Pitchey container
    (user=%user.name container=%container.name file=%fd.name 
     proc=%proc.name cmdline=%proc.cmdline image=%container.image.repository)
  priority: HIGH
  tags: [sensitive_file_access, pitchey]

# 6. Container Escape Attempt
- rule: Container Escape Attempt in Pitchey
  desc: Detect potential container escape attempts
  condition: >
    pitchey_container and 
    (open_read and fd.name startswith /proc/self/root) or
    (spawned_process and proc.cmdline contains "docker" and proc.cmdline contains "exec") or
    (spawned_process and proc.cmdline contains "runc") or
    (spawned_process and proc.cmdline contains "ctr")
  output: >
    Container escape attempt detected in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     cmdline=%proc.cmdline file=%fd.name image=%container.image.repository)
  priority: CRITICAL
  tags: [container_escape, pitchey]

# 7. Reverse Shell Detection
- rule: Reverse Shell in Pitchey Container
  desc: Detect reverse shell establishment attempts
  condition: >
    pitchey_container and 
    ((spawned_process and proc.name in (bash, sh, dash) and 
      proc.cmdline contains "/dev/tcp") or
     (spawned_process and proc.name in (nc, netcat, ncat) and 
      proc.cmdline contains "-e") or
     (outbound and proc.name in (bash, sh, dash, python, python3) and 
      fd.sport > 32767))
  output: >
    Reverse shell detected in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     cmdline=%proc.cmdline connection=%fd.cip:%fd.cport image=%container.image.repository)
  priority: CRITICAL
  tags: [reverse_shell, pitchey]

# 8. File System Tampering
- rule: System Binary Modification in Pitchey Container
  desc: Detect modification of system binaries
  condition: >
    pitchey_container and 
    (open_write and fd.name startswith /usr/bin) or
    (open_write and fd.name startswith /usr/sbin) or
    (open_write and fd.name startswith /bin) or
    (open_write and fd.name startswith /sbin)
  output: >
    System binary modification detected in Pitchey container
    (user=%user.name container=%container.name file=%fd.name 
     proc=%proc.name cmdline=%proc.cmdline image=%container.image.repository)
  priority: HIGH
  tags: [file_tampering, pitchey]

# 9. Unauthorized Network Connections
- rule: Unexpected Outbound Connection from Pitchey Container
  desc: Detect unexpected outbound network connections
  condition: >
    pitchey_container and outbound and 
    not fd.sip in (redis, nginx) and
    not fd.sport in (80, 443, 53, 6379, 5432) and
    fd.sip != "127.0.0.1" and fd.sip != "localhost"
  output: >
    Unexpected outbound connection from Pitchey container
    (user=%user.name container=%container.name connection=%fd.cip:%fd.cport->%fd.sip:%fd.sport 
     proc=%proc.name image=%container.image.repository)
  priority: MEDIUM
  tags: [network_anomaly, pitchey]

# 10. Root User Activity
- rule: Root User Activity in Pitchey Container
  desc: Detect activities performed by root user
  condition: >
    pitchey_container and user.name = root and 
    spawned_process and 
    not proc.name in (pitchey_allowed_executables)
  output: >
    Root user activity detected in Pitchey container
    (container=%container.name proc=%proc.name cmdline=%proc.cmdline 
     image=%container.image.repository)
  priority: MEDIUM
  tags: [root_activity, pitchey]

# 11. Secret File Access
- rule: Secret or Key File Access in Pitchey Container
  desc: Detect access to secret or key files
  condition: >
    pitchey_container and open_read and
    (fd.name contains "secret" or fd.name contains "password" or 
     fd.name contains ".key" or fd.name contains "credential" or
     fd.name contains "token" or fd.name endswith ".pem")
  output: >
    Secret file access detected in Pitchey container
    (user=%user.name container=%container.name file=%fd.name 
     proc=%proc.name image=%container.image.repository)
  priority: HIGH
  tags: [secret_access, pitchey]

# 12. Suspicious Download Activity
- rule: Suspicious Download in Pitchey Container
  desc: Detect suspicious file download activities
  condition: >
    pitchey_container and spawned_process and
    ((proc.name in (wget, curl) and 
      (proc.cmdline contains "http://" or proc.cmdline contains "https://")) or
     (proc.name in (python, python3) and proc.cmdline contains "urllib") or
     (proc.name in (python, python3) and proc.cmdline contains "requests"))
  output: >
    Suspicious download activity in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     cmdline=%proc.cmdline image=%container.image.repository)
  priority: MEDIUM
  tags: [suspicious_download, pitchey]

# 13. Container Resource Abuse
- rule: High CPU Usage Process in Pitchey Container
  desc: Detect processes consuming excessive CPU resources
  condition: >
    pitchey_container and spawned_process and
    proc.cpu_usage > 80
  output: >
    High CPU usage process in Pitchey container
    (user=%user.name container=%container.name proc=%proc.name 
     cpu_usage=%proc.cpu_usage cmdline=%proc.cmdline image=%container.image.repository)
  priority: MEDIUM
  tags: [resource_abuse, pitchey]

# 14. Log Tampering Detection
- rule: Log File Modification in Pitchey Container
  desc: Detect unauthorized log file modifications
  condition: >
    pitchey_container and 
    (open_write and fd.name startswith /var/log) and
    not proc.name in (rsyslog, syslog-ng, fluentd, filebeat)
  output: >
    Log file modification detected in Pitchey container
    (user=%user.name container=%container.name file=%fd.name 
     proc=%proc.name image=%container.image.repository)
  priority: HIGH
  tags: [log_tampering, pitchey]

# 15. Persistence Mechanism Detection
- rule: Persistence Mechanism in Pitchey Container
  desc: Detect attempts to establish persistence mechanisms
  condition: >
    pitchey_container and 
    ((open_write and fd.name in (/etc/crontab, /var/spool/cron, /etc/systemd)) or
     (spawned_process and proc.name = crontab) or
     (open_write and fd.name startswith /home and fd.name contains ".ssh/authorized_keys"))
  output: >
    Persistence mechanism detected in Pitchey container
    (user=%user.name container=%container.name file=%fd.name 
     proc=%proc.name cmdline=%proc.cmdline image=%container.image.repository)
  priority: HIGH
  tags: [persistence, pitchey]