<!DOCTYPE html>
<html>
<head>
    <title>üî¥ LIVE Production WebSocket Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .debug-section { margin: 20px 0; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .success { background: #dcfce7; border-color: #16a34a; }
        .error { background: #fef2f2; border-color: #dc2626; }
        .info { background: #dbeafe; border-color: #2563eb; }
        .warning { background: #fef3c7; border-color: #d97706; }
        button { 
            background: #3b82f6; color: white; padding: 10px 20px; 
            border: none; border-radius: 4px; margin: 5px; cursor: pointer; 
        }
        button:hover { background: #2563eb; }
        .log { 
            background: #1f2937; color: #e5e7eb; padding: 15px; border-radius: 4px; 
            max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;
            white-space: pre-wrap; word-break: break-word;
        }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.connected { background: #16a34a; color: white; }
        .status.disconnected { background: #dc2626; color: white; }
        .status.connecting { background: #d97706; color: white; }
        iframe { width: 100%; height: 300px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>üî¥ LIVE Production WebSocket Debug Tool</h1>
    
    <div class="debug-section info">
        <h3>üéØ Testing LIVE Production Site</h3>
        <p><strong>Site:</strong> https://pitchey.pages.dev/</p>
        <p><strong>Backend:</strong> https://pitchey-backend-fresh.deno.dev/</p>
        <p><strong>Purpose:</strong> Capture REAL console errors and WebSocket issues</p>
    </div>

    <div class="debug-section">
        <h3>üß™ Live Tests</h3>
        <button onclick="testProductionAPI()">1. Test Production API</button>
        <button onclick="testProductionWebSocket()">2. Test Production WebSocket</button>
        <button onclick="testWithRealAuth()">3. Test with Real Auth Token</button>
        <button onclick="simulateUserLogin()">4. Simulate User Login Flow</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="debug-section">
        <h3>üìä Live Status</h3>
        <div><strong>API Status:</strong> <span id="apiStatus" class="status disconnected">Unknown</span></div>
        <div style="margin-top: 8px;"><strong>WebSocket Status:</strong> <span id="wsStatus" class="status disconnected">Disconnected</span></div>
        <div style="margin-top: 8px;"><strong>Auth Status:</strong> <span id="authStatus">Unknown</span></div>
    </div>

    <div class="debug-section">
        <h3>üîç Live Debug Log</h3>
        <div id="log" class="log">üî¥ LIVE Production Debug Tool Ready...\n</div>
    </div>

    <div class="debug-section warning">
        <h3>üö® What We're Looking For</h3>
        <ul>
            <li><strong>WebSocket Connection Failures:</strong> CORS errors, 401 auth errors, upgrade failures</li>
            <li><strong>Console Spam:</strong> Infinite retry loops, repeated error messages</li>
            <li><strong>Authentication Issues:</strong> JWT token problems, missing/invalid tokens</li>
            <li><strong>Network Errors:</strong> Failed API calls, blocked requests</li>
            <li><strong>JavaScript Errors:</strong> Uncaught exceptions, type errors</li>
        </ul>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const apiStatus = document.getElementById('apiStatus');
        const wsStatus = document.getElementById('wsStatus');
        const authStatus = document.getElementById('authStatus');
        
        let currentWs = null;
        let errorCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const colorMap = {
                'error': '#ef4444',
                'success': '#22c55e', 
                'info': '#3b82f6',
                'warning': '#f59e0b'
            };
            const color = colorMap[type] || '#e5e7eb';
            
            logDiv.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            if (type === 'error') errorCount++;
        }
        
        function clearLog() {
            logDiv.innerHTML = 'üî¥ Debug log cleared...\n';
            errorCount = 0;
        }
        
        function updateStatus(status, element, className) {
            element.textContent = status;
            element.className = `status ${className}`;
        }

        // Test 1: Production API
        async function testProductionAPI() {
            log('üåê Testing Production API connectivity...', 'info');
            
            try {
                const response = await fetch('https://pitchey-backend-fresh.deno.dev/api/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API is responding: ${JSON.stringify(data)}`, 'success');
                    updateStatus('‚úÖ Online', apiStatus, 'connected');
                } else {
                    log(`‚ö†Ô∏è API returned status ${response.status}`, 'warning');
                    updateStatus(`‚ö†Ô∏è ${response.status}`, apiStatus, 'disconnected');
                }
            } catch (error) {
                log(`‚ùå API connection failed: ${error.message}`, 'error');
                updateStatus('‚ùå Offline', apiStatus, 'disconnected');
            }
        }

        // Test 2: Production WebSocket
        async function testProductionWebSocket() {
            log('üîå Testing Production WebSocket (no auth)...', 'info');
            
            if (currentWs) {
                currentWs.close();
                currentWs = null;
            }
            
            const wsUrl = 'wss://pitchey-backend-fresh.deno.dev/ws';
            log(`Attempting connection to: ${wsUrl}`, 'info');
            
            try {
                currentWs = new WebSocket(wsUrl);
                updateStatus('Connecting...', wsStatus, 'connecting');
                
                const timeout = setTimeout(() => {
                    if (currentWs && currentWs.readyState === WebSocket.CONNECTING) {
                        log('‚è±Ô∏è WebSocket connection timeout after 10s', 'warning');
                        currentWs.close();
                    }
                }, 10000);
                
                currentWs.onopen = () => {
                    clearTimeout(timeout);
                    log('üéâ WebSocket opened! (This might be unexpected without auth)', 'warning');
                    updateStatus('Connected', wsStatus, 'connected');
                };
                
                currentWs.onmessage = (event) => {
                    log(`üì® WebSocket message: ${event.data}`, 'success');
                };
                
                currentWs.onclose = (event) => {
                    clearTimeout(timeout);
                    updateStatus('Disconnected', wsStatus, 'disconnected');
                    log(`üîí WebSocket closed - Code: ${event.code}, Reason: "${event.reason}"`, 
                        event.code === 1000 ? 'info' : event.code >= 4000 ? 'warning' : 'error');
                };
                
                currentWs.onerror = (error) => {
                    clearTimeout(timeout);
                    updateStatus('Error', wsStatus, 'disconnected');
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                };
                
            } catch (error) {
                updateStatus('Failed', wsStatus, 'disconnected');
                log(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
            }
        }

        // Test 3: With Real Auth Token
        async function testWithRealAuth() {
            log('üîê Getting real auth token and testing WebSocket...', 'info');
            
            try {
                // Get auth token using demo account
                const authResponse = await fetch('https://pitchey-backend-fresh.deno.dev/api/auth/creator/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'alex.creator@demo.com',
                        password: 'Demo123'
                    })
                });
                
                if (!authResponse.ok) {
                    const errorText = await authResponse.text();
                    log(`‚ùå Authentication failed: ${authResponse.status} ${errorText}`, 'error');
                    updateStatus('‚ùå Failed', authStatus, 'disconnected');
                    return;
                }
                
                const authData = await authResponse.json();
                const token = authData.token;
                
                log(`‚úÖ Got auth token: ${token.substring(0, 20)}...`, 'success');
                updateStatus('‚úÖ Authenticated', authStatus, 'connected');
                
                // Now test WebSocket with auth
                if (currentWs) {
                    currentWs.close();
                    currentWs = null;
                }
                
                const wsUrl = `wss://pitchey-backend-fresh.deno.dev/ws?token=${token}`;
                log(`üîå Testing authenticated WebSocket connection...`, 'info');
                
                currentWs = new WebSocket(wsUrl);
                updateStatus('Connecting...', wsStatus, 'connecting');
                
                const timeout = setTimeout(() => {
                    if (currentWs && currentWs.readyState === WebSocket.CONNECTING) {
                        log('‚è±Ô∏è Authenticated WebSocket timeout after 10s', 'error');
                        currentWs.close();
                    }
                }, 10000);
                
                currentWs.onopen = () => {
                    clearTimeout(timeout);
                    log('üéâ Authenticated WebSocket connected successfully!', 'success');
                    updateStatus('‚úÖ Connected', wsStatus, 'connected');
                    
                    // Send test message
                    currentWs.send(JSON.stringify({
                        type: 'ping',
                        timestamp: new Date().toISOString()
                    }));
                    log('üì§ Sent ping message', 'info');
                };
                
                currentWs.onmessage = (event) => {
                    log(`üì® Auth WebSocket message: ${event.data}`, 'success');
                };
                
                currentWs.onclose = (event) => {
                    clearTimeout(timeout);
                    updateStatus('Disconnected', wsStatus, 'disconnected');
                    log(`üîí Auth WebSocket closed - Code: ${event.code}, Reason: "${event.reason}"`, 
                        event.code === 1000 ? 'success' : 'error');
                };
                
                currentWs.onerror = (error) => {
                    clearTimeout(timeout);
                    updateStatus('Error', wsStatus, 'disconnected');
                    log(`‚ùå Auth WebSocket error: ${error}`, 'error');
                };
                
            } catch (error) {
                log(`‚ùå Authentication test failed: ${error.message}`, 'error');
                updateStatus('‚ùå Failed', authStatus, 'disconnected');
            }
        }

        // Test 4: Simulate User Login Flow (like real frontend)
        async function simulateUserLogin() {
            log('üé≠ Simulating complete user login flow...', 'info');
            
            // Step 1: Clear any existing auth
            log('Step 1: Clearing existing authentication', 'info');
            updateStatus('Clearing...', authStatus, 'connecting');
            
            // Step 2: Simulate login
            log('Step 2: Attempting user login', 'info');
            const token = await testWithRealAuth();
            
            // Step 3: Wait a moment (like frontend loading)
            log('Step 3: Waiting for app initialization...', 'info');
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Step 4: Multiple connection attempts (simulate the bug)
            log('Step 4: Testing multiple connection scenario...', 'warning');
            
            const connections = [];
            for (let i = 1; i <= 3; i++) {
                log(`üîå Creating connection ${i}/3 (testing old bug)...`, 'info');
                
                try {
                    const ws = new WebSocket('wss://pitchey-backend-fresh.deno.dev/ws?token=fake_token');
                    connections.push(ws);
                    
                    ws.onopen = () => log(`‚ö†Ô∏è Connection ${i} opened unexpectedly!`, 'warning');
                    ws.onclose = (event) => log(`üîí Connection ${i} closed: ${event.code}`, 'info');
                    ws.onerror = () => log(`‚ùå Connection ${i} error`, 'error');
                    
                } catch (error) {
                    log(`‚ùå Connection ${i} failed to create: ${error.message}`, 'error');
                }
                
                // Small delay between connections
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Clean up after 5 seconds
            setTimeout(() => {
                connections.forEach(ws => {
                    if (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                    }
                });
                log('üßπ Cleaned up test connections', 'info');
            }, 5000);
            
            log('‚úÖ User login simulation complete!', 'success');
            log(`üìä Total errors captured: ${errorCount}`, errorCount > 0 ? 'error' : 'success');
        }

        // Auto-start basic connectivity test
        setTimeout(() => {
            log('üöÄ Auto-starting production connectivity test...', 'info');
            testProductionAPI();
        }, 1000);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentWs) {
                currentWs.close();
            }
        });
    </script>
</body>
</html>