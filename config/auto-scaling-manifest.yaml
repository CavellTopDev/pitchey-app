# Pitchey Auto-Scaling Configuration Manifest
# Comprehensive auto-scaling setup for all services

apiVersion: v1
kind: Namespace
metadata:
  name: pitchey-production
  labels:
    name: pitchey-production
    env: production

---
# Horizontal Pod Autoscaler for main API service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: pitchey-api-hpa
  namespace: pitchey-production
  labels:
    app: pitchey-api
    component: autoscaler
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: pitchey-api
  minReplicas: 3
  maxReplicas: 50
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "100"
  - type: External
    external:
      metric:
        name: queue_depth
        selector:
          matchLabels:
            service: pitchey-api
      target:
        type: Value
        value: "10"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300  # 5 minutes
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
      - type: Pods
        value: 4
        periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 900  # 15 minutes
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Min

---
# Vertical Pod Autoscaler for resource optimization
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: pitchey-api-vpa
  namespace: pitchey-production
  labels:
    app: pitchey-api
    component: vpa
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: pitchey-api
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: pitchey-api
      minAllowed:
        cpu: 100m
        memory: 128Mi
      maxAllowed:
        cpu: 2000m
        memory: 4Gi
      controlledResources: ["cpu", "memory"]

---
# Pod Disruption Budget for availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: pitchey-api-pdb
  namespace: pitchey-production
spec:
  selector:
    matchLabels:
      app: pitchey-api
  minAvailable: 2  # Always keep at least 2 pods running

---
# Service Monitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: pitchey-api-metrics
  namespace: pitchey-production
  labels:
    app: pitchey-api
    component: monitoring
spec:
  selector:
    matchLabels:
      app: pitchey-api
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    honorLabels: true

---
# Prometheus Rules for auto-scaling alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: pitchey-autoscaling-rules
  namespace: pitchey-production
  labels:
    app: pitchey
    component: monitoring
spec:
  groups:
  - name: autoscaling.rules
    interval: 30s
    rules:
    
    # High resource utilization
    - alert: HighCPUUtilization
      expr: avg(rate(container_cpu_usage_seconds_total{namespace="pitchey-production"}[5m])) by (pod) > 0.8
      for: 5m
      labels:
        severity: warning
        component: autoscaling
      annotations:
        summary: "High CPU utilization detected"
        description: "Pod {{ $labels.pod }} has CPU utilization above 80% for more than 5 minutes"

    - alert: HighMemoryUtilization
      expr: avg(container_memory_usage_bytes{namespace="pitchey-production"} / container_spec_memory_limit_bytes{namespace="pitchey-production"}) by (pod) > 0.85
      for: 5m
      labels:
        severity: warning
        component: autoscaling
      annotations:
        summary: "High memory utilization detected"
        description: "Pod {{ $labels.pod }} has memory utilization above 85% for more than 5 minutes"

    # Scaling behavior alerts
    - alert: FrequentScalingEvents
      expr: increase(kube_hpa_status_last_scale_time[1h]) > 10
      for: 0m
      labels:
        severity: warning
        component: autoscaling
      annotations:
        summary: "Frequent scaling events detected"
        description: "HPA {{ $labels.hpa }} has scaled more than 10 times in the last hour"

    - alert: MaxReplicasReached
      expr: kube_hpa_status_current_replicas >= kube_hpa_spec_max_replicas
      for: 10m
      labels:
        severity: critical
        component: autoscaling
      annotations:
        summary: "Maximum replicas reached"
        description: "HPA {{ $labels.hpa }} has reached maximum replica count"

    - alert: ScalingThresholdBreach
      expr: kube_hpa_status_current_replicas <= kube_hpa_spec_min_replicas
      for: 15m
      labels:
        severity: warning
        component: autoscaling
      annotations:
        summary: "Minimum replicas threshold"
        description: "Service is running at minimum replica count for extended period"

    # Business metrics alerts
    - alert: HighRequestRate
      expr: sum(rate(http_requests_total{namespace="pitchey-production"}[5m])) > 1000
      for: 2m
      labels:
        severity: info
        component: autoscaling
      annotations:
        summary: "High request rate detected"
        description: "Request rate is {{ $value }} req/sec, which may trigger scaling"

    - alert: QueueDepthHigh
      expr: avg(queue_depth{namespace="pitchey-production"}) > 50
      for: 3m
      labels:
        severity: warning
        component: autoscaling
      annotations:
        summary: "High queue depth"
        description: "Queue depth is {{ $value }}, consider scaling up"

---
# Custom Resource Definition for Advanced Scaling
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: advancedscalers.scaling.pitchey.io
spec:
  group: scaling.pitchey.io
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              targetRef:
                type: object
                properties:
                  apiVersion:
                    type: string
                  kind:
                    type: string
                  name:
                    type: string
              businessMetrics:
                type: object
                properties:
                  pitchesPerMinute:
                    type: object
                    properties:
                      threshold:
                        type: number
                      window:
                        type: string
                  activeUsers:
                    type: object
                    properties:
                      threshold:
                        type: number
                      window:
                        type: string
              costLimits:
                type: object
                properties:
                  maxHourlyCost:
                    type: number
                  currency:
                    type: string
              timeBasedScaling:
                type: object
                properties:
                  businessHours:
                    type: object
                    properties:
                      start:
                        type: string
                      end:
                        type: string
                      timezone:
                        type: string
                      minReplicas:
                        type: integer
                      maxReplicas:
                        type: integer
                  offHours:
                    type: object
                    properties:
                      minReplicas:
                        type: integer
                      maxReplicas:
                        type: integer
  scope: Namespaced
  names:
    plural: advancedscalers
    singular: advancedscaler
    kind: AdvancedScaler

---
# Advanced Scaler Instance
apiVersion: scaling.pitchey.io/v1alpha1
kind: AdvancedScaler
metadata:
  name: pitchey-api-advanced-scaler
  namespace: pitchey-production
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: pitchey-api
  businessMetrics:
    pitchesPerMinute:
      threshold: 10
      window: "5m"
    activeUsers:
      threshold: 100
      window: "10m"
  costLimits:
    maxHourlyCost: 100.0
    currency: "USD"
  timeBasedScaling:
    businessHours:
      start: "08:00"
      end: "18:00"
      timezone: "UTC"
      minReplicas: 5
      maxReplicas: 50
    offHours:
      minReplicas: 2
      maxReplicas: 20

---
# ConfigMap for scaling parameters
apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-scaling-config
  namespace: pitchey-production
  labels:
    app: pitchey
    component: autoscaling
data:
  # CPU-based scaling parameters
  cpu.scale_up_threshold: "70"
  cpu.scale_down_threshold: "30"
  cpu.evaluation_period: "300"
  
  # Memory-based scaling parameters
  memory.scale_up_threshold: "80"
  memory.scale_down_threshold: "40"
  memory.evaluation_period: "300"
  
  # Request-based scaling parameters
  requests.scale_up_threshold: "100"
  requests.scale_down_threshold: "20"
  requests.evaluation_period: "180"
  
  # Queue-based scaling parameters
  queue.scale_up_threshold: "10"
  queue.scale_down_threshold: "2"
  queue.evaluation_period: "120"
  
  # Cost control parameters
  cost.max_hourly_spend: "100.00"
  cost.scaling_budget_alert_threshold: "80.00"
  cost.currency: "USD"
  
  # Business hours configuration
  business.hours.start: "08:00"
  business.hours.end: "18:00"
  business.hours.timezone: "UTC"
  business.hours.min_replicas: "5"
  business.hours.max_replicas: "50"
  
  # Off-hours configuration
  off.hours.min_replicas: "2"
  off.hours.max_replicas: "20"
  
  # Cooldown periods
  scale.up.cooldown: "300"
  scale.down.cooldown: "900"
  
  # Stability windows
  scale.up.stability_window: "300"
  scale.down.stability_window: "900"

---
# RBAC for auto-scaling controller
apiVersion: v1
kind: ServiceAccount
metadata:
  name: auto-scaling-controller
  namespace: pitchey-production

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: auto-scaling-controller
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "deployments/scale"]
  verbs: ["get", "list", "watch", "update", "patch"]
- apiGroups: ["autoscaling"]
  resources: ["horizontalpodautoscalers"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["metrics.k8s.io"]
  resources: ["*"]
  verbs: ["get", "list"]
- apiGroups: ["custom.metrics.k8s.io"]
  resources: ["*"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-scaling-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: auto-scaling-controller
subjects:
- kind: ServiceAccount
  name: auto-scaling-controller
  namespace: pitchey-production

---
# Network Policy for metrics collection
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-metrics-collection
  namespace: pitchey-production
spec:
  podSelector:
    matchLabels:
      app: pitchey-api
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 8080  # metrics port
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 8080