# Smoke Tests Configuration for Pitchey Platform
# Defines smoke test scenarios and validation criteria

apiVersion: v1
kind: ConfigMap
metadata:
  name: smoke-tests-config
  namespace: pitchey-production
  labels:
    app: pitchey
    component: validation
data:
  # Test configuration
  smoke-tests.yaml: |
    test_config:
      # General settings
      timeout_seconds: 30
      max_retries: 3
      retry_delay: 5
      parallel_tests: 5
      
      # Environment configuration
      environments:
        production:
          api_base_url: "https://pitchey-api-prod.ndlovucavelle.workers.dev"
          frontend_url: "https://pitchey-5o8-66n.pages.dev"
          websocket_url: "wss://pitchey-api-prod.ndlovucavelle.workers.dev/ws"
        
        staging:
          api_base_url: "https://pitchey-api-staging.ndlovucavelle.workers.dev"
          frontend_url: "https://pitchey-staging.pages.dev"
          websocket_url: "wss://pitchey-api-staging.ndlovucavelle.workers.dev/ws"
      
      # Test credentials
      test_accounts:
        creator:
          email: "alex.creator@demo.com"
          password: "Demo123"
          role: "creator"
        
        investor:
          email: "sarah.investor@demo.com"
          password: "Demo123"
          role: "investor"
        
        production:
          email: "stellar.production@demo.com"
          password: "Demo123"
          role: "production_company"

    # Core smoke test scenarios
    smoke_test_scenarios:
      # Essential health checks
      health_checks:
        - name: "API Health Check"
          type: "http_get"
          url: "/api/health"
          expected_status: 200
          expected_response_contains: ["status", "ok"]
          timeout: 10
          critical: true
        
        - name: "Database Health Check"
          type: "http_get"
          url: "/api/health/database"
          expected_status: 200
          timeout: 15
          critical: true
        
        - name: "Cache Health Check"
          type: "http_get"
          url: "/api/health/cache"
          expected_status: 200
          timeout: 10
          critical: true
        
        - name: "Frontend Accessibility"
          type: "http_get"
          url: "/"
          base_url: "frontend_url"
          expected_status: 200
          timeout: 15
          critical: true

      # Authentication workflows
      authentication_tests:
        - name: "Creator Login"
          type: "http_post"
          url: "/api/auth/sign-in"
          data:
            email: "{{test_accounts.creator.email}}"
            password: "{{test_accounts.creator.password}}"
          expected_status: 200
          expected_response_contains: ["success", "session"]
          timeout: 10
          critical: true
        
        - name: "Invalid Login Rejection"
          type: "http_post"
          url: "/api/auth/sign-in"
          data:
            email: "invalid@test.com"
            password: "wrongpassword"
          expected_status: 401
          timeout: 10
          critical: true
        
        - name: "Session Validation"
          type: "http_get"
          url: "/api/auth/session"
          expected_status: 401  # Should fail without session
          timeout: 5
          critical: false

      # Core API functionality
      api_functionality_tests:
        - name: "Public Pitches Retrieval"
          type: "http_get"
          url: "/api/pitches?public=true"
          expected_status: 200
          expected_response_contains: ["data"]
          timeout: 15
          critical: true
        
        - name: "Protected Endpoint Security"
          type: "http_get"
          url: "/api/users/profile"
          expected_status: 401
          timeout: 10
          critical: true
        
        - name: "API Rate Limiting"
          type: "http_get_rapid"
          url: "/api/health"
          requests: 20
          expected_status: [200, 429]  # Either success or rate limited
          timeout: 5
          critical: false

      # Database operations
      database_tests:
        - name: "Data Retrieval Performance"
          type: "http_get"
          url: "/api/pitches"
          expected_status: 200
          max_response_time: 2000  # milliseconds
          timeout: 20
          critical: true
        
        - name: "Database Connection Pool"
          type: "concurrent_http_get"
          url: "/api/health/database"
          concurrent_requests: 10
          expected_success_rate: 100
          timeout: 15
          critical: true

      # Security validations
      security_tests:
        - name: "HTTPS Enforcement"
          type: "http_get"
          url: "/api/health"
          protocol: "http"  # Test HTTP redirect to HTTPS
          expected_status: [301, 302, 404]
          timeout: 10
          critical: true
        
        - name: "Security Headers"
          type: "http_get"
          url: "/api/health"
          validate_headers:
            - "Strict-Transport-Security"
            - "X-Content-Type-Options"
          timeout: 10
          critical: false
        
        - name: "CORS Configuration"
          type: "http_options"
          url: "/api/auth/sign-in"
          headers:
            Origin: "https://example.com"
            Access-Control-Request-Method: "POST"
          validate_headers:
            - "Access-Control-Allow-Origin"
          timeout: 10
          critical: false

      # Performance benchmarks
      performance_tests:
        - name: "API Response Time"
          type: "http_get_timed"
          url: "/api/health"
          samples: 10
          max_avg_response_time: 1000  # milliseconds
          timeout: 30
          critical: false
        
        - name: "Concurrent Request Handling"
          type: "concurrent_http_get"
          url: "/api/health"
          concurrent_requests: 20
          expected_success_rate: 95
          timeout: 30
          critical: false

    # Test execution configuration
    execution_config:
      # Test ordering and dependencies
      test_order:
        1: "health_checks"
        2: "security_tests"
        3: "authentication_tests"
        4: "api_functionality_tests"
        5: "database_tests"
        6: "performance_tests"
      
      # Failure handling
      failure_handling:
        stop_on_critical_failure: true
        max_non_critical_failures: 3
        retry_failed_tests: true
        generate_detailed_report: true
      
      # Reporting configuration
      reporting:
        formats: ["json", "markdown", "junit"]
        include_response_data: false
        include_performance_metrics: true
        send_notifications: true
        
        # Notification channels
        notifications:
          slack:
            webhook_url: "${SLACK_WEBHOOK_URL}"
            channel: "#deployments"
            mention_on_failure: ["@oncall"]
          
          email:
            smtp_server: "${SMTP_SERVER}"
            recipients: ["devops@pitchey.com"]
            send_on_failure: true
            send_on_success: false

  # Kubernetes Job template for running smoke tests
  smoke-test-job-template.yaml: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: smoke-tests-{{timestamp}}
      namespace: pitchey-production
      labels:
        app: pitchey
        component: smoke-tests
        deployment-version: "{{deployment_version}}"
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: smoke-tests
            image: pitchey/validation-suite:latest
            env:
            - name: API_BASE_URL
              value: "{{api_base_url}}"
            - name: FRONTEND_URL
              value: "{{frontend_url}}"
            - name: TEST_ENVIRONMENT
              value: "{{environment}}"
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: notification-secrets
                  key: slack-webhook-url
            volumeMounts:
            - name: config
              mountPath: /etc/test-config
              readOnly: true
            - name: test-results
              mountPath: /test-results
            command:
            - "/bin/bash"
            - "-c"
            - |
              echo "Starting smoke tests for deployment {{deployment_version}}"
              
              # Run smoke tests
              /scripts/validation-suite.sh smoke
              exit_code=$?
              
              # Copy results to shared volume
              cp -r /tmp/test-results/* /test-results/ 2>/dev/null || true
              
              # Send notification
              if [[ $exit_code -eq 0 ]]; then
                echo "✅ Smoke tests passed for {{deployment_version}}"
              else
                echo "❌ Smoke tests failed for {{deployment_version}}"
              fi
              
              exit $exit_code
          volumes:
          - name: config
            configMap:
              name: smoke-tests-config
          - name: test-results
            emptyDir: {}
      backoffLimit: 2
      activeDeadlineSeconds: 1800  # 30 minutes

---
# CronJob for scheduled smoke tests
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scheduled-smoke-tests
  namespace: pitchey-production
  labels:
    app: pitchey
    component: monitoring
spec:
  schedule: "*/30 * * * *"  # Every 30 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: smoke-tests
            image: pitchey/validation-suite:latest
            env:
            - name: API_BASE_URL
              value: "https://pitchey-api-prod.ndlovucavelle.workers.dev"
            - name: FRONTEND_URL
              value: "https://pitchey-5o8-66n.pages.dev"
            - name: TEST_ENVIRONMENT
              value: "production"
            - name: SCHEDULED_TEST
              value: "true"
            volumeMounts:
            - name: config
              mountPath: /etc/test-config
              readOnly: true
            command:
            - "/scripts/validation-suite.sh"
            - "smoke"
          volumes:
          - name: config
            configMap:
              name: smoke-tests-config

---
# Service Monitor for test metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: smoke-test-metrics
  namespace: pitchey-production
  labels:
    app: pitchey
    component: monitoring
spec:
  selector:
    matchLabels:
      app: smoke-test-exporter
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics

---
# Alert rules for smoke test failures
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: smoke-test-alerts
  namespace: pitchey-production
  labels:
    app: pitchey
    component: monitoring
spec:
  groups:
  - name: smoke-tests.rules
    interval: 60s
    rules:
    
    - alert: SmokeTestFailure
      expr: smoke_test_success_rate < 1
      for: 5m
      labels:
        severity: critical
        component: smoke-tests
      annotations:
        summary: "Smoke tests are failing"
        description: "Smoke test success rate is {{ $value }}% for the last 5 minutes"
    
    - alert: SmokeTestResponseTime
      expr: smoke_test_avg_response_time > 2000
      for: 10m
      labels:
        severity: warning
        component: smoke-tests
      annotations:
        summary: "Smoke test response times are high"
        description: "Average response time is {{ $value }}ms"
    
    - alert: SmokeTestMissing
      expr: absent(smoke_test_last_run) or (time() - smoke_test_last_run) > 3600
      for: 0m
      labels:
        severity: warning
        component: smoke-tests
      annotations:
        summary: "Smoke tests haven't run recently"
        description: "Last smoke test run was more than 1 hour ago"

---
# Dashboard ConfigMap for Grafana
apiVersion: v1
kind: ConfigMap
metadata:
  name: smoke-test-dashboard
  namespace: pitchey-production
  labels:
    app: pitchey
    component: monitoring
data:
  dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Pitchey Smoke Tests Dashboard",
        "tags": ["smoke-tests", "validation", "pitchey"],
        "timezone": "UTC",
        "panels": [
          {
            "id": 1,
            "title": "Test Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "smoke_test_success_rate * 100",
                "legendFormat": "Success Rate %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 95},
                    {"color": "green", "value": 100}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Test Response Times",
            "type": "graph",
            "targets": [
              {
                "expr": "smoke_test_response_time_seconds * 1000",
                "legendFormat": "{{ test_name }}"
              }
            ],
            "yAxes": [
              {"unit": "ms", "min": 0}
            ],
            "gridPos": {"h": 8, "w": 18, "x": 6, "y": 0}
          },
          {
            "id": 3,
            "title": "Test Results History",
            "type": "graph",
            "targets": [
              {
                "expr": "smoke_test_results",
                "legendFormat": "{{ test_name }} - {{ status }}"
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Failed Tests",
            "type": "table",
            "targets": [
              {
                "expr": "smoke_test_results{status=\"failed\"}",
                "format": "table"
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          }
        ],
        "refresh": "30s",
        "time": {"from": "now-1h", "to": "now"}
      }
    }